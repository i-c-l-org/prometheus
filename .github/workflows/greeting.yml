name: Greeting

on:
  pull_request:
    types: [opened, closed]
  issues:
    types: [opened]
  pull_request_target:

permissions:
  issues: write
  pull-requests: write

jobs:
  greet:
    runs-on: ubuntu-latest
    steps:
      - name: Greet new contributors
        uses: actions/github-script@v7
        with:
          script: |
            const { issue, pull_request, sender } = context.payload;

            // Welcome message for new PRs
            if (pull_request) {
              const PR_NUMBER = pull_request.number;
              const AUTHOR = sender.login;

              // Check if it's a new contributor (first PR)
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                per_page: 100
              });

              const authorPrs = prs.filter(pr => pr.user.login === AUTHOR);
              const isFirstPR = authorPrs.length === 1;

              const welcomeMessage = isFirstPR
                ? `## Welcome to Prometheus, @${AUTHOR}! \n\nThank you for your first pull request! We're excited to have your contribution. Please make sure you've read our [Contributing Guide](./CONTRIBUTING.md) and feel free to ask any questions.`
                : `## Welcome back, @${AUTHOR}!\n\nThank you for another contribution to Prometheus!`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: PR_NUMBER,
                body: `${welcomeMessage}\n\n---\n\n**Quick tips:**\n- [OK] Tests are running: ${pull_request.head.ref}\n- [INFO] Check the PR template for required information\n- [TIP] Make sure your code follows our linting rules`
              });
            }

            // Welcome message for new issues
            if (issue && !pull_request) {
              const ISSUE_NUMBER = issue.number;
              const AUTHOR = sender.login;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ISSUE_NUMBER,
                body: `## Thanks for opening this issue, @${AUTHOR}!\n\nWe'll look into this and get back to you as soon as possible.\n\n---\n\n**Helpful tips:**\n- [INFO] Include all requested information in your issue\n- [SEARCH] Search existing issues before creating duplicates\n- [DOCS] Check our [Documentation](./README.md) for more details`
              });
            }
