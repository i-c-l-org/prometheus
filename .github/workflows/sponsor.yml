name: Sponsors

on:
  sponsorship:
    types: [created, TierChanged, cancelled]

permissions:
  contents: read

jobs:
  sponsor:
    name: Thank Sponsor
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Thank You Message
        env:
          SPONSOR_LOGIN: ${{ github.event.sponsorship.sponsor.login }}
          SPONSOR_TIER: ${{ github.event.sponsorship.tier.name }}
          SPONSOR_EMAIL: ${{ github.event.sponsorship.sponsor.email }}
        run: |
          echo "üéâ Thank you to our new sponsor: $SPONSOR_LOGIN"
          echo "Tier: $SPONSOR_TIER"
          echo "Email: $SPONSOR_EMAIL"

          # Log to console for visibility
          echo "sponsor_login=$SPONSOR_LOGIN" >> $GITHUB_OUTPUT
          echo "sponsor_tier=$SPONSOR_TIER" >> $GITHUB_OUTPUT

      - name: Create GitHub Sponsor Badge
        uses: actions/github-script@v7
        if: github.event.sponsorship.tier.monthly_price_in_cents >= 500
        with:
          script: |
            const sponsor = context.payload.sponsorship.sponsor;
            const tier = context.payload.sponsorship.tier;

            // Add sponsor label to the sponsor's GitHub account
            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üèÜ New Sponsor: ${sponsor.login}`,
                body: `## üéâ New Sponsor!\n\n**Thank you ${sponsor.login} for your support!**\n\n- **Tier**: ${tier.name} ($${tier.monthly_price_in_cents / 100}/month)\n- **Message**: ${context.payload.sponsorship.message || 'No message'}\n\nYour support helps us continue developing Prometheus!`,
                labels: ['sponsor']
              });
              console.log('Sponsor issue created successfully');
            } catch (e) {
              console.log('Could not create sponsor issue:', e.message);
            }
