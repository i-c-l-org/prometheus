{"version":3,"file":"fix-unknown-to-specific-type.js","sourceRoot":"","sources":["../../../../src/analistas/corrections/quick-fixes/fix-unknown-to-specific-type.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n/**\n * Quick Fix: Replace unknown with specific types\n * Mais conservador que fix-any - requer confiança >= 90%\n */\n\nimport type { Node } from '@babel/types';\nimport { buildTypesRelPathPosix, getTypesDirectoryDisplay } from '@core/config/conventions.js';\nimport { MENSAGENS_CORRECAO_TIPOS } from '@core/messages/index.js';\n\nimport type { QuickFix, QuickFixResult, TypeSafetyWarning } from '@';\n\nimport { isInStringOrComment, isLegacyOrVendorFile, isUnknownInGenericContext } from '../type-safety/context-analyzer.js';\nimport { analyzeUnknownUsage } from '../type-safety/type-analyzer.js';\nimport { createTypeDefinition } from '../type-safety/type-creator.js';\nimport { validateTypeReplacement } from '../type-safety/type-validator.js';\n\nexport const fixUnknownToSpecificTipo: QuickFix = {\n  id: 'fix-unknown-to-specific-type',\n  title: MENSAGENS_CORRECAO_TIPOS.fixUnknown.title,\n  description: MENSAGENS_CORRECAO_TIPOS.fixUnknown.description,\n  pattern: /:\\s*unknown\\b/g,\n  category: 'style',\n  confidence: 75,\n  // Mais conservador que any\n\n  shouldApply: (match: RegExpMatchArray, fullCode: string, lineContext: string, fileCaminho?: string) => {\n    // 1. Verificar contexto básico\n    if (isInStringOrComment(fullCode, match.index || 0)) {\n      return false;\n    }\n\n    // 2. Não modificar arquivos de definição\n    if (fileCaminho?.includes('.d.ts') || fileCaminho?.includes('/@types/')) {\n      return false;\n    }\n\n    // 3. Não modificar legado/vendor\n    if (isLegacyOrVendorFile(fileCaminho)) {\n      return false;\n    }\n\n    // 4. Verificar se unknown está em contexto genérico apropriado\n    if (isUnknownInGenericContext(fullCode, match.index || 0)) {\n      return false; // unknown é apropriado aqui (entrada genérica, deserialização, etc)\n    }\n    return true;\n  },\n  fix: (match: RegExpMatchArray, fullCode: string) => {\n    // Retornar código sem modificação por padrão\n    return fullCode;\n  }\n};\n\n/**\n * Versão assíncrona com análise completa (conservador)\n */\nexport async function fixUnknownToSpecificTypeAsync(match: RegExpMatchArray, fullCode: string, fileCaminho: string, ast: Node | null): Promise<QuickFixResult> {\n  try {\n    // 1. Analisar uso (mais conservador que any)\n    const typeAnalise = await analyzeUnknownUsage(match, fullCode, fileCaminho, ast);\n\n    // 2. Estratégia mais conservadora (requer >= 90% confiança)\n    if (typeAnalise.confidence >= 90) {\n      // ALTA CONFIANÇA: Criar interface dedicada\n\n      const typeCaminho = await createTypeDefinition(typeAnalise, fileCaminho);\n      const importStatement = `import type { ${typeAnalise.typeName} } from '${typeCaminho}';\\n`;\n\n      // Adicionar import e substituir unknown\n      const lines = fullCode.split('\\n');\n      const importIndex = findImportInsertionPoint(lines);\n      lines.splice(importIndex, 0, importStatement);\n      let fixedCodigo = lines.join('\\n');\n      fixedCodigo = fixedCodigo.replace(match[0], `: ${typeAnalise.typeName}`);\n\n      // Validar\n      const validation = await validateTypeReplacement(fullCode, fixedCodigo, typeAnalise);\n      if (!validation.isCompatible) {\n        return {\n          code: fullCode,\n          applied: false,\n          reason: `Validação falhou: ${validation.errors.join(', ')}`\n        };\n      }\n      return {\n        code: fixedCodigo,\n        applied: true,\n        additionalChanges: [{\n          type: 'add-import',\n          content: importStatement\n        }, {\n          type: 'create-type-file',\n          content: typeAnalise.typeDefinition,\n          path: buildTypesRelPathPosix(typeAnalise.suggestedPath)\n        }]\n      };\n    } else if (typeAnalise.confidence >= 70) {\n      // MÉDIA CONFIANÇA: Sugerir tipo\n      const warning: TypeSafetyWarning = {\n        type: 'type-suggestion',\n        message: `unknown pode ser substituído por tipo específico: ${typeAnalise.inferredTipo}`,\n        suggestion: `Crie interface em ${buildTypesRelPathPosix(typeAnalise.suggestedPath)}`,\n        confidence: typeAnalise.confidence\n      };\n      return {\n        code: fullCode,\n        applied: false,\n        reason: `Confiança média (${typeAnalise.confidence}%) - sugestão apenas`,\n        warnings: [warning]\n      };\n    } else {\n      // BAIXA CONFIANÇA: Manter unknown\n      const warning: TypeSafetyWarning = {\n        type: 'keep-unknown',\n        message: 'unknown apropriado aqui (entrada genérica ou baixa confiança)',\n        suggestion: `Se possível, adicione type guards ou crie tipo dedicado em ${getTypesDirectoryDisplay()}`\n      };\n      return {\n        code: fullCode,\n        applied: false,\n        reason: `Confiança baixa (${typeAnalise.confidence}%) - manter unknown`,\n        warnings: [warning]\n      };\n    }\n  } catch (error) {\n    return {\n      code: fullCode,\n      applied: false,\n      reason: `Erro na análise: ${error instanceof Error ? error.message : String(error)}`\n    };\n  }\n}\n\n/**\n * Encontra ponto de inserção para import\n */\nfunction findImportInsertionPoint(lines: string[]): number {\n  let lastImportIndex = -1;\n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i].trim();\n    if (line.startsWith('//') || line.startsWith('/*') || line.startsWith('*')) {\n      continue;\n    }\n    if (line.startsWith('import ')) {\n      lastImportIndex = i;\n    }\n    if (line && !line.startsWith('import ') && lastImportIndex !== -1) {\n      break;\n    }\n  }\n  return lastImportIndex + 1;\n}"]}