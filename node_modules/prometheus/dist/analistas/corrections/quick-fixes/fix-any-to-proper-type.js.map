{"version":3,"file":"fix-any-to-proper-type.js","sourceRoot":"","sources":["../../../../src/analistas/corrections/quick-fixes/fix-any-to-proper-type.ts"],"names":[],"mappings":"AAOA,OAAO,EAAE,sBAAsB,EAAE,MAAM,6BAA6B,CAAC;AACrE,OAAO,EAAE,wBAAwB,EAAE,MAAM,yBAAyB,CAAC;AAInE,OAAO,EAAE,sBAAsB,EAAE,mBAAmB,EAAE,oBAAoB,EAAE,mBAAmB,EAAE,MAAM,oCAAoC,CAAC;AAC5I,OAAO,EAAE,gBAAgB,EAAE,MAAM,iCAAiC,CAAC;AACnE,OAAO,EAAE,oBAAoB,EAAE,MAAM,gCAAgC,CAAC;AACtE,OAAO,EAAE,uBAAuB,EAAE,MAAM,kCAAkC,CAAC;AAE3E,MAAM,gBAAgB,GAAG;IACvB,IAAI,EAAE,EAAE;IACR,MAAM,EAAE,EAAE;IACV,OAAO,EAAE,EAAE;CACH,CAAC;AACX,MAAM,CAAC,MAAM,kBAAkB,GAAa;IAC1C,EAAE,EAAE,wBAAwB;IAC5B,KAAK,EAAE,wBAAwB,CAAC,MAAM,CAAC,KAAK;IAC5C,WAAW,EAAE,wBAAwB,CAAC,MAAM,CAAC,WAAW;IACxD,OAAO,EAAE,YAAY;IACrB,QAAQ,EAAE,OAAO;IAEjB,UAAU,EAAE,gBAAgB,CAAC,OAAO;IAGpC,WAAW,EAAE,CAAC,KAAuB,EAAE,QAAgB,EAAE,WAAmB,EAAE,WAAoB,EAAE,EAAE;QAEpG,IAAI,mBAAmB,CAAC,QAAQ,EAAE,KAAK,CAAC,KAAK,IAAI,CAAC,CAAC,EAAE,CAAC;YACpD,OAAO,KAAK,CAAC;QACf,CAAC;QAGD,IAAI,mBAAmB,CAAC,QAAQ,EAAE,KAAK,CAAC,KAAK,IAAI,CAAC,CAAC,EAAE,CAAC;YACpD,OAAO,KAAK,CAAC;QACf,CAAC;QAGD,IAAI,WAAW,EAAE,QAAQ,CAAC,OAAO,CAAC,IAAI,WAAW,EAAE,QAAQ,CAAC,UAAU,CAAC,EAAE,CAAC;YACxE,OAAO,KAAK,CAAC;QACf,CAAC;QAGD,IAAI,oBAAoB,CAAC,WAAW,CAAC,EAAE,CAAC;YACtC,OAAO,KAAK,CAAC;QACf,CAAC;QAGD,IAAI,sBAAsB,CAAC,QAAQ,EAAE,KAAK,CAAC,KAAK,IAAI,CAAC,CAAC,EAAE,CAAC;YACvD,OAAO,KAAK,CAAC;QACf,CAAC;QACD,OAAO,IAAI,CAAC;IACd,CAAC;IACD,GAAG,EAAE,CAAC,KAAuB,EAAE,QAAgB,EAAE,EAAE;QAGjD,OAAO,QAAQ,CAAC;IAClB,CAAC;CACF,CAAC;AAKF,MAAM,CAAC,KAAK,UAAU,uBAAuB,CAAC,KAAuB,EAAE,QAAgB,EAAE,WAAmB,EAAE,GAAgB;IAC5H,IAAI,CAAC;QAEH,MAAM,WAAW,GAAG,MAAM,gBAAgB,CAAC,KAAK,EAAE,QAAQ,EAAE,WAAW,EAAE,GAAG,CAAC,CAAC;QAG9E,IAAI,WAAW,CAAC,UAAU,IAAI,gBAAgB,CAAC,IAAI,EAAE,CAAC;YAGpD,IAAI,WAAW,CAAC,YAAY,EAAE,CAAC;gBAE7B,MAAM,WAAW,GAAG,QAAQ,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,KAAK,WAAW,CAAC,YAAY,EAAE,CAAC,CAAC;gBAGhF,MAAM,UAAU,GAAG,MAAM,uBAAuB,CAAC,QAAQ,EAAE,WAAW,EAAE,WAAW,CAAC,CAAC;gBACrF,IAAI,CAAC,UAAU,CAAC,YAAY,EAAE,CAAC;oBAC7B,OAAO;wBACL,IAAI,EAAE,QAAQ;wBACd,OAAO,EAAE,KAAK;wBACd,MAAM,EAAE,qBAAqB,UAAU,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE;wBAC3D,QAAQ,EAAE,UAAU,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;4BACtC,IAAI,EAAE,aAAa;4BACnB,OAAO,EAAE,CAAC;4BACV,UAAU,EAAE,oBAAoB;yBACjC,CAAC,CAAC;qBACJ,CAAC;gBACJ,CAAC;gBACD,OAAO;oBACL,IAAI,EAAE,WAAW;oBACjB,OAAO,EAAE,IAAI;oBACb,QAAQ,EAAE,UAAU,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;wBACtC,IAAI,EAAE,iBAAiB;wBACvB,OAAO,EAAE,CAAC;wBACV,UAAU,EAAE,wBAAwB,CAAC,SAAS,CAAC,OAAO;qBACvD,CAAC,CAAC;iBACJ,CAAC;YACJ,CAAC;iBAAM,CAAC;gBAEN,MAAM,WAAW,GAAG,MAAM,oBAAoB,CAAC,WAAW,EAAE,WAAW,CAAC,CAAC;gBACzE,MAAM,eAAe,GAAG,iBAAiB,WAAW,CAAC,QAAQ,YAAY,WAAW,MAAM,CAAC;gBAG3F,MAAM,KAAK,GAAG,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;gBACnC,MAAM,WAAW,GAAG,wBAAwB,CAAC,KAAK,CAAC,CAAC;gBACpD,KAAK,CAAC,MAAM,CAAC,WAAW,EAAE,CAAC,EAAE,eAAe,CAAC,CAAC;gBAC9C,IAAI,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;gBACnC,WAAW,GAAG,WAAW,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,KAAK,WAAW,CAAC,QAAQ,EAAE,CAAC,CAAC;gBAGzE,MAAM,UAAU,GAAG,MAAM,uBAAuB,CAAC,QAAQ,EAAE,WAAW,EAAE,WAAW,CAAC,CAAC;gBACrF,IAAI,CAAC,UAAU,CAAC,YAAY,EAAE,CAAC;oBAC7B,OAAO;wBACL,IAAI,EAAE,QAAQ;wBACd,OAAO,EAAE,KAAK;wBACd,MAAM,EAAE,qBAAqB,UAAU,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE;qBAC5D,CAAC;gBACJ,CAAC;gBACD,OAAO;oBACL,IAAI,EAAE,WAAW;oBACjB,OAAO,EAAE,IAAI;oBACb,iBAAiB,EAAE,CAAC;4BAClB,IAAI,EAAE,YAAY;4BAClB,OAAO,EAAE,eAAe;yBACzB,EAAE;4BACD,IAAI,EAAE,kBAAkB;4BACxB,OAAO,EAAE,WAAW,CAAC,cAAc;4BACnC,IAAI,EAAE,sBAAsB,CAAC,WAAW,CAAC,aAAa,CAAC;yBACxD,CAAC;iBACH,CAAC;YACJ,CAAC;QACH,CAAC;aAAM,IAAI,WAAW,CAAC,UAAU,IAAI,gBAAgB,CAAC,MAAM,EAAE,CAAC;YAE7D,MAAM,OAAO,GAAsB;gBACjC,IAAI,EAAE,iBAAiB;gBACvB,OAAO,EAAE,wBAAwB,CAAC,QAAQ,CAAC,cAAc,CAAC,WAAW,CAAC,UAAU,EAAE,WAAW,CAAC,YAAY,CAAC;gBAC3G,UAAU,EAAE,wBAAwB,CAAC,QAAQ,CAAC,iBAAiB,CAAC,WAAW,CAAC,aAAa,CAAC;gBAC1F,UAAU,EAAE,WAAW,CAAC,UAAU;aACnC,CAAC;YACF,OAAO;gBACL,IAAI,EAAE,QAAQ;gBACd,OAAO,EAAE,KAAK;gBACd,MAAM,EAAE,oBAAoB,WAAW,CAAC,UAAU,sBAAsB;gBACxE,QAAQ,EAAE,CAAC,OAAO,CAAC;aACpB,CAAC;QACJ,CAAC;aAAM,CAAC;YAEN,MAAM,OAAO,GAAsB;gBACjC,IAAI,EAAE,aAAa;gBACnB,OAAO,EAAE,wBAAwB,CAAC,QAAQ,CAAC,cAAc,CAAC,WAAW,CAAC,UAAU,CAAC;gBACjF,UAAU,EAAE,wBAAwB,CAAC,QAAQ,CAAC,qBAAqB,EAAE;gBACrE,iBAAiB,EAAE,IAAI;aACxB,CAAC;YACF,OAAO;gBACL,IAAI,EAAE,QAAQ;gBACd,OAAO,EAAE,KAAK;gBACd,MAAM,EAAE,oBAAoB,WAAW,CAAC,UAAU,IAAI;gBACtD,QAAQ,EAAE,CAAC,OAAO,CAAC;aACpB,CAAC;QACJ,CAAC;IACH,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,OAAO;YACL,IAAI,EAAE,QAAQ;YACd,OAAO,EAAE,KAAK;YACd,MAAM,EAAE,wBAAwB,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;SACvG,CAAC;IACJ,CAAC;AACH,CAAC;AAKD,SAAS,wBAAwB,CAAC,KAAe;IAC/C,IAAI,eAAe,GAAG,CAAC,CAAC,CAAC;IACzB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;QACtC,MAAM,IAAI,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC;QAG7B,IAAI,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,CAAC;YAC3E,SAAS;QACX,CAAC;QAGD,IAAI,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,EAAE,CAAC;YAC/B,eAAe,GAAG,CAAC,CAAC;QACtB,CAAC;QAGD,IAAI,IAAI,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,IAAI,eAAe,KAAK,CAAC,CAAC,EAAE,CAAC;YAClE,MAAM;QACR,CAAC;IACH,CAAC;IAGD,OAAO,eAAe,GAAG,CAAC,CAAC;AAC7B,CAAC","sourcesContent":["// SPDX-License-Identifier: MIT\n/**\n * Quick Fix: Replace any with proper types\n * Analisa uso de `any` e infere/cria tipos corretos\n */\n\nimport type { Node } from '@babel/types';\nimport { buildTypesRelPathPosix } from '@core/config/conventions.js';\nimport { MENSAGENS_CORRECAO_TIPOS } from '@core/messages/index.js';\n\nimport type { QuickFix, QuickFixResult, TypeSafetyWarning } from '@';\n\nimport { isAnyInGenericFunction, isInStringOrComment, isLegacyOrVendorFile, isTypeScriptContext } from '../type-safety/context-analyzer.js';\nimport { analyzeTypeUsage } from '../type-safety/type-analyzer.js';\nimport { createTypeDefinition } from '../type-safety/type-creator.js';\nimport { validateTypeReplacement } from '../type-safety/type-validator.js';\n\nconst CONFIANCA_NIVEIS = {\n  HIGH: 85,\n  MEDIUM: 60,\n  DEFAULT: 70\n} as const;\nexport const fixAnyToProperTipo: QuickFix = {\n  id: 'fix-any-to-proper-type',\n  title: MENSAGENS_CORRECAO_TIPOS.fixAny.title,\n  description: MENSAGENS_CORRECAO_TIPOS.fixAny.description,\n  pattern: /:\\s*any\\b/g,\n  category: 'style',\n  // Type safety é considerado 'style' pois não afeta execução\n  confidence: CONFIANCA_NIVEIS.DEFAULT,\n  // Média - requer análise contextual\n\n  shouldApply: (match: RegExpMatchArray, fullCode: string, lineContext: string, fileCaminho?: string) => {\n    // 1. Verificar contexto básico\n    if (isInStringOrComment(fullCode, match.index || 0)) {\n      return false;\n    }\n\n    // 2. Verificar contexto TypeScript (type assertion, etc)\n    if (isTypeScriptContext(fullCode, match.index || 0)) {\n      return false;\n    }\n\n    // 3. Não modificar arquivos de definição de tipos\n    if (fileCaminho?.includes('.d.ts') || fileCaminho?.includes('/@types/')) {\n      return false;\n    }\n\n    // 4. Não modificar vendor/node_modules\n    if (isLegacyOrVendorFile(fileCaminho)) {\n      return false;\n    }\n\n    // 5. Verificar se any está em função genérica apropriada\n    if (isAnyInGenericFunction(fullCode, match.index || 0)) {\n      return false; // any pode ser apropriado aqui\n    }\n    return true;\n  },\n  fix: (match: RegExpMatchArray, fullCode: string) => {\n    // Retornar código sem modificação por padrão\n    // A aplicação real deve ser feita via fixAsync\n    return fullCode;\n  }\n};\n\n/**\n * Versão assíncrona do fix que faz análise completa\n */\nexport async function fixAnyToProperTypeAsync(match: RegExpMatchArray, fullCode: string, fileCaminho: string, ast: Node | null): Promise<QuickFixResult> {\n  try {\n    // 1. Analisar uso do tipo\n    const typeAnalise = await analyzeTypeUsage(match, fullCode, fileCaminho, ast);\n\n    // 2. Estratégia baseada em confiança\n    if (typeAnalise.confidence >= CONFIANCA_NIVEIS.HIGH) {\n      // ALTA CONFIANÇA: Aplicar tipo automaticamente\n\n      if (typeAnalise.isSimpleType) {\n        // Tipo primitivo: substituir diretamente\n        const fixedCodigo = fullCode.replace(match[0], `: ${typeAnalise.inferredTipo}`);\n\n        // Validar resultado\n        const validation = await validateTypeReplacement(fullCode, fixedCodigo, typeAnalise);\n        if (!validation.isCompatible) {\n          return {\n            code: fullCode,\n            applied: false,\n            reason: `Validação falhou: ${validation.errors.join(', ')}`,\n            warnings: validation.warnings.map(w => ({\n              type: 'unsafe-type',\n              message: w,\n              suggestion: 'Revise manualmente'\n            }))\n          };\n        }\n        return {\n          code: fixedCodigo,\n          applied: true,\n          warnings: validation.warnings.map(w => ({\n            type: 'type-suggestion',\n            message: w,\n            suggestion: MENSAGENS_CORRECAO_TIPOS.validacao.revisar\n          }))\n        };\n      } else {\n        // Tipo complexo: criar interface\n        const typeCaminho = await createTypeDefinition(typeAnalise, fileCaminho);\n        const importStatement = `import type { ${typeAnalise.typeName} } from '${typeCaminho}';\\n`;\n\n        // Adicionar import no topo e substituir any\n        const lines = fullCode.split('\\n');\n        const importIndex = findImportInsertionPoint(lines);\n        lines.splice(importIndex, 0, importStatement);\n        let fixedCodigo = lines.join('\\n');\n        fixedCodigo = fixedCodigo.replace(match[0], `: ${typeAnalise.typeName}`);\n\n        // Validar resultado\n        const validation = await validateTypeReplacement(fullCode, fixedCodigo, typeAnalise);\n        if (!validation.isCompatible) {\n          return {\n            code: fullCode,\n            applied: false,\n            reason: `Validação falhou: ${validation.errors.join(', ')}`\n          };\n        }\n        return {\n          code: fixedCodigo,\n          applied: true,\n          additionalChanges: [{\n            type: 'add-import',\n            content: importStatement\n          }, {\n            type: 'create-type-file',\n            content: typeAnalise.typeDefinition,\n            path: buildTypesRelPathPosix(typeAnalise.suggestedPath)\n          }]\n        };\n      }\n    } else if (typeAnalise.confidence >= CONFIANCA_NIVEIS.MEDIUM) {\n      // MÉDIA CONFIANÇA: Sugerir mas não aplicar\n      const warning: TypeSafetyWarning = {\n        type: 'type-suggestion',\n        message: MENSAGENS_CORRECAO_TIPOS.warnings.confiancaMedia(typeAnalise.confidence, typeAnalise.inferredTipo),\n        suggestion: MENSAGENS_CORRECAO_TIPOS.warnings.criarTipoDedicado(typeAnalise.suggestedPath),\n        confidence: typeAnalise.confidence\n      };\n      return {\n        code: fullCode,\n        applied: false,\n        reason: `Confiança média (${typeAnalise.confidence}%) - sugestão apenas`,\n        warnings: [warning]\n      };\n    } else {\n      // BAIXA CONFIANÇA: Apenas avisar\n      const warning: TypeSafetyWarning = {\n        type: 'unsafe-type',\n        message: MENSAGENS_CORRECAO_TIPOS.warnings.confiancaBaixa(typeAnalise.confidence),\n        suggestion: MENSAGENS_CORRECAO_TIPOS.warnings.useTiposCentralizados(),\n        needsManualReview: true\n      };\n      return {\n        code: fullCode,\n        applied: false,\n        reason: `Confiança baixa (${typeAnalise.confidence}%)`,\n        warnings: [warning]\n      };\n    }\n  } catch (error) {\n    return {\n      code: fullCode,\n      applied: false,\n      reason: MENSAGENS_CORRECAO_TIPOS.erros.analise(error instanceof Error ? error.message : String(error))\n    };\n  }\n}\n\n/**\n * Encontra ponto de inserção para import\n */\nfunction findImportInsertionPoint(lines: string[]): number {\n  let lastImportIndex = -1;\n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i].trim();\n\n    // Pular comentários no topo\n    if (line.startsWith('//') || line.startsWith('/*') || line.startsWith('*')) {\n      continue;\n    }\n\n    // Encontrar último import\n    if (line.startsWith('import ')) {\n      lastImportIndex = i;\n    }\n\n    // Se encontrou código não-import, parar\n    if (line && !line.startsWith('import ') && lastImportIndex !== -1) {\n      break;\n    }\n  }\n\n  // Inserir após último import ou no topo\n  return lastImportIndex + 1;\n}"]}