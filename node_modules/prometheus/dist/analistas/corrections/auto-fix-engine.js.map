{"version":3,"file":"auto-fix-engine.js","sourceRoot":"","sources":["../../../src/analistas/corrections/auto-fix-engine.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n// @prometheus-disable PROBLEMA_PERFORMANCE\n// Justificativa: motor de correção que precisa processar arquivos sequencialmente\n/**\n * Motor de correção automática de tipos inseguros\n * Aplica correções baseadas em análise de contexto e confiança\n */\n\nimport { readFileSync, writeFileSync } from 'node:fs';\n\nimport type { CorrecaoConfig, CorrecaoResult, Ocorrencia } from '@';\n\n/**\n * Aplica correção em um arquivo específico\n */\nexport async function aplicarCorrecaoArquivo(\n  arquivo: string,\n  ocorrencias: Array<{\n    ocorrencia: Ocorrencia;\n    categoria: 'legitimo' | 'melhoravel' | 'corrigir';\n    confianca: number;\n    sugestao?: string;\n  }>,\n  config: CorrecaoConfig,\n): Promise<CorrecaoResult> {\n  try {\n    // Filtrar apenas ocorrências que devem ser corrigidas\n    const paraCorrigir = ocorrencias.filter(\n      (o) => o.categoria === 'corrigir' && o.confianca >= config.minConfianca,\n    );\n\n    if (paraCorrigir.length === 0) {\n      return {\n        sucesso: true,\n        arquivo,\n        linhasModificadas: 0,\n      };\n    }\n\n    // Ler arquivo\n    const conteudo = readFileSync(arquivo, 'utf-8');\n    const linhas = conteudo.split('\\n');\n    let modificadas = 0;\n\n    // Ordenar por linha (decrescente) para não afetar números de linha\n    const ordenadas = [...paraCorrigir].sort(\n      (a, b) => (b.ocorrencia.linha || 0) - (a.ocorrencia.linha || 0),\n    );\n\n    for (const item of ordenadas) {\n      const linha = item.ocorrencia.linha;\n      if (!linha || linha < 1 || linha > linhas.length) continue;\n\n      const linhaIdx = linha - 1;\n      const linhaOriginal = linhas[linhaIdx];\n\n      // Aplicar correção baseada no tipo\n      let linhaCorrigida = linhaOriginal;\n\n      if (item.ocorrencia.tipo === 'tipo-inseguro-any') {\n        // Substituir any por unknown (seguro por padrão)\n        linhaCorrigida = linhaOriginal.replace(/:\\s*any\\b/g, ': unknown');\n        linhaCorrigida = linhaCorrigida.replace(\n          /\\)\\s*:\\s*any\\b/g,\n          '): unknown',\n        );\n      } else if (item.ocorrencia.tipo === 'tipo-inseguro-any-assertion') {\n        // Substituir as any por unknown (mais seguro)\n        linhaCorrigida = linhaOriginal.replace(/as\\s+any\\b/g, 'as unknown');\n      } else if (item.ocorrencia.tipo === 'tipo-inseguro-any-cast') {\n        // Substituir <any> por <unknown>\n        linhaCorrigida = linhaOriginal.replace(/<any>/g, '<unknown>');\n      }\n\n      if (linhaCorrigida !== linhaOriginal) {\n        linhas[linhaIdx] = linhaCorrigida;\n        modificadas++;\n      }\n    }\n\n    // Se não houve modificações, retornar sucesso\n    if (modificadas === 0) {\n      return {\n        sucesso: true,\n        arquivo,\n        linhasModificadas: 0,\n      };\n    }\n\n    const novoConteudo = linhas.join('\\n');\n\n    // Se não é dry-run, escrever arquivo\n    if (!config.dryRun) {\n      writeFileSync(arquivo, novoConteudo, 'utf-8');\n    }\n\n    return {\n      sucesso: true,\n      arquivo,\n      linhasModificadas: modificadas,\n    };\n  } catch (erro: unknown) {\n    const mensagemErro = erro instanceof Error ? erro.message : String(erro);\n    return {\n      sucesso: false,\n      arquivo,\n      linhasModificadas: 0,\n      erro: mensagemErro,\n    };\n  }\n}\n\n/**\n * Aplica correções em múltiplos arquivos\n */\nexport async function aplicarCorrecoesEmLote(\n  porArquivo: Record<\n    string,\n    Array<{\n      ocorrencia: Ocorrencia;\n      categoria: 'legitimo' | 'melhoravel' | 'corrigir';\n      confianca: number;\n      sugestao?: string;\n    }>\n  >,\n  config: CorrecaoConfig,\n): Promise<{\n  sucesso: number;\n  falhas: number;\n  resultados: CorrecaoResult[];\n}> {\n  const resultados: CorrecaoResult[] = [];\n  let sucesso = 0;\n  let falhas = 0;\n\n  for (const [arquivo, ocorrencias] of Object.entries(porArquivo)) {\n    const resultado = await aplicarCorrecaoArquivo(\n      arquivo,\n      ocorrencias,\n      config,\n    );\n    resultados.push(resultado);\n\n    if (resultado.sucesso && resultado.linhasModificadas > 0) {\n      sucesso++;\n    } else if (!resultado.sucesso) {\n      falhas++;\n    }\n  }\n\n  return { sucesso, falhas, resultados };\n}\n"]}