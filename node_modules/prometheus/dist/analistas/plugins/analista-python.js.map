{"version":3,"file":"analista-python.js","sourceRoot":"","sources":["../../../src/analistas/plugins/analista-python.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\nimport { AnalystOrigens, AnalystTipos, PythonMensagens, SeverityNiveis } from '@core/messages/core/plugin-messages.js';\nimport { createLineLookup } from '@shared/helpers/line-lookup.js';\nimport { maskPythonComments, maskPythonStringsAndComments } from '@shared/helpers/masking.js';\n\nimport { criarAnalista, criarOcorrencia } from '@';\n\nconst disableEnv = process.env.PROMETHEUS_DISABLE_PLUGIN_PYTHON === '1';\ntype Msg = ReturnType<typeof criarOcorrencia>;\nfunction isPythonFile(relPath: string): boolean {\n  return /\\.(py|pyx|pyi)$/i.test(relPath);\n}\nfunction warn(message: string, relPath: string, line?: number, nivel: (typeof SeverityNiveis)[keyof typeof SeverityNiveis] = SeverityNiveis.warning): Msg {\n  return criarOcorrencia({\n    relPath,\n    mensagem: message,\n    linha: line,\n    nivel,\n    origem: AnalystOrigens.python,\n    tipo: AnalystTipos.python\n  });\n}\nfunction collectPythonIssues(src: string, relPath: string): Msg[] {\n  const ocorrencias: Msg[] = [];\n  const lineOf = createLineLookup(src).lineAt;\n\n  // Reduz falsos positivos: evite detectar padrões dentro de strings/comentários.\n  const scan = maskPythonStringsAndComments(src);\n  // Algumas regras precisam enxergar literais (ex.: URLs/SQL em strings), mas ainda\n  // devem ignorar comentários.\n  const scanNoComentarios = maskPythonComments(src);\n\n  /* -------------------------- Type Hints & Code Quality -------------------------- */\n\n  // Funções sem type hints (heurística: def seguido de parênteses)\n  // Ignora __init__, main, properties, etc.\n  for (const match of scan.matchAll(/^\\s*(?:async\\s+)?def\\s+([a-z_][a-z0-9_]*)\\s*\\((.*?)\\)(?!\\s*->)/gm)) {\n    const funcNome = match[1] || '';\n    const line = lineOf(match.index);\n\n    // Ignora dunder methods, main, e métodos comuns sem tipo\n    if (/^__|main|__init__|setUp|tearDown|get_|set_/.test(funcNome)) continue;\n    ocorrencias.push(warn(PythonMensagens.missingTypeHints, relPath, line));\n  }\n\n  /* -------------------------- Security Issues -------------------------- */\n\n  // print() instead of logging\n  for (const match of scan.matchAll(/^\\s*print\\s*\\(/gm)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMensagens.printInsteadOfLog, relPath, line));\n  }\n\n  // eval() usage\n  for (const match of scan.matchAll(/\\beval\\s*\\(/gi)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMensagens.evalUsage, relPath, line, SeverityNiveis.error));\n  }\n\n  // exec() usage\n  for (const match of scan.matchAll(/\\bexec\\s*\\(/gi)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMensagens.execUsage, relPath, line, SeverityNiveis.error));\n  }\n\n  // subprocess(..., shell=True)\n  for (const match of scan.matchAll(/\\bsubprocess\\.(?:run|Popen|call|check_call|check_output)\\s*\\([\\s\\S]*?\\)/g)) {\n    if (!/\\bshell\\s*=\\s*True\\b/.test(match[0])) continue;\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMensagens.subprocessShellTrue, relPath, line, SeverityNiveis.error));\n  }\n\n  // pickle loads (RCE)\n  for (const match of scan.matchAll(/\\bpickle\\.(?:load|loads)\\s*\\(/gi)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMensagens.pickleUsage, relPath, line, SeverityNiveis.error));\n  }\n\n  // yaml.load sem Loader seguro\n  for (const match of scan.matchAll(/\\byaml\\.load\\s*\\([\\s\\S]*?\\)/gi)) {\n    const text = match[0] ?? '';\n    const hasSafeLoader = /\\bLoader\\s*=\\s*yaml\\.(?:SafeLoader|CSafeLoader)\\b/.test(text);\n    const hasFullLoader = /\\bLoader\\s*=\\s*yaml\\.(?:FullLoader|CFullLoader)\\b/.test(text);\n    const hasExplicitLoader = /\\bLoader\\s*=/.test(text);\n    if (hasSafeLoader) continue;\n    // FullLoader é melhor que default em versões antigas, mas ainda é discutível; marcamos aviso.\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMensagens.yamlUnsafeLoad, relPath, line, hasFullLoader || hasExplicitLoader ? SeverityNiveis.warning : SeverityNiveis.error));\n  }\n\n  // requests/urllib sem verify (HTTP inseguro)\n  for (const match of scanNoComentarios.matchAll(/(?:requests|urllib)\\.(?:get|post|request)\\s*\\([^)]*\\)/g)) {\n    const hasVerify = /verify\\s*=/i.test(match[0]);\n    if (!hasVerify && /http:\\/\\//i.test(match[0])) {\n      const line = lineOf(match.index);\n      ocorrencias.push(warn(PythonMensagens.httpWithoutVerify, relPath, line));\n    }\n  }\n\n  // SQL injection patterns (simples)\n  // - execute(f\"SELECT ... {var} ...\")\n  // - execute(f'SELECT ... {var} ...')\n  for (const match of scanNoComentarios.matchAll(/\\b(?:execute|executemany|executescript)\\s*\\(\\s*f(['\"])(?:SELECT|INSERT|UPDATE|DELETE)[\\s\\S]*?\\1/gi)) {\n    const text = match[0] ?? '';\n    // Heurística: f-string com interpolação sugere concatenação de SQL.\n    if (!/\\{[^}]+\\}/.test(text)) continue;\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMensagens.sqlInjection, relPath, line, SeverityNiveis.error));\n  }\n\n  /* -------------------------- Exception Handling -------------------------- */\n\n  // Bare except\n  for (const match of scan.matchAll(/^\\s*except\\s*:\\s*$/gm)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMensagens.broadExcept, relPath, line));\n  }\n\n  // except ... pass (bad practice)\n  for (const match of scan.matchAll(/except\\s+\\w+\\s*(?:as\\s+\\w+)?\\s*:\\s*pass/g)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMensagens.passInExcept, relPath, line));\n  }\n\n  // bare raise (contextless)\n  for (const match of scan.matchAll(/except\\s+\\w+\\s*(?:as\\s+\\w+)?\\s*:\\s*\\n\\s*raise\\s*\\n/gm)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMensagens.bareRaise, relPath, line));\n  }\n\n  /* -------------------------- Code Quality & Best Practices -------------------------- */\n\n  // global keyword (code smell)\n  for (const match of scan.matchAll(/^\\s*global\\s+\\w+/gm)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMensagens.globalKeyword, relPath, line));\n  }\n\n  // Mutable default arguments\n  for (const match of scan.matchAll(/def\\s+\\w+\\s*\\([^)]*=\\s*(?:\\[|\\{)[^\\]}]*(?:\\]|\\})/g)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMensagens.mutableDefault, relPath, line));\n  }\n\n  /* -------------------------- Performance Hints -------------------------- */\n\n  // Loop that could be list comprehension (simple heuristic)\n  for (const match of scan.matchAll(/for\\s+\\w+\\s+in\\s+\\w+:\\s*\\n\\s*(\\w+)\\.append\\s*\\(/g)) {\n    const line = lineOf(match.index);\n    // Apenas sugerir se parece simples (sem múltiplas linhas complexas)\n    ocorrencias.push(warn(PythonMensagens.listComprehensionOpportunity, relPath, line, SeverityNiveis.suggestion));\n  }\n\n  // Iterating over dict without .items()\n  for (const match of scan.matchAll(/for\\s+\\w+\\s+in\\s+(\\w+):\\s*\\n\\s*(?:value|val)\\s*=\\s*\\1\\[/gm)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMensagens.loopingOverDict, relPath, line, SeverityNiveis.suggestion));\n  }\n  return ocorrencias;\n}\nexport const analistaPython = criarAnalista({\n  nome: 'analista-python',\n  categoria: 'framework',\n  descricao: 'Heurísticas leves para Python (boas práticas e segurança).',\n  global: false,\n  test: (relPath: string): boolean => isPythonFile(relPath),\n  aplicar: async (src, relPath): Promise<Msg[] | null> => {\n    if (disableEnv) return null;\n    if (relPath.includes('src/analistas/plugins/analista-python.ts')) return null;\n    const msgs = collectPythonIssues(src, relPath);\n    return msgs.length ? msgs : null;\n  }\n});\nexport default analistaPython;"]}