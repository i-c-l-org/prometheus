{"version":3,"file":"detector-fantasmas.js","sourceRoot":"","sources":["../../../src/analistas/detectores/detector-fantasmas.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n// @prometheus-disable PROBLEMA_PERFORMANCE\n// Justificativa: detector que analisa código-fonte - loops são esperados\nimport { promises as fs } from 'node:fs';\nimport path from 'node:path';\n\nimport { grafoDependencias } from '@analistas/detectores/detector-dependencias.js';\nimport { config } from '@core/config/config.js';\nimport { isInsideSrc } from '@core/config/paths.js';\nimport { scanRepository } from '@core/execution/scanner.js';\nimport { minimatch } from 'minimatch';\n\nimport type { ArquivoFantasma, FileMap } from '@';\n\nconst EXTENSOES_ALVO = ['.js', '.ts', '.jsx', '.tsx', '.mjs', '.cjs'];\n\n// Janela de inatividade mínima para considerar fantasma (default mais conservador)\nconst INATIVIDADE_DIAS = Number(process.env.GHOST_DAYS) || 45;\nconst MILIS_POR_DIA = 86_400_000;\n\n// Padrões de entrypoints comuns que NÃO devem ser considerados órfãos\nconst ENTRYPOINT_PADROES = [/^(src\\/)?index\\.(ts|js|tsx|jsx|mjs|cjs)$/i, /^(src\\/)?main\\.(ts|js|tsx|jsx|mjs|cjs)$/i, /^(src\\/)?server\\.(ts|js|tsx|jsx|mjs|cjs)$/i, /^(src\\/)?app\\.(ts|js|tsx|jsx|mjs|cjs)$/i, /^(src\\/)?cli\\.(ts|js|tsx|jsx|mjs|cjs)$/i, /(^|\\/)bin\\/[^/]+\\.(ts|js|mjs|cjs)$/i, /\\/index\\.(ts|js|tsx|jsx|mjs|cjs)$/i, /config\\.(ts|js|cjs|mjs)$/i, /\\.config\\.(ts|js|cjs|mjs)$/i, /\\.d\\.ts$/i];\n\n/**\n * Verifica se o arquivo é de teste usando a configuração centralizada\n */\nfunction isTestFileFromConfig(relPath: string): boolean {\n  const testConfiguracao = (config as unknown as {\n    testPadroes?: {\n      files?: string[];\n    };\n  }).testPadroes;\n  const patterns = testConfiguracao?.files || ['**/*.test.*', '**/*.spec.*', 'test/**/*', 'tests/**/*', '**/__tests__/**'];\n  const normalized = relPath.replace(/\\\\/g, '/');\n  return patterns.some(p => minimatch(normalized, p, {\n    dot: true\n  }));\n}\n\n/**\n * Verifica se é um entrypoint conhecido (bin, cli, main, index, etc.)\n */\nfunction isEntrypoint(relPath: string): boolean {\n  const normalized = relPath.replace(/\\\\/g, '/');\n  return ENTRYPOINT_PADROES.some(p => p.test(normalized));\n}\n\n/**\n * Verifica se o arquivo está sendo referenciado por outro arquivo no grafo\n */\nfunction estaSendoReferenciado(relPath: string, grafo: Map<string, Set<string>>): boolean {\n  const normalized = relPath.replace(/\\\\/g, '/');\n  // Variações que podem existir no grafo (com/sem extensão, etc.)\n  const variations = new Set<string>([normalized]);\n  const ext = path.posix.extname(normalized);\n  if (ext) {\n    variations.add(normalized.slice(0, -ext.length));\n  }\n  // Adiciona variações com extensões comuns\n  const base = ext ? normalized.slice(0, -ext.length) : normalized;\n  for (const e of ['.ts', '.js', '.tsx', '.jsx', '.mjs', '.cjs']) {\n    variations.add(base + e);\n  }\n  for (const dependencias of grafo.values()) {\n    for (const dep of dependencias) {\n      const depNorm = dep.replace(/\\\\/g, '/');\n      if (variations.has(depNorm)) return true;\n    }\n  }\n  return false;\n}\n\n/**\n * Verifica se o arquivo importa outros (é um consumidor, não apenas consumido)\n */\nfunction importaOutros(relPath: string, grafo: Map<string, Set<string>>): boolean {\n  const normalized = relPath.replace(/\\\\/g, '/');\n  for (const [chave, deps] of grafo.entries()) {\n    if (chave.replace(/\\\\/g, '/') === normalized && deps.size > 0) {\n      return true;\n    }\n  }\n  return false;\n}\nexport async function detectarFantasmas(baseDir: string = process.cwd()): Promise<{\n  total: number;\n  fantasmas: ArquivoFantasma[];\n}> {\n  const fileMap: FileMap = await scanRepository(baseDir);\n  const agora = Date.now();\n  const fantasmas: ArquivoFantasma[] = [];\n\n  // Verifica se a config permite excluir testes da checagem de órfãos\n  const testConfiguracao = (config as unknown as {\n    testPadroes?: {\n      excludeFromOrphanCheck?: boolean;\n    };\n  }).testPadroes;\n  const excludeTestsFromOrphan = testConfiguracao?.excludeFromOrphanCheck !== false; // default true\n\n  for (const entrada of Object.values(fileMap)) {\n    const {\n      relPath,\n      fullCaminho\n    } = entrada;\n    const ext = path.extname(relPath).toLowerCase();\n    if (!EXTENSOES_ALVO.includes(ext)) continue;\n\n    // 1. Ignora arquivos de teste (usando config centralizada)\n    if (excludeTestsFromOrphan && isTestFileFromConfig(relPath)) {\n      continue;\n    }\n\n    // 2. Ignora entrypoints conhecidos\n    if (isEntrypoint(relPath)) {\n      continue;\n    }\n    try {\n      const stat = await fs.stat(fullCaminho);\n      const diasInativo = Math.floor((agora - stat.mtimeMs) / MILIS_POR_DIA);\n\n      // Se o grafo ainda não foi populado (execução isolada da poda), não arrisca classificar\n      if (grafoDependencias.size === 0) continue;\n      const referenciado = estaSendoReferenciado(relPath, grafoDependencias);\n\n      // 3. Arquivo que importa outros não é órfão (é um consumidor/entrypoint)\n      if (importaOutros(relPath, grafoDependencias)) {\n        continue;\n      }\n\n      // 4. Proteção extra para arquivos dentro de src/\n      if (isInsideSrc(relPath)) {\n        // Arquivos recentes (menos de 7 dias) não são marcados como órfãos\n        if (diasInativo < 7) continue;\n      }\n\n      // 5. Heurística final: somente é fantasma se (não referenciado) E (inativo acima do limiar)\n      if (!referenciado && diasInativo > INATIVIDADE_DIAS) {\n        fantasmas.push({\n          arquivo: relPath,\n          referenciado,\n          diasInativo\n        });\n      }\n    } catch {\n      // Silenciosamente ignora arquivos inacessíveis\n    }\n  }\n  return {\n    total: fantasmas.length,\n    fantasmas\n  };\n}"]}