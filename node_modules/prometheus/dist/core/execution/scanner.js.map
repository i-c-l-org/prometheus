{"version":3,"file":"scanner.js","sourceRoot":"","sources":["../../../src/core/execution/scanner.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT-0\n// @prometheus-disable PROBLEMA_PERFORMANCE\n// Justificativa: scanner que varre sistema de arquivos - loops s√£o necess√°rios\nimport type { Dirent, Stats } from 'node:fs';\nimport { promises as fs } from 'node:fs';\n\nimport { config } from '@core/config/config.js';\nimport { ExcecoesMensagens } from '@core/messages/core/excecoes-messages.js';\nimport { logVarredor } from '@core/messages/log/log-helper.js';\nimport { lerArquivoTexto, lerEstado } from '@shared/persistence/persistencia.js';\nimport micromatch from 'micromatch';\nimport pLimit from 'p-limit';\nimport path from 'path';\n\nimport type { FileMap, ScanOptions } from '@';\n\nexport type { ScanOptions };\nexport async function scanRepository(baseDir: string, options: ScanOptions = {}): Promise<FileMap> {\n  // Log de in√≠cio da varredura\n  logVarredor.iniciarVarredura(baseDir);\n\n  // Helpers locais de normaliza√ß√£o (n√£o exportados)\n  const toPosix = (s: string) => s.replace(/\\\\+/g, '/');\n  const trimDotSlash = (s: string) => s.replace(/^\\.\\/?/, '');\n  const {\n    includeContent = true,\n    filter = () => true,\n    onProgress = () => {\n      return undefined;\n    }\n  } = options;\n  // Em modo scan-only, n√£o devemos ler conte√∫dos de arquivos\n  const efetivoIncluirConteudo = includeContent && !config.SCAN_ONLY;\n  const fileMap: FileMap = {};\n  const statCache = new Map<string, Stats>();\n  // üî• CONFIGURA√á√ÉO SIMPLIFICADA - Apenas CLI e exclude global\n  const gruposRaw = (config as unknown as {\n    CLI_INCLUDE_GROUPS?: string[][];\n  }).CLI_INCLUDE_GROUPS || [];\n  const includeGroups = Array.isArray(gruposRaw) ? gruposRaw : [];\n  const includeGroupsNorm: string[][] = includeGroups.map(g => (g || []).map(p => toPosix(trimDotSlash(String(p || '')))));\n  const includePadroes = Array.isArray(config.CLI_INCLUDE_PATTERNS) ? config.CLI_INCLUDE_PATTERNS as string[] : [];\n  const includePadroesNorm = includePadroes.map(p => toPosix(trimDotSlash(String(p || ''))));\n  const excludePadroesNorm = (Array.isArray(config.CLI_EXCLUDE_PATTERNS) ? config.CLI_EXCLUDE_PATTERNS as string[] : []).map(p => toPosix(String(p || '')));\n\n  // üìå √öNICO PONTO DE EXCLUDE: globalExcludeGlob da configura√ß√£o legacy ou campo simplificado\n  const legacyExcludes = config.INCLUDE_EXCLUDE_RULES?.globalExcludeGlob || [];\n  const ignorePadroesNorm = (legacyExcludes as string[]).map((p: string) => toPosix(String(p || '')));\n  const hasIncluir = includeGroupsNorm.length > 0 || includePadroesNorm.length > 0;\n  // Sinaliza quando os includes pedem ocorr√™ncias em qualquer profundidade (ex.: '**/nome/**') ou quando\n  // o usu√°rio forneceu nomes simples (que o expandIncludes converte em '**/nome/**').\n  const pedeOcorrenciasGlobais = hasIncluir ? [...includePadroesNorm, ...includeGroupsNorm.flat()].some(p => p.startsWith('**/')) : false;\n  // node_modules explicitamente inclu√≠do em algum pattern ou grupo de include\n  const includeNodeModulesExplicit = hasIncluir ? [...includePadroesNorm, ...includeGroupsNorm.flat()].some(p => /(^|\\/)node_modules(\\/|$)/.test(String(p || ''))) : false;\n\n  // Quando includes est√£o ativos, derivamos diret√≥rios-raiz a partir dos prefixos antes do primeiro metacaractere\n\n  function calcularIncludeRoots(padroes: string[] | undefined, grupos?: string[][]): string[] {\n    const roots = new Set<string>();\n    const candidatos = new Set<string>();\n    if (Array.isArray(padroes)) padroes.forEach(p => candidatos.add(toPosix(trimDotSlash(p))));\n    if (Array.isArray(grupos)) for (const g of grupos) g.forEach(p => candidatos.add(toPosix(trimDotSlash(p))));\n    if (candidatos.size === 0) return [];\n    const META = /[\\\\*\\?\\{\\}\\[\\]]/; // caracteres meta de glob\n    for (const raw of candidatos) {\n      let p = String(raw).trim();\n      if (!p) continue;\n      p = toPosix(trimDotSlash(p));\n      let anchor = '';\n      if (p.includes('/**')) anchor = p.slice(0, p.indexOf('/**'));else if (p.includes('/*')) anchor = p.slice(0, p.indexOf('/*'));else if (p.includes('/')) anchor = p.split('/')[0];else anchor = '';\n      anchor = anchor.replace(/\\/+/g, '/').replace(/\\/$/, '');\n      // Ignora anchors inv√°lidos: vazios, apenas '.', '**' ou contendo metacaracteres (ex.: '**/src')\n      if (anchor && anchor !== '.' && anchor !== '**' && !META.test(anchor)) {\n        const baseNorm = toPosix(String(baseDir)).replace(/\\/$/, '');\n        const rootPosix = `${baseNorm}/${anchor}`.replace(/\\/+/g, '/');\n        roots.add(rootPosix);\n      }\n    }\n    return Array.from(roots);\n  }\n\n  // Matcher de include considerando grupos: AND dentro do grupo, OR entre grupos\n\n  function matchIncluir(relPath: string): boolean {\n    // Fun√ß√£o auxiliar: avalia se um padr√£o casa com o caminho relativo\n    const matchesPadrao = (rp: string, p: string): boolean => {\n      if (!p) return false;\n      // Casamento direto via micromatch\n      if (micromatch.isMatch(rp, [p])) return true;\n      // Compat extra: reconhece padr√µes simples com sufixo '/**' por prefixo\n      if (p.endsWith('/**')) {\n        const base = p.slice(0, -3); // remove '/**'\n        if (base && rp.startsWith(base)) return true;\n      }\n      // Quando o padr√£o n√£o possui metacaracteres, trate como diret√≥rio/segmento\n      const META = /[\\\\*\\?\\{\\}\\[\\]]/;\n      if (!META.test(p)) {\n        const pat = p.replace(/\\/+$|\\/+$|^\\.\\/?/g, '').replace(/\\/+/g, '/');\n        if (!pat) return false;\n        // Se cont√©m barra: trate como caminho base (prefixo)\n        if (pat.includes('/')) {\n          if (rp === pat) return true;\n          if (rp.startsWith(`${pat}/`)) return true;\n          if (rp.includes(`/${pat}/`)) return true;\n          if (rp.endsWith(`/${pat}`)) return true;\n          return false;\n        }\n        // Segmento simples: casa em qualquer n√≠vel\n        if (rp === pat) return true;\n        if (rp.startsWith(`${pat}/`)) return true;\n        if (rp.includes(`/${pat}/`)) return true;\n        if (rp.endsWith(`/${pat}`)) return true;\n        return false;\n      }\n      return false;\n    };\n    // Fun√ß√£o auxiliar: extrai a \"base\" do padr√£o (token original antes das amplia√ß√µes)\n    const baseFromPadrao = (p: string): string => {\n      let b = p.trim();\n      b = b.replace(/^\\*\\*\\//, ''); // remove '**/' inicial\n      b = b.replace(/\\/\\*\\*$/, ''); // remove '/**' final\n      b = b.replace(/^\\.\\/?/, ''); // remove './' inicial\n      b = b.replace(/\\/+/g, '/').replace(/\\/$/, '');\n      return b;\n    };\n    // Quando houver grupos, aplica estritamente: OR entre grupos com AND dentro do grupo\n    if (includeGroupsNorm.length > 0) {\n      for (const g of includeGroupsNorm) {\n        // Agrupa padr√µes por base (permite OR entre variantes de um mesmo token e AND entre tokens)\n        const porBase = new Map<string, string[]>();\n        for (const p of g) {\n          const base = baseFromPadrao(p);\n          const patternVariants = porBase.get(base) || [];\n          patternVariants.push(p);\n          porBase.set(base, patternVariants);\n        }\n        const allBasesMatch = Array.from(porBase.values()).every(lista => lista.some(p => matchesPadrao(relPath, p)));\n        if (allBasesMatch) return true;\n      }\n      // Sem correspond√™ncia em nenhum grupo -> n√£o inclui\n      return false;\n    }\n    // Sem grupos: lista achatada (OR)\n    if (includePadroesNorm.length && micromatch.isMatch(relPath, includePadroesNorm)) return true;\n    // Compat extra tamb√©m para padr√µes simples quando n√£o h√° grupos\n    for (const p of includePadroesNorm || []) if (matchesPadrao(relPath, p)) return true;\n    return false;\n  }\n    // Concurrency limit for scanning (10 seems like a safe default to avoid EMFILE)\n    const limit = pLimit(10);\n\n    async function scan(dir: string): Promise<void> {\n      let entries: Dirent[];\n      try {\n        entries = await fs.readdir(dir, {\n          withFileTypes: true\n        });\n        entries.sort((a, b) => a.name.localeCompare(b.name));\n      } catch (err) {\n        onProgress(JSON.stringify({\n          tipo: 'erro',\n          acao: 'acessar',\n          caminho: dir,\n          mensagem: typeof err === 'object' && err && 'message' in err ? (err as {\n            message: string;\n          }).message : String(err)\n        }));\n        return;\n      }\n\n      // Logar apenas diret√≥rios sendo examinados\n      onProgress(JSON.stringify({\n        tipo: 'diretorio',\n        acao: 'examinar',\n        caminho: dir\n      }));\n\n      const fileTasks: Promise<void>[] = [];\n      const dirTasks: Promise<void>[] = [];\n\n      for (const entry of entries) {\n        const fullCaminho = path.join(dir, entry.name);\n        const relPathRaw = path.relative(baseDir, fullCaminho);\n        const relPath = toPosix(relPathRaw);\n\n        // Regra fixa do Prometheus: n√£o analisar testes\n        const isTestLike = (p: string): boolean => {\n          const rp = toPosix(p);\n          if (/(^|\\/)__(tests|mocks)__(\\/|$)/.test(rp)) return true;\n          if (/(^|\\/)(tests?|test)(\\/|$)/.test(rp)) return true;\n          if (/\\.(test|spec)\\.[jt]sx?$/.test(rp)) return true;\n          return false;\n        };\n        if (isTestLike(relPath)) continue;\n\n        if (entry.isDirectory() && !entry.isSymbolicLink()) {\n          if (!hasIncluir && micromatch.isMatch(relPath, excludePadroesNorm)) continue;\n          if (!hasIncluir && micromatch.isMatch(relPath, ignorePadroesNorm)) continue;\n          if (/(^|\\/)node_modules(\\/|$)/.test(relPath) && !includeNodeModulesExplicit) continue;\n          dirTasks.push(scan(fullCaminho));\n        } else {\n          if (hasIncluir && !matchIncluir(relPath)) continue;\n          if (!hasIncluir && (micromatch.isMatch(relPath, excludePadroesNorm) || micromatch.isMatch(relPath, ignorePadroesNorm))) continue;\n          if (!filter(relPath, entry)) continue;\n\n          fileTasks.push(limit(async () => {\n            try {\n              let stat: unknown = statCache.get(fullCaminho);\n              if (!stat) {\n                try {\n                  stat = await fs.stat(fullCaminho);\n                  statCache.set(fullCaminho, stat as Stats);\n                } catch (e) {\n                  onProgress(JSON.stringify({\n                    tipo: 'erro', acao: 'ler', caminho: relPath,\n                    mensagem: typeof e === 'object' && e && 'message' in e ? (e as { message: string }).message : String(e)\n                  }));\n                  return;\n                }\n              }\n              if (stat == null) throw new Error(ExcecoesMensagens.statIndefinidoPara(fullCaminho));\n\n              let mtimeMs = 0;\n              if (typeof stat === 'object' && stat && 'mtimeMs' in (stat as Stats)) {\n                const mm = (stat as Stats).mtimeMs;\n                if (typeof mm === 'number') mtimeMs = mm;\n              }\n\n              let content: string | null = null;\n              if (efetivoIncluirConteudo) {\n                try {\n                  if (!!process.env.VITEST) {\n                    content = await lerEstado<string>(fullCaminho);\n                  } else {\n                    content = await lerArquivoTexto(fullCaminho);\n                  }\n                } catch (e) {\n                  onProgress(JSON.stringify({\n                    tipo: 'erro', acao: 'ler', caminho: relPath,\n                    mensagem: typeof e === 'object' && e && 'message' in e ? (e as { message: string }).message : String(e)\n                  }));\n                  content = null;\n                }\n              }\n\n              fileMap[relPath] = {\n                fullCaminho,\n                relPath,\n                content,\n                ultimaModificacao: mtimeMs\n              };\n              logVarredor.arquivoLido(relPath);\n            } catch (err) {\n              onProgress(JSON.stringify({\n                tipo: 'erro', acao: 'ler', caminho: relPath,\n                mensagem: typeof err === 'object' && err && 'message' in err ? (err as { message: string }).message : String(err)\n              }));\n            }\n          }));\n        }\n      }\n\n      await Promise.all([...dirTasks, ...fileTasks]);\n    }\n\n  // Pontos de partida da varredura\n  let startDirs = hasIncluir ? calcularIncludeRoots(config.CLI_INCLUDE_PATTERNS as string[] | undefined, (config as unknown as {\n    CLI_INCLUDE_GROUPS?: string[][];\n  }).CLI_INCLUDE_GROUPS) : [];\n  // Quando o include pede ocorr√™ncias em qualquer profundidade, adicionamos tamb√©m a base do repo para\n  // garantir que diret√≥rios-alvo apare√ßam em n√≠veis arbitr√°rios (ex.: packages/*/node_modules).\n  if (hasIncluir && pedeOcorrenciasGlobais) {\n    const baseNorm = toPosix(String(baseDir)).replace(/\\/$/, '');\n    if (!startDirs.includes(baseNorm)) startDirs = [baseNorm, ...startDirs];\n  }\n  // Se nenhum root foi derivado (ex.: includes somente de arquivos como 'a.txt'), varremos a base inteira\n  // para permitir que o filtro de includes atue nos arquivos diretamente.\n  if (hasIncluir && startDirs.length === 0) {\n    // Sem roots deriv√°veis (ex.: include apenas 'a.txt'): varre s√≥ a raiz para permitir filtro\n    await scan(baseDir);\n    return fileMap;\n  }\n  if (startDirs.length === 0) {\n    await scan(baseDir);\n  } else {\n    const vistos = new Set<string>();\n    for (const d of startDirs) {\n      // Evita normaliza√ß√£o com path.resolve para n√£o quebrar mocks de testes (mant√©m separador POSIX)\n      let norm = d;\n      // Remove barra final para compat com mocks que comparam por igualdade\n      if (/[\\\\\\/]$/.test(norm)) norm = norm.replace(/[\\\\\\/]+$/, '');\n      if (vistos.has(norm)) continue;\n      vistos.add(norm);\n      // Tenta primeiro tratar como diret√≥rio sem depender de stat (mocks podem retornar fun√ß√µes)\n      try {\n        await fs.readdir(norm);\n        await scan(norm);\n        continue;\n      } catch {\n        // n√£o √© diret√≥rio (ou inacess√≠vel); tenta fluxo de arquivo abaixo\n      }\n      // Quando o root derivado for um arquivo, processe-o diretamente\n      try {\n        let st = statCache.get(norm);\n        if (!st) {\n          st = await fs.stat(norm);\n          statCache.set(norm, st);\n        }\n        let isDir = false;\n        if (st && typeof (st as unknown as {\n          isDirectory: () => boolean;\n        }).isDirectory === 'function') {\n          isDir = st.isDirectory();\n        } else {\n          // Fallback quando stat mockado n√£o possui isDirectory confi√°vel: tenta readdir\n          try {\n            await fs.readdir(norm);\n            isDir = true;\n          } catch {\n            isDir = false;\n          }\n        }\n        if (isDir) {\n          await scan(norm);\n        } else {\n          // Alguns testes mockam stat.isDirectory() como false mesmo para diret√≥rios;\n          // se conseguirmos listar, tratamos como diret√≥rio.\n          try {\n            await fs.readdir(norm);\n            await scan(norm);\n            continue;\n          } catch {\n            // segue como arquivo\n          }\n          const relPathRaw = path.relative(baseDir, norm);\n          const relPath = toPosix(relPathRaw);\n          // Aplica as mesmas regras de filtragem de arquivos\n          if (hasIncluir && !matchIncluir(relPath)) {\n            continue;\n          }\n          // Aplica exclus√µes APENAS quando n√£o h√° includes ativos\n          if (!hasIncluir && micromatch.isMatch(relPath, excludePadroesNorm)) {\n            continue;\n          }\n          if (!hasIncluir && micromatch.isMatch(relPath, ignorePadroesNorm)) {\n            continue;\n          }\n          // Filtro customizado exige Dirent; criamos um stub m√≠nimo\n          const fakeDirent: Dirent = {\n            name: path.basename(norm),\n            isDirectory: () => false,\n            isSymbolicLink: () => false\n          } as unknown as Dirent;\n          // Filtro customizado (sempre aplica quando include est√° ativo)\n          if (!filter(relPath, fakeDirent)) continue;\n          let content: string | null = null;\n          if (efetivoIncluirConteudo) {\n            const emTeste = !!process.env.VITEST;\n            try {\n              if (emTeste) content = await lerEstado<string>(norm);else content = await lerArquivoTexto(norm);\n            } catch (e) {\n              onProgress(JSON.stringify({\n                tipo: 'erro',\n                acao: 'ler',\n                caminho: relPath,\n                mensagem: typeof e === 'object' && e && 'message' in e ? (e as {\n                  message: string;\n                }).message : String(e)\n              }));\n              content = null;\n            }\n          }\n          fileMap[relPath] = {\n            fullCaminho: norm,\n            relPath,\n            content,\n            ultimaModificacao: (st && 'mtimeMs' in st ? (st as Stats).mtimeMs : Date.now()) || Date.now()\n          };\n          logVarredor.arquivoLido(relPath);\n        }\n      } catch (e) {\n        onProgress(JSON.stringify({\n          tipo: 'erro',\n          acao: 'acessar',\n          caminho: norm,\n          mensagem: typeof e === 'object' && e && 'message' in e ? (e as {\n            message: string;\n          }).message : String(e)\n        }));\n      }\n    }\n  }\n\n  // Log de conclus√£o da varredura\n  const totalArquivos = Object.keys(fileMap).length;\n  const totalDiretorios = new Set(Object.values(fileMap).map(f => path.dirname(f.relPath))).size;\n  logVarredor.completo(totalArquivos, totalDiretorios);\n  return fileMap;\n}"]}