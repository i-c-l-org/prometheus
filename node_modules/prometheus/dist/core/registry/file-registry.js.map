{"version":3,"file":"file-registry.js","sourceRoot":"","sources":["../../../src/core/registry/file-registry.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT-0\n/**\n * @fileoverview Registry centralizado para operações de leitura/escrita de arquivos JSON\n *\n * Este módulo fornece uma camada de abstração sobre a persistência,\n * gerenciando migrações automáticas de arquivos legados e garantindo\n * que todos os arquivos sejam salvos nos locais corretos.\n *\n * Features:\n * - Migração automática de arquivos legados\n * - Validação de integridade de JSONs\n * - Logging de operações de I/O\n * - Fallback para configurações seguras\n */\nimport { promises as fs } from 'node:fs';\nimport path from 'node:path';\n\nimport { ExcecoesMensagens } from '@core/messages/core/excecoes-messages.js';\n\nimport type { MigrationResult } from '@';\n\nimport { log } from '../messages/log/log.js';\nimport { MIGRACAO_MAPA,PROMETHEUS_ARQUIVOS, PROMETHEUS_DIRS, type PrometheusFilePath } from './paths.js';\n\n/**\n * Opções para operações de leitura\n */\ninterface ReadOptions<T> {\n  /** Valor padrão se arquivo não existir */\n  default?: T;\n  /** Tentar migrar de arquivo legado automaticamente */\n  migrate?: boolean;\n  /** Validar estrutura do JSON */\n  validate?: (data: unknown) => data is T;\n}\n\n/**\n * Opções para operações de escrita\n */\ninterface WriteOptions {\n  /** Criar diretórios pai se não existirem */\n  createDirs?: boolean;\n  /** Fazer backup antes de sobrescrever */\n  backup?: boolean;\n  /** Pretty print JSON */\n  pretty?: boolean;\n}\n\n/**\n * Verifica se arquivo existe\n */\nasync function fileExists(fileCaminho: string): Promise<boolean> {\n  try {\n    await fs.access(fileCaminho);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Cria diretórios pai se não existirem\n */\nasync function ensureDir(fileCaminho: string): Promise<void> {\n  const dir = path.dirname(fileCaminho);\n  await fs.mkdir(dir, {\n    recursive: true\n  });\n}\n\n/**\n * Tenta migrar arquivo legado para novo local\n */\nasync function tryMigrate(targetPath: string): Promise<MigrationResult> {\n  const legacyCaminho = Object.entries(MIGRACAO_MAPA).find(([_, target]) => target === targetPath)?.[0];\n  if (!legacyCaminho) {\n    return {\n      migrated: false\n    };\n  }\n  const legacyExists = await fileExists(legacyCaminho);\n  if (!legacyExists) {\n    return {\n      migrated: false\n    };\n  }\n  try {\n    // Ler arquivo legado\n    const content = await fs.readFile(legacyCaminho, 'utf-8');\n\n    // Garantir diretório de destino\n    await ensureDir(targetPath);\n\n    // Escrever no novo local\n    await fs.writeFile(targetPath, content, 'utf-8');\n\n    // Renomear arquivo legado (não deletar para segurança)\n    const backupCaminho = `${legacyCaminho}.migrated`;\n    await fs.rename(legacyCaminho, backupCaminho);\n    log.info(`Migração automática: ${path.basename(legacyCaminho)} → ${path.basename(targetPath)}`);\n    return {\n      migrated: true,\n      from: legacyCaminho,\n      to: targetPath\n    };\n  } catch (erro) {\n    log.aviso(`Falha na migração de ${legacyCaminho}: ${(erro as Error).message}`);\n    return {\n      migrated: false\n    };\n  }\n}\n\n/**\n * Lê arquivo JSON do registry\n *\n * @param filePath Caminho do arquivo (use PROMETHEUS_FILES.*)\n * @param options Opções de leitura\n * @returns Conteúdo parseado do JSON\n *\n * @example\n * ```ts\n * const config = await readJSON(PROMETHEUS_FILES.CONFIG, {\n *   default: {}\n * });\n * ```\n */\nexport async function readJSON<T = unknown>(fileCaminho: PrometheusFilePath | string, options: ReadOptions<T> = {}): Promise<T> {\n  const {\n    default: defaultValue,\n    migrate = true,\n    validate\n  } = options;\n  try {\n    // Tentar migração se habilitado\n    if (migrate) {\n      const migration = await tryMigrate(fileCaminho);\n      if (migration.migrated && migration.to) {\n        // Usar arquivo migrado\n        fileCaminho = migration.to;\n      }\n    }\n\n    // Verificar existência\n    const exists = await fileExists(fileCaminho);\n    if (!exists) {\n      if (defaultValue !== undefined) {\n        return defaultValue;\n      }\n      throw new Error(ExcecoesMensagens.arquivoNaoEncontrado(String(fileCaminho)));\n    }\n\n    // Ler e parsear\n    const content = await fs.readFile(fileCaminho, 'utf-8');\n    const parsed = JSON.parse(content) as T;\n\n    // Validar se fornecido\n    if (validate && !validate(parsed)) {\n      throw new Error(ExcecoesMensagens.validacaoFalhouPara(String(fileCaminho)));\n    }\n    return parsed;\n  } catch (erro) {\n    if (defaultValue !== undefined) {\n      return defaultValue;\n    }\n    throw new Error(ExcecoesMensagens.erroAoLer(String(fileCaminho), (erro as Error).message));\n  }\n}\n\n/**\n * Escreve arquivo JSON no registry\n *\n * @param filePath Caminho do arquivo (use PROMETHEUS_FILES.*)\n * @param data Dados a serem salvos\n * @param options Opções de escrita\n *\n * @example\n * ```ts\n * await writeJSON(PROMETHEUS_FILES.GUARDIAN_BASELINE, snapshot, {\n *   createDirs: true,\n *   backup: true\n * });\n * ```\n */\nexport async function writeJSON<T = unknown>(fileCaminho: PrometheusFilePath | string, data: T, options: WriteOptions = {}): Promise<void> {\n  const {\n    createDirs = true,\n    backup = false,\n    pretty = true\n  } = options;\n  try {\n    // Criar diretórios se necessário\n    if (createDirs) {\n      await ensureDir(fileCaminho);\n    }\n\n    // Fazer backup se solicitado\n    if (backup && (await fileExists(fileCaminho))) {\n      const backupCaminho = `${fileCaminho}.backup`;\n      await fs.copyFile(fileCaminho, backupCaminho);\n    }\n\n    // Serializar JSON\n    const content = pretty ? JSON.stringify(data, null, 2) : JSON.stringify(data);\n\n    // Escrever arquivo\n    await fs.writeFile(fileCaminho, content, 'utf-8');\n  } catch (erro) {\n    throw new Error(ExcecoesMensagens.erroAoEscrever(String(fileCaminho), (erro as Error).message));\n  }\n}\n\n/**\n * Deleta arquivo do registry\n *\n * @param filePath Caminho do arquivo (use PROMETHEUS_FILES.*)\n * @param options Opções de deleção\n */\nexport async function deleteJSON(fileCaminho: PrometheusFilePath | string, options: {\n  backup?: boolean;\n} = {}): Promise<void> {\n  const {\n    backup = true\n  } = options;\n  try {\n    const exists = await fileExists(fileCaminho);\n    if (!exists) {\n      return; // Já deletado\n    }\n    if (backup) {\n      const backupCaminho = `${fileCaminho}.deleted`;\n      await fs.rename(fileCaminho, backupCaminho);\n    } else {\n      await fs.unlink(fileCaminho);\n    }\n  } catch (erro) {\n    throw new Error(ExcecoesMensagens.erroAoDeletar(String(fileCaminho), (erro as Error).message));\n  }\n}\n\n/**\n * Lista todos os arquivos JSON em um diretório do registry\n *\n * @param dirPath Caminho do diretório (use PROMETHEUS_DIRS.*)\n * @returns Lista de caminhos completos\n */\nexport async function listJSONFiles(dirPath: string): Promise<string[]> {\n  try {\n    const exists = await fileExists(dirPath);\n    if (!exists) {\n      return [];\n    }\n    const entries = await fs.readdir(dirPath, {\n      withFileTypes: true\n    });\n    const jsonArquivos = entries.filter(entry => entry.isFile() && entry.name.endsWith('.json')).map(entry => path.join(dirPath, entry.name));\n    return jsonArquivos;\n  } catch (erro) {\n    log.aviso(`Erro ao listar arquivos em ${dirPath}: ${(erro as Error).message}`);\n    return [];\n  }\n}\n\n/**\n * Exporta funções auxiliares para compatibilidade com código existente\n */\nexport const ArquivoRegistro = {\n  read: readJSON,\n  write: writeJSON,\n  delete: deleteJSON,\n  list: listJSONFiles,\n  paths: PROMETHEUS_ARQUIVOS,\n  dirs: PROMETHEUS_DIRS\n} as const;"]}