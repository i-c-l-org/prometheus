{"version":3,"file":"cli.js","sourceRoot":"","sources":["../../src/bin/cli.ts"],"names":[],"mappings":"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","sourcesContent":["#!/usr/bin/env node\n// SPDX-License-Identifier: MIT\nimport { dirname, join } from 'node:path';\nimport { fileURLToPath } from 'node:url';\n\nimport { registrarComandos } from '@cli/comandos.js';\nimport { comandoPerf } from '@cli/commands/index.js';\nimport { ExitCode, sair } from '@cli/helpers/exit-codes.js';\nimport chalk from '@core/config/chalk-safe.js';\nimport { aplicarConfigParcial, config, inicializarConfigDinamica } from '@core/config/config.js';\nimport { ICONES_NIVEL } from '@core/messages/index.js';\nimport type { ConversationMemory } from '@shared/memory.js';\nimport { getDefaultMemory } from '@shared/memory.js';\nimport { lerArquivoTexto } from '@shared/persistence/persistencia.js';\nimport type { CommanderError } from 'commander';\nimport { Command } from 'commander';\n\n// üåê Flags globais aplic√°veis em todos os comandos\nimport type { ErrorLike,PrometheusGlobalFlags } from '@';\nimport { extrairMensagemErro } from '@';\n\n// caminho do m√≥dulo (usado para localizar arquivos de configura√ß√£o)\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\n\n// üì¶ Ler vers√£o dinamicamente do package.json\n\nasync function getVersion(): Promise<string> {\n  try {\n    // Ao compilar, este arquivo vai para dist/bin; o package.json fica na raiz (subir dois n√≠veis)\n    const packageCaminho = join(__dirname, '..', '..', 'package.json');\n    const raw = await lerArquivoTexto(packageCaminho);\n    const pkg = raw ? JSON.parse(raw) : {};\n    return pkg && (pkg as {\n      version?: string;\n    }).version || '0.0.0';\n  } catch {\n    return '0.0.0'; // fallback\n  }\n}\n\n// üõ†Ô∏è Configura√ß√£o principal do CLI\nconst program = new Command();\n\n// ÔøΩÔ∏è Fun√ß√£o para aplicar flags globais\nasync function aplicarFlagsGlobais(opts: unknown) {\n  const flags = opts as PrometheusGlobalFlags;\n  // Sanitiza√ß√£o e normaliza√ß√£o (pode lan√ßar)\n  try {\n    // lazy import para n√£o criar ciclo\n    const {\n      sanitizarFlags\n    } = await import('@shared/validation/validacao.js');\n    sanitizarFlags(flags as Record<string, unknown>);\n  } catch (e) {\n    console.error(chalk.red(`${ICONES_NIVEL.erro} Flags inv√°lidas: ${(e as Error).message}`));\n    sair(ExitCode.InvalidUsage);\n  }\n  config.REPORT_SILENCE_LOGS = Boolean(flags.silence);\n  config.REPORT_EXPORT_ENABLED = Boolean(flags.export);\n  config.REPORT_EXPORT_FULL = Boolean((flags as Record<string, unknown>)['exportFull']);\n  const debugAtivo = Boolean(flags.debug) || process.env.PROMETHEUS_DEBUG === 'true';\n  config.DEV_MODE = debugAtivo;\n  config.SCAN_ONLY = Boolean(flags.scanOnly);\n  // Se silence est√° ativo, verbose √© sempre falso\n  config.VERBOSE = flags.silence ? false : Boolean(flags.verbose);\n  const overrides: Record<string, unknown> = {};\n  const optObj = opts as Record<string, unknown>;\n  if (typeof optObj.logEstruturado === 'boolean') overrides.LOG_ESTRUTURADO = optObj.logEstruturado;\n  if (typeof optObj.incremental === 'boolean') overrides.ANALISE_INCREMENTAL_ENABLED = optObj.incremental;\n  if (typeof optObj.metricas === 'boolean') overrides.ANALISE_METRICAS_ENABLED = optObj.metricas;\n  if (Object.keys(overrides).length) aplicarConfigParcial(overrides);\n}\n\n// üîó Registro de todos os comandos\nregistrarComandos(program, o => aplicarFlagsGlobais(o));\nprogram.addCommand(comandoPerf());\n\n// üöÄ Execu√ß√£o do CLI\n// Carrega config de arquivo/env explicitamente no processo do CLI, mesmo sob VITEST (e2e spawn)\n// NOTE: a execu√ß√£o principal foi extra√≠da para `mainCli` para permitir testes que importam este\n// m√≥dulo sem disparar automaticamente a execu√ß√£o (reduz falsos-positivos do analisador).\nexport async function mainCli(): Promise<void> {\n  // Inicializa mem√≥ria de conversas\n\n  // Handler de rejei√ß√µes n√£o tratadas com mensagem identific√°vel (usado por testes e ops)\n  function __prometheus_unhandledRejectionHandler(err: ErrorLike) {\n    const MARCADOR = 'Prometheus: unhandled rejection';\n    const mensagem = extrairMensagemErro(err);\n    console.error(MARCADOR, mensagem);\n    if (!process.env.VITEST) {\n      if (err && typeof err === 'object' && 'stack' in err) {\n        console.error((err as {\n          stack?: string;\n        }).stack);\n      }\n      process.exit(1);\n    }\n  }\n  process.on('unhandledRejection', __prometheus_unhandledRejectionHandler);\n\n  // Mantemos handler para exce√ß√µes n√£o capturadas ‚Äî garante comportamento cr√≠tico em produ√ß√£o\n  process.on('uncaughtException', (err: ErrorLike) => {\n    const mensagem = extrairMensagemErro(err);\n    console.error(chalk.red(`${ICONES_NIVEL.erro} Exce√ß√£o n√£o capturada: ${mensagem}`));\n    if (err && typeof err === 'object' && 'stack' in err) {\n      console.error((err as {\n        stack?: string;\n      }).stack);\n    }\n    // s√≥ encerra fora do ambiente de teste\n    if (!process.env.VITEST) sair(ExitCode.Critical);\n  });\n  let memoria: ConversationMemory | undefined;\n  try {\n    memoria = await getDefaultMemory();\n  } catch {}\n  // Aplica defaults de produ√ß√£o (se presentes) antes de inicializar a config din√¢mica.\n  try {\n    if (process.env.NODE_ENV === 'production') {\n      try {\n        // Em dist/bin, o safe config est√° na raiz do pacote: subir dois n√≠veis\n        const safeCfgCaminho = join(__dirname, '..', '..', 'prometheus.config.safe.json');\n        const raw = await lerArquivoTexto(safeCfgCaminho);\n        const safeCfg = raw ? JSON.parse(raw) : {};\n        const prod = safeCfg?.productionDefaults;\n        if (prod && typeof prod === 'object') {\n          for (const [k, v] of Object.entries(prod)) {\n            if (process.env[k] === undefined) process.env[k] = String(v);\n          }\n        }\n      } catch {\n        // ignore - arquivo safe pode n√£o existir em todos os ambientes\n      }\n    }\n    // Atualiza a vers√£o do programa de forma ass√≠ncrona antes do parse\n    try {\n      const versionNumber = await getVersion();\n      // commander exp√µe private API ._version; usar m√©todo p√∫blico quando dispon√≠vel\n      if (typeof (program as unknown as {\n        version: (v: string) => void;\n      }).version === 'function') {\n        (program as unknown as {\n          version: (v: string) => void;\n        }).version(versionNumber);\n      } else {\n        // fallback defensivo\n        (program as unknown as {\n          _version?: string;\n        })._version = versionNumber;\n      }\n    } catch {}\n    await inicializarConfigDinamica();\n  } catch {\n    // ignore: CLI continua com defaults\n  }\n  // Antes de parsear, trata flags de hist√≥rico simples\n  const argv = process.argv.slice(2);\n  if (argv.includes('--historico')) {\n    if (memoria) {\n      const resumo = memoria.getSummary();\n      console.log(chalk.cyan('\\nüìä RESUMO DA CONVERSA'));\n      console.log(`Total: ${resumo.totalMessages}`);\n      console.log(`Usu√°rio: ${resumo.userMessages}`);\n      console.log(`Prometheus: ${resumo.assistantMessages}`);\n      if (resumo.firstMessage) console.log(`Primeira: ${resumo.firstMessage}`);\n      if (resumo.lastMessage) console.log(`√öltima: ${resumo.lastMessage}`);\n      console.log('');\n    } else {\n      console.log(chalk.yellow('Hist√≥rico indispon√≠vel.'));\n    }\n    return; // encerra ap√≥s exibir\n  }\n  if (argv.includes('--limpar-historico')) {\n    if (memoria) await memoria.clear();\n    console.log(chalk.green('Hist√≥rico limpo.'));\n    return;\n  }\n\n  // Registra a execu√ß√£o atual no hist√≥rico\n  try {\n    await memoria?.addMessage({\n      role: 'user',\n      content: `Execu√ß√£o CLI: ${argv.join(' ') || '(sem argumentos)'}`,\n      timestamp: new Date().toISOString()\n    });\n  } catch {}\n\n  // Intercepta erros de uso do Commander e mapeia para exit code 3\n  program.exitOverride((err: CommanderError) => {\n    const code = err?.code || '';\n    const isUsoInvalido = code === 'commander.unknownCommand' || code === 'commander.unknownOption' || code === 'commander.missingArgument' || code === 'commander.optionMissingArgument' || code === 'commander.missingMandatoryOptionValue' || code === 'commander.invalidArgument';\n    if (isUsoInvalido) {\n      console.error(chalk.red(`${ICONES_NIVEL.erro} ${err.message}`));\n      sair(ExitCode.InvalidUsage);\n      return;\n    }\n    throw err;\n  });\n  await program.parseAsync(process.argv);\n}\n\n// Global handler para reduzir falsos-positivos e capturar rejei√ß√µes n√£o tratadas.\n// A mensagem cont√©m um marcador √∫nico para que testes possam verificar o registro.\nfunction __prometheus_unhandledRejectionHandler(err: ErrorLike) {\n  const MARCADOR = 'Prometheus: unhandled rejection';\n  const mensagem = extrairMensagemErro(err);\n  // Mensagem identific√°vel: usada pelos testes unit√°rios para detectar o handler\n  // e por operadores para diagn√≥stico r√°pido.\n\n  console.error(MARCADOR, mensagem);\n  // Em ambiente de testes preferimos n√£o encerrar o processo ‚Äî mant√©m compatibilidade com Vitest.\n  if (!process.env.VITEST) {\n    if (err && typeof err === 'object' && 'stack' in err) {\n      // imprime stack em produ√ß√£o para diagn√≥stico\n\n      console.error((err as {\n        stack?: string;\n      }).stack);\n    }\n    process.exit(1);\n  }\n}\nprocess.on('unhandledRejection', __prometheus_unhandledRejectionHandler);\n\n// Invoca a fun√ß√£o principal apenas quando o arquivo for executado como entrypoint.\n// Isso evita efeitos colaterais ao importar o m√≥dulo em testes ou ferramentas de an√°lise.\nif (import.meta.url === `file://${process.argv[1]}` || process.argv[1] && process.argv[1].endsWith('/bin/cli.js')) {\n  mainCli().catch(err => {\n    // mant√©m comportamento compat√≠vel em produ√ß√£o ‚Äî mas evita exit em VITEST\n    const mensagem = extrairMensagemErro(err);\n    console.error(chalk.red(`${ICONES_NIVEL.erro} ${mensagem}`));\n    if (err && typeof err === 'object' && 'stack' in err) {\n      console.error((err as {\n        stack?: string;\n      }).stack);\n    }\n    if (!process.env.VITEST) process.exit(1);\n  });\n} else {\n  // Ao importar (ex.: Vitest), n√£o executamos a CLI automaticamente ‚Äî ainda registramos o handler acima.\n}"]}