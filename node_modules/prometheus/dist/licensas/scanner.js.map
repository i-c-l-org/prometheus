{"version":3,"file":"scanner.js","sourceRoot":"","sources":["../../src/licensas/scanner.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\nimport path from 'node:path';\n\nimport { exists, findLicenseFile, readPackageJsonSync } from './fs-utils.js';\nimport type { ScanOptions, ScanResult } from './licensas.js';\nimport { normalizeLicense } from './normalizer.js';\n\nexport async function scan({\n  root = process.cwd(),\n  includeDev: _includeDev = false\n} = {} as ScanOptions): Promise<ScanResult> {\n  const nmDir = path.join(root, 'node_modules');\n  const result: ScanResult = {\n    generatedAt: new Date().toISOString(),\n    totalPackages: 0,\n    totalFiltered: 0,\n    licenseCounts: {},\n    packages: [],\n    problematic: []\n  };\n  if (!exists(nmDir)) {\n    return result;\n  }\n  const entries: string[] = [];\n  try {\n    const dirEntries = await fsReaddir(nmDir);\n    for (const e of dirEntries) entries.push(e);\n  } catch {\n    return result;\n  }\n  for (const entryNome of entries) {\n    if (entryNome === '.bin') continue;\n    const full = path.join(nmDir, entryNome);\n    if (entryNome.startsWith('@')) {\n      try {\n        const scoped = await fsReaddir(full);\n        for (const s of scoped) {\n          const p = path.join(full, s);\n          if (await fsStatIsDir(p)) await processPackage(p, result);\n        }\n      } catch {\n        // ignore\n      }\n    } else {\n      if (await fsStatIsDir(full)) await processPackage(full, result);\n    }\n  }\n\n  // Removido `: unknown` — result.packages já é tipado, inferência funciona corretamente\n  const filtered = result.packages.filter(p => !p.name.startsWith('@types/'));\n  result.totalPackages = result.packages.length;\n  result.totalFiltered = filtered.length;\n  for (const p of filtered) result.licenseCounts[p.license] = (result.licenseCounts[p.license] || 0) + 1;\n  return result;\n  async function processPackage(pkgDir: string, resObj: ScanResult) {\n    const pkgJsonCaminho = path.join(pkgDir, 'package.json');\n    if (!exists(pkgJsonCaminho)) return;\n    const data = readPackageJsonSync(pkgJsonCaminho);\n    if (!data) return;\n    const name = (typeof data.name === 'string' ? data.name : path.basename(pkgDir)) as string;\n    const version = (typeof data.version === 'string' ? data.version : '0.0.0') as string;\n    const rawLicenca = data.license ?? data.licenses ?? null;\n    const licenseValor = await normalizeLicense(rawLicenca || 'UNKNOWN');\n    const licenseArquivo = findLicenseFile(pkgDir);\n    const repo = data.repository;\n    const repository = repo == null ? null : typeof repo === 'string' ? repo : (typeof repo === 'object' && repo != null && 'url' in repo ? String((repo as { url: unknown }).url) : null);\n    resObj.packages.push({\n      name,\n      version,\n      license: licenseValor,\n      repository,\n      private: !!data.private,\n      licenseArquivo: licenseArquivo ? licenseArquivo.file : null,\n      licenseText: licenseArquivo ? licenseArquivo.text : null,\n      path: pkgDir\n    });\n  }\n}\nexport async function fsReaddir(p: string): Promise<string[]> {\n  const fs = await import('node:fs');\n  return fs.promises.readdir(p, {\n    withFileTypes: false\n  }).catch(() => []);\n}\nasync function fsStatIsDir(p: string): Promise<boolean> {\n  const fs = await import('node:fs');\n  try {\n    const stat = await fs.promises.stat(p);\n    return stat.isDirectory();\n  } catch {\n    return false;\n  }\n}\nexport async function scanCommand(opts: ScanOptions = {}): Promise<ScanResult> {\n  const res = await scan(opts);\n  // Removido `: unknown` e `as unknown` — res.packages já é tipado corretamente\n  const problematic = res.packages.filter(p => p.license === 'UNKNOWN');\n  res.problematic = problematic;\n  return res;\n}"]}