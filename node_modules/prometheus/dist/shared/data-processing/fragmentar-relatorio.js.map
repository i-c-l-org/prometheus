{"version":3,"file":"fragmentar-relatorio.js","sourceRoot":"","sources":["../../../src/shared/data-processing/fragmentar-relatorio.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT-0\nimport path from 'node:path';\nimport { gzipSync } from 'node:zlib';\n\nimport { config } from '@core/config/config.js';\nimport { salvarBinario, salvarEstado } from '@shared/persistence/persistencia.js';\n\nimport type { FileEntryFragmentacao, FragmentOptions, Manifest, ManifestPartFragmentacao, Ocorrencia, RelatorioCompletoFragmentacao } from '@';\n\n// Aliases para compatibilidade\ntype FileEntry = FileEntryFragmentacao;\ntype ManifestPart = ManifestPartFragmentacao;\ntype RelatorioCompleto = RelatorioCompletoFragmentacao;\n\n// Re-exporta os tipos para compatibilidade\nexport type { FileEntry, FragmentOptions, Manifest, ManifestPart, RelatorioCompleto };\nfunction chunkArray<T>(arr: T[], size: number): T[][] {\n  const out: T[][] = [];\n  for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));\n  return out;\n}\nexport async function fragmentarRelatorio(relatorioFull: RelatorioCompleto, dir: string, ts: string, options?: FragmentOptions): Promise<{\n  manifestFile: string;\n  manifest: Manifest;\n}> {\n  const maxOcorrencias = options?.maxOcorrenciasPerShard ?? config.REPORT_FRAGMENT_OCCURRENCES ?? 2000;\n  const maxArquivoEntries = options?.maxFileEntriesPerShard ?? config.REPORT_FRAGMENT_FILEENTRIES ?? 500;\n  const topN = config.REPORT_FRAGMENT_SUMMARY_TOPN ?? 5;\n\n  // Normaliza a estrutura esperada\n  const rel = relatorioFull as Record<string, unknown>;\n  const resultado = rel && 'resultado' in rel ? rel.resultado as Record<string, unknown> : rel as Record<string, unknown>;\n  const ocorrencias: Ocorrencia[] = resultado && Array.isArray((resultado as Record<string, unknown>).ocorrencias) ? (resultado as Record<string, unknown>).ocorrencias as Ocorrencia[] : [];\n  const fileEntries: FileEntry[] = resultado && Array.isArray((resultado as Record<string, unknown>).fileEntries) ? (resultado as Record<string, unknown>).fileEntries as FileEntry[] : [];\n  const salvar = salvarEstado;\n\n  // Manifest que descreve as partes geradas\n  const manifest: Manifest = {\n    generatedAt: new Date().toISOString(),\n    baseNome: `prometheus-relatorio-full-${ts}`,\n    parts: []\n  };\n\n  // Salva meta (tudo exceto ocorrencias/fileEntries)\n  const meta = {\n    ...rel\n  } as Record<string, unknown>;\n  if (meta.resultado && typeof meta.resultado === 'object') {\n    const r = meta.resultado as Record<string, unknown>;\n    delete r.ocorrencias;\n    delete r.fileEntries;\n  }\n  const metaFilename = `prometheus-relatorio-full-${ts}-meta.json.gz`;\n  const metaBuf = Buffer.from(JSON.stringify(meta, null, 2), 'utf-8');\n  const metaGz = gzipSync(metaBuf);\n  await salvarBinario(path.join(dir, metaFilename), metaGz);\n  manifest.parts.push({\n    kind: 'meta',\n    file: metaFilename,\n    bytes: metaGz.length\n  });\n\n  // Fragmenta ocorrencias se necessário\n  if (ocorrencias.length > 0) {\n    const occPedacos = chunkArray(ocorrencias, maxOcorrencias);\n    for (let i = 0; i < occPedacos.length; i++) {\n      const fname = `prometheus-relatorio-full-${ts}-ocorrencias-part-${i + 1}.json.gz`;\n      const payload = {\n        shard: {\n          kind: 'ocorrencias',\n          index: i + 1,\n          total: occPedacos.length\n        },\n        count: occPedacos[i].length,\n        ocorrencias: occPedacos[i]\n      };\n      const buf = Buffer.from(JSON.stringify(payload, null, 2), 'utf-8');\n      const gz = gzipSync(buf);\n      await salvarBinario(path.join(dir, fname), gz);\n\n      // Gerar resumo por shard: top tipos e top arquivos (relPath)\n      const tiposContagem: Record<string, number> = {};\n      const arquivosContagem: Record<string, number> = {};\n      for (const o of occPedacos[i] as Ocorrencia[]) {\n        // Suporta formatos legados com 'type' e 'path' para compatibilidade\n        const oLegacy = o as Ocorrencia & {\n          type?: string;\n          path?: string;\n        };\n        const t = o && (o.tipo || oLegacy.type) ? String(o.tipo ?? oLegacy.type) : 'desconhecido';\n        tiposContagem[t] = (tiposContagem[t] || 0) + 1;\n        const relp = o && (o.relPath || oLegacy.path) ? String(o.relPath ?? oLegacy.path) : 'desconhecido';\n        arquivosContagem[relp] = (arquivosContagem[relp] || 0) + 1;\n      }\n      const topTipos = Object.entries(tiposContagem).sort((a, b) => b[1] - a[1]).slice(0, topN).map(([k, v]) => ({\n        tipo: k,\n        count: v\n      }));\n      const topArquivos = Object.entries(arquivosContagem).sort((a, b) => b[1] - a[1]).slice(0, topN).map(([k, v]) => ({\n        arquivo: k,\n        count: v\n      }));\n      manifest.parts.push({\n        kind: 'ocorrencias',\n        file: fname,\n        index: i + 1,\n        total: occPedacos.length,\n        count: occPedacos[i].length,\n        bytes: gz.length,\n        summary: {\n          topTipos,\n          topArquivos\n        }\n      });\n    }\n  }\n\n  // Fragmenta fileEntries (ASTs) se necessário\n  if (fileEntries.length > 0) {\n    const fePedacos = chunkArray(fileEntries, maxArquivoEntries);\n    for (let i = 0; i < fePedacos.length; i++) {\n      const fname = `prometheus-relatorio-full-${ts}-fileentries-part-${i + 1}.json.gz`;\n      const payload = {\n        shard: {\n          kind: 'fileEntries',\n          index: i + 1,\n          total: fePedacos.length\n        },\n        count: fePedacos[i].length,\n        fileEntries: fePedacos[i]\n      };\n      const buf = Buffer.from(JSON.stringify(payload, null, 2), 'utf-8');\n      const gz = gzipSync(buf);\n      await salvarBinario(path.join(dir, fname), gz);\n\n      // Resumo por shard de fileEntries: top arquivos por tamanho (linhas) quando possível\n      const arquivosResumo: Array<{\n        arquivo: string;\n        linhas?: number;\n      }> = [];\n      for (const fe of fePedacos[i] as FileEntry[]) {\n        // Suporta formato legado com 'path' para compatibilidade\n        const feLegacy = fe as FileEntry & {\n          path?: string;\n        };\n        const rel = fe && (fe.relPath || fe.fullCaminho || feLegacy.path) ? String(fe.relPath ?? fe.fullCaminho ?? feLegacy.path) : 'desconhecido';\n        let linhas: number | undefined = undefined;\n        try {\n          if (fe && typeof fe.content === 'string') linhas = fe.content.split(/\\r?\\n/).length;\n        } catch {}\n        arquivosResumo.push({\n          arquivo: rel,\n          linhas\n        });\n      }\n      const topArquivosByLinhas = arquivosResumo.filter(a => typeof a.linhas === 'number').sort((a, b) => (b.linhas ?? 0) - (a.linhas ?? 0)).slice(0, topN);\n      manifest.parts.push({\n        kind: 'fileEntries',\n        file: fname,\n        index: i + 1,\n        total: fePedacos.length,\n        count: fePedacos[i].length,\n        bytes: gz.length,\n        summary: {\n          topArquivosByLinhas\n        }\n      });\n    }\n  }\n\n  // Salva o manifest final\n  const manifestFilename = `prometheus-relatorio-full-${ts}-manifest.json`;\n  await salvar(path.join(dir, manifestFilename), manifest);\n  return {\n    manifestFile: manifestFilename,\n    manifest\n  };\n}\nexport default fragmentarRelatorio;"]}