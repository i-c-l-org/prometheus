{"version":3,"file":"reestruturacao-exporter.js","sourceRoot":"","sources":["../../../src/cli/handlers/reestruturacao-exporter.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT-0\n/**\n * Handler para exportação de relatórios de reestruturação\n * Consolida lógica duplicada de geração de relatórios Markdown e JSON\n */\n\nimport { promises as fs } from 'node:fs';\nimport path from 'node:path';\n\nimport { config } from '@core/config/config.js';\nimport { CliExportersMensagens } from '@core/messages/cli/cli-exporters-messages.js';\nimport { log } from '@core/messages/index.js';\nimport { gerarRelatorioReestruturarJson, gerarRelatorioReestruturarMarkdown } from '@relatorios/relatorio-reestruturar.js';\n\nimport type { MovimentoEstrutural, ReestruturacaoExportOptions, ReestruturacaoExportResult } from '@';\n\n// Re-export para compatibilidade\nexport type { ReestruturacaoExportOptions, ReestruturacaoExportResult };\n\n/**\n * Normaliza movimentos para formato padrão MovimentoEstrutural\n */\nfunction normalizarMovimentos(movimentos: ReestruturacaoExportOptions['movimentos']): MovimentoEstrutural[] {\n  return movimentos.map(m => {\n    // Se tem 'de' e 'para', já está no formato correto (PlanoMoverItem)\n    if ('de' in m && 'para' in m) {\n      return {\n        de: m.de,\n        para: m.para\n      };\n    }\n    // Se tem 'atual' e 'ideal', é MapaMoveItem - converter\n    if ('atual' in m && 'ideal' in m) {\n      return {\n        de: m.atual,\n        para: m.ideal ?? m.atual\n      };\n    }\n    // Fallback: retornar objeto vazio (não deve acontecer com tipos corretos)\n    return {\n      de: '',\n      para: ''\n    };\n  });\n}\n\n/**\n * Exporta relatórios de reestruturação (Markdown e JSON)\n *\n * Centraliza a lógica de:\n * - Criação de diretório de relatórios\n * - Geração de timestamp único\n * - Exportação em ambos os formatos\n * - Tratamento de erros\n *\n * @param options - Opções de exportação\n * @returns Caminhos dos arquivos gerados ou null em caso de erro\n */\nexport async function exportarRelatoriosReestruturacao(options: ReestruturacaoExportOptions): Promise<ReestruturacaoExportResult | null> {\n  if (!config.REPORT_EXPORT_ENABLED) {\n    return null;\n  }\n  try {\n    const {\n      baseDir,\n      movimentos,\n      simulado,\n      origem,\n      preset,\n      conflitos\n    } = options;\n\n    // Determinar diretório de saída\n    const dir = typeof config.REPORT_OUTPUT_DIR === 'string' ? config.REPORT_OUTPUT_DIR : path.join(baseDir, 'relatorios');\n\n    // Criar diretório se não existir\n    await fs.mkdir(dir, {\n      recursive: true\n    });\n\n    // Gerar timestamp único para os arquivos\n    const ts = new Date().toISOString().replace(/[:.]/g, '-');\n    const nomeBase = `prometheus-reestruturacao-${ts}`;\n\n    // Normalizar movimentos para formato padrão\n    const movimentosNormalizados = normalizarMovimentos(movimentos);\n\n    // Gerar relatório Markdown\n    const caminhoMd = path.join(dir, `${nomeBase}.md`);\n    await gerarRelatorioReestruturarMarkdown(caminhoMd, movimentosNormalizados, {\n      simulado,\n      origem,\n      preset,\n      conflitos\n    });\n\n    // Gerar relatório JSON\n    const caminhoJson = path.join(dir, `${nomeBase}.json`);\n    await gerarRelatorioReestruturarJson(caminhoJson, movimentosNormalizados, {\n      simulado,\n      origem,\n      preset,\n      conflitos\n    });\n\n    // Log de sucesso\n    const modo = simulado ? '(dry-run) ' : '';\n    log.sucesso(CliExportersMensagens.reestruturacao.relatoriosExportados(modo, dir));\n    return {\n      markdown: caminhoMd,\n      json: caminhoJson,\n      dir\n    };\n  } catch (error) {\n    const modo = options.simulado ? '(dry-run) ' : '';\n    log.erro(CliExportersMensagens.reestruturacao.falhaExportar(modo, (error as Error).message));\n    return null;\n  }\n}"]}