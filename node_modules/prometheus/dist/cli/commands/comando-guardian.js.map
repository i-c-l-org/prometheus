{"version":3,"file":"comando-guardian.js","sourceRoot":"","sources":["../../../src/cli/commands/comando-guardian.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT-0\n// @prometheus-disable tipo-literal-inline-complexo\n// Justificativa: tipos inline para opções de comando CLI são locais e não precisam de extração\n// Importar handler modular do Guardian (Sprint 2)\n// Registro de analistas será carregado dinamicamente para permitir injeção de dependências\nimport { executarGuardian as executarGuardianModular, type GuardianOptions } from '@cli/diagnostico/handlers/guardian-handler.js';\nimport { ExitCode, sair } from '@cli/helpers/exit-codes.js';\nimport { config } from '@core/config/config.js';\nimport { iniciarInquisicao } from '@core/execution/inquisidor.js';\nimport { CliComandoGuardianMensagens } from '@core/messages/cli/cli-comando-guardian-messages.js';\nimport { log, logGuardian } from '@core/messages/index.js';\nimport { acceptNewBaseline } from '@guardian/sentinela.js';\nimport { Command } from 'commander';\n\nimport type { FileEntry, FileEntryWithAst, Tecnica } from '@';\nimport { asTecnicas, extrairMensagemErro, IntegridadeStatus } from '@';\n\nexport function comandoGuardian(aplicarFlagsGlobais: (opts: Record<string, unknown>) => void): Command {\n  return new Command('guardian')\n    .description(CliComandoGuardianMensagens.descricao)\n    // Alinhar com comportamento tolerante usado em outros comandos/testes\n    .allowUnknownOption(true)\n    .allowExcessArguments(true)\n    .option('-a, --accept-baseline', CliComandoGuardianMensagens.opcoes.acceptBaseline)\n    .option('-d, --diff', CliComandoGuardianMensagens.opcoes.diff)\n    .option('--full-scan', CliComandoGuardianMensagens.opcoes.fullScan)\n    .option('--json', CliComandoGuardianMensagens.opcoes.json)\n    .action(async function (this: Command, opts: {\n    acceptBaseline?: boolean;\n    diff?: boolean;\n    fullScan?: boolean;\n    json?: boolean;\n  }) {\n    try {\n      await aplicarFlagsGlobais(this.parent && typeof this.parent.opts === 'function' ? this.parent.opts() : {});\n    } catch (err) {\n      log.erro(CliComandoGuardianMensagens.erroFlags(err instanceof Error ? err.message : String(err)));\n      sair(ExitCode.Failure);\n      return;\n    }\n    const baseDir = process.cwd();\n    let fileEntries: FileEntryWithAst[] = [];\n    try {\n      // Carrega registro de analistas no momento da execução\n      const { registroAnalistas } = await import('@analistas/registry/registry.js');\n      const tecnicas = asTecnicas(registroAnalistas as Tecnica[]);\n      const resultadoInquisicao = await iniciarInquisicao(baseDir, {\n        incluirMetadados: false\n      }, tecnicas);\n      fileEntries = resultadoInquisicao.fileEntries;\n      const ignoradosOriginaisRaw = (config as {\n        GUARDIAN_IGNORE_PATTERNS?: string[];\n      }).GUARDIAN_IGNORE_PATTERNS;\n      const ignoradosOriginais = Array.isArray(ignoradosOriginaisRaw) ? [...ignoradosOriginaisRaw] : [];\n      if (opts.fullScan) {\n        // Temporariamente desabilita padrões ignorados\n        (config as unknown as {\n          GUARDIAN_IGNORE_PATTERNS: string[];\n        }).GUARDIAN_IGNORE_PATTERNS = [];\n        if (!opts.acceptBaseline) {\n          logGuardian.fullScanAviso();\n        }\n      }\n      if (opts.acceptBaseline) {\n        if (opts.fullScan) {\n          log.aviso(CliComandoGuardianMensagens.baselineNaoPermitidoFullScan);\n          (config as unknown as {\n            GUARDIAN_IGNORE_PATTERNS: string[];\n          }).GUARDIAN_IGNORE_PATTERNS = ignoradosOriginais;\n          sair(ExitCode.Failure);\n          return;\n        }\n        logGuardian.aceitandoBaseline();\n        await acceptNewBaseline(fileEntries);\n        if (opts.json) {\n          console.log(JSON.stringify({\n            status: IntegridadeStatus.Aceito,\n            baseline: true\n          }));\n        } else {\n          logGuardian.baselineAceitoSucesso();\n        }\n      } else {\n        // REFATORADO: Usar handler modular do Guardian\n        const guardianOpts: GuardianOptions = {\n          enabled: true,\n          fullScan: Boolean(opts.fullScan),\n          saveBaseline: false,\n          silent: Boolean(opts.json)\n        };\n        const guardianResultado = await executarGuardianModular(fileEntries.map(e => ({\n          relPath: e.relPath,\n          fullCaminho: e.fullCaminho,\n          content: e.content\n        })) as FileEntry[], guardianOpts);\n\n        // Processar resultado baseado no modo\n        if (opts.diff) {\n          // Modo diff: mostrar diferenças\n          if (guardianResultado.drift && guardianResultado.drift > 0) {\n            if (opts.json) {\n              console.log(JSON.stringify({\n                status: 'alteracoes-detectadas',\n                drift: guardianResultado.drift\n              }));\n            } else {\n              logGuardian.diferencasDetectadas();\n              log.aviso(CliComandoGuardianMensagens.diffMudancasDetectadas(guardianResultado.drift));\n              log.aviso(CliComandoGuardianMensagens.diffComoAceitarMudancas);\n            }\n            sair(ExitCode.Failure);\n            return;\n          } else {\n            if (opts.json) {\n              console.log(JSON.stringify({\n                status: 'ok',\n                drift: 0\n              }));\n            } else {\n              logGuardian.integridadePreservada();\n            }\n          }\n        } else {\n          // Modo normal: verificar integridade\n          const statusNorm = guardianResultado.status || IntegridadeStatus.Ok;\n          switch (statusNorm) {\n            case IntegridadeStatus.Ok:\n              if (opts.json) console.log(JSON.stringify({\n                status: 'ok',\n                cacheDiffHits: (globalThis as unknown as {\n                  __PROMETHEUS_DIFF_CACHE_HITS__?: number;\n                }).__PROMETHEUS_DIFF_CACHE_HITS__ || 0\n              }));else logGuardian.integridadeOk();\n              break;\n            case IntegridadeStatus.Criado:\n              if (opts.json) console.log(JSON.stringify({\n                status: 'baseline-criado',\n                cacheDiffHits: (globalThis as unknown as {\n                  __PROMETHEUS_DIFF_CACHE_HITS__?: number;\n                }).__PROMETHEUS_DIFF_CACHE_HITS__ || 0\n              }));else logGuardian.baselineCriadoConsole();\n              log.aviso(CliComandoGuardianMensagens.baselineCriadoComoAceitar);\n              break;\n            case IntegridadeStatus.Aceito:\n              if (opts.json) console.log(JSON.stringify({\n                status: 'baseline-aceito',\n                cacheDiffHits: (globalThis as unknown as {\n                  __PROMETHEUS_DIFF_CACHE_HITS__?: number;\n                }).__PROMETHEUS_DIFF_CACHE_HITS__ || 0\n              }));else logGuardian.baselineAtualizado();\n              break;\n            case IntegridadeStatus.AlteracoesDetectadas:\n              {\n                if (opts.json) {\n                  console.log(JSON.stringify({\n                    status: 'alteracoes-detectadas',\n                    temProblemas: guardianResultado.temProblemas,\n                    drift: guardianResultado.drift\n                  }));\n                } else {\n                  logGuardian.alteracoesSuspeitas();\n                }\n                sair(ExitCode.Failure);\n                return;\n              }\n          }\n        }\n      }\n      if (opts.fullScan) {\n        // Restaura padrões originais após execução\n        (config as unknown as {\n          GUARDIAN_IGNORE_PATTERNS: string[];\n        }).GUARDIAN_IGNORE_PATTERNS = ignoradosOriginais;\n      }\n    } catch (err) {\n      logGuardian.erroGuardian((err as Error).message ?? String(err));\n      if (config.DEV_MODE) {\n        console.error(extrairMensagemErro(err));\n        if (err && typeof err === 'object' && 'stack' in err) {\n          console.error((err as {\n            stack?: string;\n          }).stack);\n        }\n      }\n      if (opts.json) console.log(JSON.stringify({\n        status: 'erro',\n        mensagem: extrairMensagemErro(err)\n      }));\n      sair(ExitCode.Failure);\n      return;\n    }\n  });\n}"]}