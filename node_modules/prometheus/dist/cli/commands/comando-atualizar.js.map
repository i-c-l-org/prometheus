{"version":3,"file":"comando-atualizar.js","sourceRoot":"","sources":["../../../src/cli/commands/comando-atualizar.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n// Registro de analistas será carregado dinamicamente para permitir injeção de dependências\nimport { ExitCode, sair } from '@cli/helpers/exit-codes.js';\nimport chalk from '@core/config/chalk-safe.js';\nimport { config } from '@core/config/config.js';\nimport { iniciarInquisicao } from '@core/execution/inquisidor.js';\nimport { CliComandoAtualizarMensagens } from '@core/messages/cli/cli-comando-atualizar-messages.js';\nimport { ICONES_DIAGNOSTICO, log, logSistema } from '@core/messages/index.js';\nimport { executarShellSeguro } from '@core/utils/exec-safe.js';\nimport { scanSystemIntegrity } from '@guardian/sentinela.js';\nimport { Command } from 'commander';\n\nimport type { FileEntryWithAst, Tecnica } from '@';\nimport { asTecnicas } from '@';\n\nexport function comandoAtualizar(\n  aplicarFlagsGlobais: (opts: Record<string, unknown>) => void,\n): Command {\n  return new Command('atualizar')\n    .description(CliComandoAtualizarMensagens.descricao)\n    .option('--global', CliComandoAtualizarMensagens.opcoes.global)\n    .action(async function (this: Command, opts: { global?: boolean }) {\n      try {\n        await aplicarFlagsGlobais(\n          this.parent && typeof this.parent.opts === 'function'\n            ? this.parent.opts()\n            : {},\n        );\n      } catch (err) {\n        log.erro(CliComandoAtualizarMensagens.erros.falhaFlags(err instanceof Error ? err.message : String(err)));\n        sair(ExitCode.Failure);\n        return;\n      }\n\n      log.info(chalk.bold(CliComandoAtualizarMensagens.status.inicio));\n\n      const baseDir = process.cwd();\n      let fileEntries: FileEntryWithAst[] = [];\n\n      try {\n        // Carrega registro de analistas no momento da execução\n        const { registroAnalistas } = await import('@analistas/registry/registry.js');\n        const tecnicas = asTecnicas(registroAnalistas as Tecnica[]);\n        const resultado = await iniciarInquisicao(baseDir, {\n          incluirMetadados: false,\n        }, tecnicas);\n        fileEntries = resultado.fileEntries;\n\n        const guardianResultado = await scanSystemIntegrity(fileEntries);\n\n        if (\n          guardianResultado.status ===\n            ('ok' as typeof guardianResultado.status) ||\n          guardianResultado.status ===\n            ('baseline-aceito' as typeof guardianResultado.status)\n        ) {\n          log.sucesso(CliComandoAtualizarMensagens.status.guardianOk(ICONES_DIAGNOSTICO.sucesso));\n        } else {\n          log.aviso(CliComandoAtualizarMensagens.status.guardianAviso);\n          log.info(CliComandoAtualizarMensagens.status.guardianDica);\n        }\n\n        const cmd = opts.global\n          ? 'npm install -g prometheus@latest'\n          : 'npm install prometheus@latest';\n\n        logSistema.atualizacaoExecutando(cmd);\n        executarShellSeguro(cmd, { stdio: 'inherit' });\n\n        logSistema.atualizacaoSucesso();\n      } catch (err: unknown) {\n        logSistema.atualizacaoFalha();\n        if (\n          typeof err === 'object' &&\n          err &&\n          'detalhes' in err &&\n          Array.isArray((err as { detalhes?: unknown }).detalhes)\n        ) {\n          (err as { detalhes: string[] }).detalhes.forEach((d: string) => {\n            logSistema.atualizacaoDetalhes(d);\n          });\n        }\n        if (config.DEV_MODE)\n          log.erro(err instanceof Error ? err.message : String(err));\n        // Em ambiente de teste (Vitest), n\\u00e3o encerre o processo para n\\u00e3o derrubar o runner\n        sair(ExitCode.Failure);\n        return;\n      }\n    });\n}\n"]}