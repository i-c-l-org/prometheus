{"version":3,"file":"comando-metricas.js","sourceRoot":"","sources":["../../../src/cli/commands/comando-metricas.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n// @prometheus-disable tipo-literal-inline-complexo\n// @prometheus-disable PROBLEMA_PERFORMANCE\n// Justificativa: tipos inline para opções de comando CLI são locais e não precisam de extração\nimport path from 'node:path';\n\nimport { ExitCode, sair } from '@cli/helpers/exit-codes.js';\nimport { config } from '@core/config/config.js';\nimport { formatMs } from '@core/config/format.js';\nimport { CliComandoMetricasMensagens } from '@core/messages/cli/cli-comando-metricas-messages.js';\nimport { ICONES_DIAGNOSTICO, log, logMetricas } from '@core/messages/index.js';\nimport { lerEstado, salvarEstado } from '@shared/persistence/persistencia.js';\nimport { Command } from 'commander';\n\nimport type { MetricaExecucao } from '@';\n\ninterface RegistroHistorico extends MetricaExecucao {\n  timestamp: number;\n}\nconst formatarDuracao = (ms: number) => formatMs(ms);\nfunction agregados(historico: RegistroHistorico[]) {\n  if (!historico.length) return null;\n  const total = historico.length;\n  const somaAnalise = historico.reduce((acc, h) => acc + (h.tempoAnaliseMs ?? 0), 0);\n  const somaParsing = historico.reduce((acc, h) => acc + (h.tempoParsingMs ?? 0), 0);\n  const analistasMap = new Map<string, {\n    totalMs: number;\n    execucoes: number;\n    ocorrencias: number;\n  }>();\n  for (const h of historico) {\n    if (!h.analistas) continue;\n    for (const a of h.analistas) {\n      const dado = analistasMap.get(a.nome) || {\n        totalMs: 0,\n        execucoes: 0,\n        ocorrencias: 0\n      };\n      dado.totalMs += a.duracaoMs;\n      dado.execucoes += 1;\n      dado.ocorrencias += a.ocorrencias;\n      analistasMap.set(a.nome, dado);\n    }\n  }\n  const analistasOrdenados = [...analistasMap.entries()].sort((a, b) => b[1].totalMs - a[1].totalMs).slice(0, 5).map(([nome, d]) => ({\n    nome,\n    totalMs: d.totalMs,\n    mediaMs: d.totalMs / d.execucoes,\n    execucoes: d.execucoes,\n    ocorrencias: d.ocorrencias\n  }));\n  return {\n    totalExecucoes: total,\n    mediaAnaliseMs: somaAnalise / total,\n    mediaParsingMs: somaParsing / total,\n    topAnalistas: analistasOrdenados\n  };\n}\nexport function comandoMetricas(): Command {\n  return new Command('metricas')\n    .description(CliComandoMetricasMensagens.descricao)\n    .option('-j, --json', CliComandoMetricasMensagens.opcoes.json)\n    .option('-l, --limite <n>', CliComandoMetricasMensagens.opcoes.limite, v => Number(v), 10)\n    .option('-e, --export <arquivo>', CliComandoMetricasMensagens.opcoes.export)\n    .option('-a, --analistas', CliComandoMetricasMensagens.opcoes.analistas)\n    .action(async (opts: {\n    json?: boolean;\n    limite?: number;\n    export?: string;\n    analistas?: boolean;\n  }) => {\n    try {\n      const caminho = config.ANALISE_METRICAS_HISTORICO_PATH;\n      const historico = await lerEstado<RegistroHistorico[]>(caminho).catch(() => []);\n      const lista = Array.isArray(historico) ? historico : [];\n      const ultimos = opts.limite ? lista.slice(-opts.limite) : lista;\n      const agg = agregados(lista) || undefined;\n      if (opts.export) {\n        const destino = path.isAbsolute(opts.export) ? opts.export : path.join(process.cwd(), opts.export);\n        await salvarEstado(destino, {\n          exportadoEm: new Date().toISOString(),\n          total: lista.length,\n          historico: lista\n        });\n        log.sucesso(CliComandoMetricasMensagens.historicoExportado(destino));\n        return;\n      }\n      if (opts.json) {\n        // Emite JSON puro (sem prefixos de log) para facilitar piping / CI\n        console.log(JSON.stringify({\n          total: lista.length,\n          limite: opts.limite,\n          historico: ultimos,\n          agregados: agg\n        }, null, 2));\n        return;\n      }\n      logMetricas.execucoesRegistradas(lista.length);\n      if (!lista.length) {\n        logMetricas.nenhumHistorico();\n        return;\n      }\n      for (const h of ultimos) {\n        const timestampISO = new Date(h.timestamp).toISOString();\n        log.info(CliComandoMetricasMensagens.linhaExecucao(timestampISO, h.totalArquivos ?? 0, formatarDuracao(h.tempoAnaliseMs ?? 0), formatarDuracao(h.tempoParsingMs ?? 0), h.cacheAstHits ?? 0, h.cacheAstMiss ?? 0));\n      }\n      if (opts.analistas && agg) {\n        log.info(CliComandoMetricasMensagens.linhaEmBranco);\n        log.info(CliComandoMetricasMensagens.tituloTopAnalistas(ICONES_DIAGNOSTICO.info));\n        for (const a of agg.topAnalistas) {\n          log.info(CliComandoMetricasMensagens.linhaTopAnalista(a.nome, formatMs(a.totalMs), formatMs(a.mediaMs), a.execucoes, a.ocorrencias));\n        }\n      }\n      if (agg) {\n        log.info(CliComandoMetricasMensagens.medias(formatMs(agg.mediaAnaliseMs), formatMs(agg.mediaParsingMs)));\n      }\n    } catch (err) {\n      log.erro(CliComandoMetricasMensagens.erroProcessar(err instanceof Error ? err.message : String(err)));\n      sair(ExitCode.Failure);\n    }\n  });\n}"]}