{"version":3,"file":"comando-podar.js","sourceRoot":"","sources":["../../../src/cli/commands/comando-podar.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT-0\n\nimport { removerArquivosOrfaos } from '@analistas/corrections/poda.js';\n// Registro de analistas ser√° carregado dinamicamente para permitir inje√ß√£o de depend√™ncias\nimport { exportarRelatoriosPoda } from '@cli/handlers/poda-exporter.js';\nimport { ExitCode, sair } from '@cli/helpers/exit-codes.js';\nimport { expandIncludePatterns, processPatternList } from '@cli/helpers/pattern-helpers.js';\nimport chalk from '@core/config/chalk-safe.js';\nimport { config } from '@core/config/config.js';\nimport { iniciarInquisicao } from '@core/execution/inquisidor.js';\nimport { CliComandoPodarMensagens } from '@core/messages/cli/cli-comando-podar-messages.js';\nimport { ICONES_DIAGNOSTICO, log, logSistema } from '@core/messages/index.js';\nimport { Command } from 'commander';\n\nimport type { ArquivoFantasma, ResultadoPoda, Tecnica } from '@';\nimport { asTecnicas } from '@';\n\nexport function comandoPodar(aplicarFlagsGlobais: (opts: Record<string, unknown>) => void): Command {\n  return new Command('podar')\n    .description(CliComandoPodarMensagens.descricao)\n    .option('-f, --force', CliComandoPodarMensagens.opcoes.force, false)\n    .option('--include <padrao>', CliComandoPodarMensagens.opcoes.include, (val: string, prev: string[]) => {\n      prev.push(val);\n      return prev;\n    }, [] as string[])\n    .option('--exclude <padrao>', CliComandoPodarMensagens.opcoes.exclude, (val: string, prev: string[]) => {\n      prev.push(val);\n      return prev;\n    }, [] as string[])\n    .action(async function (this: Command, opts: {\n    force?: boolean;\n    include?: string[];\n    exclude?: string[];\n  }) {\n    try {\n      await aplicarFlagsGlobais(this.parent && typeof this.parent.opts === 'function' ? this.parent.opts() : {});\n    } catch (err) {\n      const msg = err instanceof Error ? err.message : String(err);\n      log.erro(CliComandoPodarMensagens.erroDurantePoda(msg));\n      sair(ExitCode.Failure);\n      return;\n    }\n    log.info(chalk.bold(CliComandoPodarMensagens.inicio));\n    const baseDir = process.cwd();\n    try {\n      // Normaliza padr√µes de include/exclude para sincronizar filtros com o scanner\n      const includeListRaw = processPatternList(opts.include);\n      const includeList = includeListRaw.length ? expandIncludePatterns(includeListRaw) : [];\n      const excludeList = processPatternList(opts.exclude);\n      if (includeList.length) config.CLI_INCLUDE_PATTERNS = includeList;\n      if (excludeList.length) config.CLI_EXCLUDE_PATTERNS = excludeList;\n\n      // üî• SIMPLIFICADO: sem sync de padr√µes obsoletos\n      // CLI flags dominam globalExcludeGlob automaticamente\n\n      // Carrega registro de analistas na camada CLI (inje√ß√£o de depend√™ncias)\n      const { registroAnalistas } = await import('@analistas/registry/registry.js');\n      const tecnicas = asTecnicas(registroAnalistas as Tecnica[]);\n      const {\n        fileEntries\n      } = await iniciarInquisicao(baseDir, {\n        incluirMetadados: false\n      }, tecnicas);\n      const resultadoPoda: ResultadoPoda = await removerArquivosOrfaos(fileEntries);\n      if (resultadoPoda.arquivosOrfaos.length === 0) {\n        log.sucesso(CliComandoPodarMensagens.nenhumaSujeira(ICONES_DIAGNOSTICO.sucesso));\n        await exportarRelatoriosPoda({\n          baseDir,\n          podados: [],\n          pendentes: [],\n          simulado: !opts.force\n        });\n        return;\n      }\n      log.aviso(CliComandoPodarMensagens.orfaosDetectados(resultadoPoda.arquivosOrfaos.length));\n      resultadoPoda.arquivosOrfaos.forEach((file: ArquivoFantasma) => {\n        log.info(CliComandoPodarMensagens.linhaArquivoOrfao(file.arquivo));\n      });\n      if (!opts.force) {\n        const readline = await import('node:readline/promises');\n        const rl = readline.createInterface({\n          input: process.stdin,\n          output: process.stdout\n        });\n        const answer = await rl.question(chalk.yellow(CliComandoPodarMensagens.confirmarRemocao));\n        rl.close();\n\n        // debug removido (usava console.log) ‚Äì manter somente se modo debug ativo futuramente\n        if (answer.toLowerCase() !== 's') {\n          logSistema.podaCancelada();\n          return;\n        }\n      }\n\n      // S√≥ remove se confirmado\n      // --force: remove direto\n      if (opts.force) {\n        await removerArquivosOrfaos(fileEntries);\n        logSistema.podaConcluida();\n        const podados = resultadoPoda.arquivosOrfaos.map(f => ({\n          arquivo: f.arquivo,\n          motivo: f.referenciado ? 'inativo' : '√≥rf√£o',\n          detectedAt: Date.now(),\n          scheduleAt: Date.now()\n        }));\n        await exportarRelatoriosPoda({\n          baseDir,\n          podados,\n          pendentes: [],\n          simulado: false\n        });\n      }\n    } catch (error) {\n      const errMsg = typeof error === 'object' && error && 'message' in error ? (error as {\n        message: string;\n      }).message : String(error);\n      log.erro(CliComandoPodarMensagens.erroDurantePoda(errMsg));\n      if (config.DEV_MODE) console.error(error);\n      sair(ExitCode.Failure);\n      return;\n    }\n  });\n}"]}