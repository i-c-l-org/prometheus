{"version":3,"file":"guardian-handler.js","sourceRoot":"","sources":["../../../../src/cli/diagnostico/handlers/guardian-handler.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n/**\n * üõ°Ô∏è Guardian Handler\n *\n * Gerencia verifica√ß√£o de integridade do Guardian\n * - Executa scan de integridade\n * - Gerencia baseline\n * - Detecta drift\n * - Formata resultados\n */\n\nimport { MENSAGENS_GUARDIAN } from '@core/messages/core/diagnostico-messages.js';\nimport { logGuardian } from '@core/messages/log/log-helper.js';\nimport { scanSystemIntegrity } from '@guardian/sentinela.js';\n\nimport type {\n  FileEntry,\n  GuardianOptions,\n  GuardianResultadoProcessamento,\n} from '@';\nimport { IntegridadeStatus } from '@';\n\n// Re-export para compatibilidade (usando alias para nome antigo)\nexport type { GuardianOptions };\nexport type GuardianResult = GuardianResultadoProcessamento;\n\n/**\n * Executa verifica√ß√£o Guardian\n */\nexport async function executarGuardian(\n  entries: FileEntry[],\n  options: GuardianOptions,\n): Promise<GuardianResult> {\n  // Se desabilitado, retorna resultado vazio\n  if (!options.enabled) {\n    return {\n      executado: false,\n      temProblemas: false,\n    };\n  }\n\n  try {\n    // Log de in√≠cio (se n√£o silencioso)\n    if (!options.silent) {\n      logGuardian.info(MENSAGENS_GUARDIAN.iniciando);\n\n      if (options.fullScan) {\n        logGuardian.info(`  ${MENSAGENS_GUARDIAN.fullScan}`);\n      } else {\n        logGuardian.info(`  ${MENSAGENS_GUARDIAN.baseline}`);\n      }\n\n      if (options.saveBaseline) {\n        logGuardian.info(`  ${MENSAGENS_GUARDIAN.saveBaseline}`);\n      }\n    }\n\n    // Executar scan\n    const resultado = await scanSystemIntegrity(entries, {\n      suppressLogs: options.silent,\n    }); // Processar resultado\n    const status = resultado.status || IntegridadeStatus.Ok;\n    const drift = resultado.detalhes?.length || 0;\n    const temProblemas = status === IntegridadeStatus.AlteracoesDetectadas;\n\n    // Log de resultado (se n√£o silencioso)\n    if (!options.silent) {\n      switch (status) {\n        case IntegridadeStatus.Ok:\n          logGuardian.info(MENSAGENS_GUARDIAN.status.verde);\n          break;\n        case IntegridadeStatus.AlteracoesDetectadas:\n          logGuardian.aviso(MENSAGENS_GUARDIAN.status.amarelo);\n          break;\n        case IntegridadeStatus.Criado:\n        case IntegridadeStatus.Aceito:\n          logGuardian.info(MENSAGENS_GUARDIAN.status.verde);\n          break;\n      }\n\n      if (drift > 0) {\n        logGuardian.info(`  ${MENSAGENS_GUARDIAN.drift(drift)}`);\n      }\n    }\n\n    return {\n      executado: true,\n      resultado,\n      status,\n      drift,\n      temProblemas,\n    };\n  } catch (erro) {\n    const mensagem = erro instanceof Error ? erro.message : String(erro);\n\n    if (!options.silent) {\n      logGuardian.aviso(`Erro no Guardian: ${mensagem}`);\n    }\n\n    return {\n      executado: true,\n      temProblemas: true,\n    };\n  }\n}\n\n/**\n * Formata resultado Guardian para JSON\n */\nexport function formatarGuardianParaJson(\n  result: GuardianResult,\n): Record<string, unknown> {\n  if (!result.executado) {\n    return {\n      executado: false,\n      status: 'nao-verificado',\n    };\n  }\n\n  return {\n    executado: true,\n    status: result.status || 'desconhecido',\n    drift: result.drift || 0,\n    temProblemas: result.temProblemas,\n    detalhes: result.resultado\n      ? {\n          status: result.resultado.status,\n          detalhes: result.resultado.detalhes,\n          baselineModificado: result.resultado.baselineModificado,\n        }\n      : undefined,\n  };\n}\n\n/**\n * Determina exit code baseado no status Guardian\n */\nexport function getExitCodeGuardian(result: GuardianResult): number {\n  if (!result.executado || !result.status) {\n    return 0; // N√£o executado ou sem status = OK\n  }\n\n  switch (result.status) {\n    case IntegridadeStatus.Ok:\n    case IntegridadeStatus.Criado:\n    case IntegridadeStatus.Aceito:\n      return 0;\n    case IntegridadeStatus.AlteracoesDetectadas:\n      return 1;\n    default:\n      return 0;\n  }\n}\n"]}