{"version":3,"file":"sharded-exporter.js","sourceRoot":"","sources":["../../../../src/cli/diagnostico/exporters/sharded-exporter.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT-0\n// SPDX-FileCopyrightText: 2025 Prometheus Contributors\n// @prometheus-disable tipo-literal-inline-complexo\n// Justificativa: tipos locais para manipulação de shards\n\n/**\n * @module cli/diagnostico/exporters/sharded-exporter\n * @description Exportador que fragmenta relatórios grandes em múltiplos arquivos\n * @see docs/REFACTOR-CLI-DIAGNOSTICAR.md - Sprint 2\n */\n\nimport type {\n  DadosRelatorioMarkdown,\n  Ocorrencia,\n  RelatorioJson,\n  ResultadoSharding,\n  ShardInfo,\n  ShardingOptions,\n} from '@';\n\n// Re-export para compatibilidade\nexport type { ResultadoSharding, ShardInfo, ShardingOptions };\n\n  /* -------------------------- Função Principal -------------------------- */\n\n/**\n * Fragmenta relatório em múltiplos arquivos\n *\n * Esta função é um placeholder para implementação futura.\n * Por enquanto, retorna estrutura básica sem criar arquivos reais.\n */\nexport async function fragmentarRelatorio(\n  dados: Partial<RelatorioJson> | DadosRelatorioMarkdown,\n  options: ShardingOptions,\n): Promise<ResultadoSharding> {\n  const ocorrencias = dados.ocorrencias || [];\n  const totalOcorrencias = ocorrencias.length;\n\n  // Calcular número de shards necessários\n  const numShards = Math.ceil(totalOcorrencias / options.ocorrenciasPorShard);\n\n  // Se não precisa fragmentar, retornar shard único\n  if (numShards <= 1) {\n    return {\n      sucesso: true,\n      shards: [\n        {\n          arquivo: `${options.prefixo}-completo.${options.formato === 'json' ? 'json' : 'md'}`,\n          caminho: `${options.outputDir}/${options.prefixo}-completo.${options.formato === 'json' ? 'json' : 'md'}`,\n          indice: 0,\n          ocorrencias: totalOcorrencias,\n        },\n      ],\n      totalOcorrencias,\n      stats: {\n        shardsGerados: 1,\n        tamanhoMedio: totalOcorrencias,\n        tamanhoTotal: totalOcorrencias,\n      },\n    };\n  }\n\n  // Gerar informações dos shards\n  const shards: ShardInfo[] = [];\n\n  for (let i = 0; i < numShards; i++) {\n    const inicio = i * options.ocorrenciasPorShard;\n    const fim = Math.min(\n      inicio + options.ocorrenciasPorShard,\n      totalOcorrencias,\n    );\n    const ocorrenciasNoShard = fim - inicio;\n\n    shards.push({\n      arquivo: `${options.prefixo}-parte${i + 1}.${options.formato === 'json' ? 'json' : 'md'}`,\n      caminho: `${options.outputDir}/${options.prefixo}-parte${i + 1}.${options.formato === 'json' ? 'json' : 'md'}`,\n      indice: i,\n      ocorrencias: ocorrenciasNoShard,\n      range: { inicio, fim },\n    });\n  }\n\n  const tamanhoMedio = totalOcorrencias / numShards;\n\n  return {\n    sucesso: true,\n    shards,\n    indice: options.incluirIndice\n      ? `${options.outputDir}/${options.prefixo}-indice.${options.formato === 'json' ? 'json' : 'md'}`\n      : undefined,\n    totalOcorrencias,\n    stats: {\n      shardsGerados: numShards,\n      tamanhoMedio: Math.round(tamanhoMedio),\n      tamanhoTotal: totalOcorrencias,\n    },\n  };\n}\n\n  /* -------------------------- Helpers de Fragmentação -------------------------- */\n\n/**\n * Divide array de ocorrências em chunks\n */\nexport function dividirOcorrencias(\n  ocorrencias: Ocorrencia[],\n  tamanhoChunk: number,\n): Ocorrencia[][] {\n  const chunks: Ocorrencia[][] = [];\n\n  for (let i = 0; i < ocorrencias.length; i += tamanhoChunk) {\n    chunks.push(ocorrencias.slice(i, i + tamanhoChunk));\n  }\n\n  return chunks;\n}\n\n/**\n * Calcula estatísticas de fragmentação\n */\nexport function calcularEstatisticasFragmentacao(\n  ocorrencias: Ocorrencia[],\n  tamanhoShard: number,\n): {\n  numShards: number;\n  tamanhoMedio: number;\n  ultimoShardTamanho: number;\n} {\n  const numShards = Math.ceil(ocorrencias.length / tamanhoShard);\n  const tamanhoMedio = ocorrencias.length / numShards;\n  const ultimoShardTamanho = ocorrencias.length % tamanhoShard || tamanhoShard;\n\n  return {\n    numShards,\n    tamanhoMedio: Math.round(tamanhoMedio),\n    ultimoShardTamanho,\n  };\n}\n\n/**\n * Gera nome de arquivo para shard\n */\nexport function gerarNomeShard(\n  prefixo: string,\n  indice: number,\n  total: number,\n  formato: 'json' | 'markdown',\n): string {\n  const padding = total.toString().length;\n  const numeroFormatado = (indice + 1).toString().padStart(padding, '0');\n  const extensao = formato === 'json' ? 'json' : 'md';\n\n  return `${prefixo}-parte${numeroFormatado}-de${total}.${extensao}`;\n}\n\n/**\n * Gera conteúdo do índice consolidado\n */\nexport function gerarIndiceConsolidado(\n  shards: ShardInfo[],\n  formato: 'json' | 'markdown',\n): string {\n  if (formato === 'json') {\n    return JSON.stringify(\n      {\n        tipo: 'indice-shards',\n        timestamp: new Date().toISOString(),\n        shards: shards.map((s) => ({\n          arquivo: s.arquivo,\n          indice: s.indice,\n          ocorrencias: s.ocorrencias,\n          range: s.range,\n        })),\n        total: shards.reduce((sum, s) => sum + s.ocorrencias, 0),\n      },\n      null,\n      2,\n    );\n  }\n\n  // Markdown\n  let md = '# Índice de Relatório Fragmentado\\n\\n';\n  md += `*Gerado em: ${new Date().toLocaleString('pt-BR')}*\\n\\n`;\n  md += '## Fragmentos\\n\\n';\n  md += '| Parte | Arquivo | Ocorrências | Range |\\n';\n  md += '|-------|---------|-------------|-------|\\n';\n\n  for (const shard of shards) {\n    const range = shard.range\n      ? `${shard.range.inicio}-${shard.range.fim}`\n      : 'N/A';\n    md += `| ${shard.indice + 1} | ${shard.arquivo} | ${shard.ocorrencias} | ${range} |\\n`;\n  }\n\n  md += `\\n**Total**: ${shards.reduce((sum, s) => sum + s.ocorrencias, 0)} ocorrências\\n`;\n\n  return md;\n}\n\n  /* -------------------------- Validação -------------------------- */\n\n/**\n * Valida options de fragmentação\n */\nexport function validarOptionsSharding(options: Partial<ShardingOptions>): {\n  valido: boolean;\n  erros: string[];\n} {\n  const erros: string[] = [];\n\n  if (!options.formato) {\n    erros.push('Formato é obrigatório');\n  } else if (options.formato !== 'json' && options.formato !== 'markdown') {\n    erros.push('Formato deve ser \"json\" ou \"markdown\"');\n  }\n\n  if (!options.ocorrenciasPorShard || options.ocorrenciasPorShard <= 0) {\n    erros.push('ocorrenciasPorShard deve ser maior que 0');\n  }\n\n  if (!options.outputDir) {\n    erros.push('outputDir é obrigatório');\n  }\n\n  if (!options.prefixo) {\n    erros.push('prefixo é obrigatório');\n  }\n\n  return {\n    valido: erros.length === 0,\n    erros,\n  };\n}\n\n/**\n * Cria options padrão para fragmentação\n */\nexport function criarOptionsShardingPadrao(\n  overrides: Partial<ShardingOptions> = {},\n): ShardingOptions {\n  return {\n    formato: 'json',\n    ocorrenciasPorShard: 1000,\n    outputDir: './relatorios',\n    prefixo: 'diagnostico',\n    incluirIndice: true,\n    incluirMetadataEmShards: true,\n    ...overrides,\n  };\n}\n"]}