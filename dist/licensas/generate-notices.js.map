{"version":3,"file":"generate-notices.js","sourceRoot":"","sources":["../../src/licensas/generate-notices.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT-0\nimport { exec as _exec, execFile as _execFile } from 'node:child_process';\nimport fs from 'node:fs/promises';\nimport path from 'node:path';\nimport { promisify } from 'node:util';\n\nconst exec = promisify(_exec);\nconst execFile = promisify(_execFile);\nfunction s(v: string | string[] | number | boolean | null | undefined): string {\n  return v == null ? '' : String(v);\n}\nfunction nl(txt: string): string {\n  return txt.replace(/\\r\\n?|\\n/g, '\\n');\n}\ninterface HeaderOptions {\n  projectNome: string;\n  license: string;\n  ptBr: boolean;\n}\nfunction header({\n  projectNome,\n  license,\n  ptBr\n}: HeaderOptions): string {\n  const now = new Date().toISOString();\n  if (ptBr) {\n    return ['AVISOS DE TERCEIROS', '====================', '', `${projectNome} — Licença do projeto: ${license}`, `Este arquivo lista componentes de terceiros incluídos (produção) e seus respectivos avisos/licenças.`, `Gerado em: ${now}`, '', 'Observações:', '- Este arquivo é gerado automaticamente; não edite manualmente.', '- Para atualizar, execute: npm run licenses:notice', '- Os textos de licença de terceiros são reproduzidos no idioma original para preservar validade jurídica.', ''].join('\\n');\n  }\n  return ['THIRD-PARTY NOTICES', '====================', '', `${projectNome} — Project license: ${license}`, `This file lists third-party components included (production) and their notices/licenses.`, `Generated at: ${now}`, '', 'Notes:', '- This file is generated automatically; do not edit manually.', '- To update, run: npm run licenses:notice', '- Third-party license texts are reproduced in their original language to preserve legal validity.', ''].join('\\n');\n}\ninterface RenderPackageMeta {\n  licenses?: string | string[];\n  publisher?: string;\n  email?: string;\n  repository?: string;\n  licenseArquivo?: string;\n  path?: string;\n}\nasync function renderPackageBlock(pkgId: string, meta: RenderPackageMeta): Promise<string> {\n  const lines: string[] = [];\n  lines.push('----------------------------------------------------------------');\n  lines.push(`Pacote: ${pkgId}`);\n  lines.push(`Licenças: ${s(meta.licenses)}`);\n  if (meta.publisher) lines.push(`Publicador: ${s(meta.publisher)}`);\n  if (meta.email) lines.push(`Contato: ${s(meta.email)}`);\n  if (meta.repository) lines.push(`Repositório: ${s(meta.repository)}`);\n  if (meta.licenseArquivo) {\n    try {\n      const content = await fs.readFile(meta.licenseArquivo, 'utf-8');\n      const trimmed = nl(content).trim();\n      if (trimmed) {\n        lines.push('');\n        lines.push('--- Início do texto de licença ---');\n        lines.push(trimmed);\n        lines.push('--- Fim do texto de licença ---');\n      }\n    } catch (err: unknown) {\n      lines.push('');\n      const errMsg = err instanceof Error ? err.message : String(err);\n      lines.push(`(Aviso) Não foi possível ler o arquivo de licença: ${meta.licenseArquivo} — ${errMsg}`);\n    }\n  }\n  const pkgDir = meta.path;\n  if (pkgDir) {\n    const candidates = ['NOTICE', 'NOTICE.txt', 'NOTICE.md', 'Notice', 'notice', 'notice.txt'];\n    for (const f of candidates) {\n      try {\n        const noticeCaminho = path.join(pkgDir, f);\n        const stat = await fs.stat(noticeCaminho).catch(() => null);\n        if (stat && stat.isFile()) {\n          const ncontent = nl(await fs.readFile(noticeCaminho, 'utf-8')).trim();\n          if (ncontent) {\n            lines.push('');\n            lines.push('--- Início do NOTICE ---');\n            lines.push(ncontent);\n            lines.push('--- Fim do NOTICE ---');\n          }\n          break;\n        }\n      } catch { }\n    }\n  }\n  lines.push('');\n  return lines.join('\\n');\n}\nexport interface GenerateNoticesOptions {\n  root?: string;\n  ptBr?: boolean;\n  output?: string;\n}\nexport async function generateNotices({\n  root = process.cwd(),\n  ptBr = false,\n  output\n}: GenerateNoticesOptions = {}): Promise<{\n  output: string;\n  packages: number;\n}> {\n  const pkg = JSON.parse(await fs.readFile(path.join(root, 'package.json'), 'utf-8'));\n  const projectNome = `${pkg.name}@${pkg.version}`;\n  const projectLicenca = pkg.license || 'UNSPECIFIED';\n  let results: Record<string, RenderPackageMeta> | null = null;\n  const cacheCaminho = path.join(root, '.prometheus', 'licenses.json');\n  try {\n    const buf = await fs.readFile(cacheCaminho, 'utf-8');\n    results = JSON.parse(buf);\n  } catch { }\n  if (!results) {\n    try {\n      const {\n        createRequire\n      } = await import('node:module');\n      const require = createRequire(import.meta.url);\n      const licenseChecker = require('license-checker-rseidelsohn');\n      results = await new Promise<Record<string, RenderPackageMeta>>((resolve, reject) => {\n        licenseChecker.init({\n          start: root,\n          production: true,\n          direct: false,\n          relativeLicensePath: true,\n          json: true\n        }, (err: Error | null, json: Record<string, RenderPackageMeta>) => {\n          if (err) reject(err); else resolve(json);\n        });\n      });\n    } catch {\n      // ignore\n    }\n  }\n  if (!results) {\n    try {\n      const {\n        stdout\n      } = await execFile('npx', ['--yes', 'license-checker-rseidelsohn', '--production', '--json'], {\n        maxBuffer: 10 * 1024 * 1024\n      });\n      results = JSON.parse(stdout);\n    } catch {\n      try {\n        const cmd = 'npx --yes license-checker-rseidelsohn --production --json';\n        const {\n          stdout\n        } = await exec(cmd, {\n          maxBuffer: 10 * 1024 * 1024\n        });\n        results = JSON.parse(stdout);\n      } catch {\n        throw new Error('Failed to obtain license information via cache, API or npx');\n      }\n    }\n  }\n  try {\n    const dir = path.join(root, '.prometheus');\n    await fs.mkdir(dir, {\n      recursive: true\n    });\n    await fs.writeFile(path.join(dir, 'licenses.json'), JSON.stringify(results, null, 2), 'utf-8');\n  } catch { }\n  const entries = Object.entries(results || {}).filter(([id]) => !id.startsWith(`${pkg.name}@`)).sort((a, b) => a[0].localeCompare(b[0]));\n  const parts = [header({\n    projectNome,\n    license: projectLicenca,\n    ptBr\n  })];\n  for (const [id, meta] of entries) {\n    parts.push(await renderPackageBlock(id, meta));\n  }\n  const finalTxt = parts.join('\\n');\n  const out = output ? path.resolve(root, output) : path.join(root, ptBr ? 'AVISOS-DE-TERCEIROS.pt-BR.txt' : 'THIRD-PARTY-NOTICES.txt');\n  await fs.writeFile(out, finalTxt, 'utf-8');\n  return {\n    output: out,\n    packages: entries.length\n  };\n}\nexport default generateNotices;"]}