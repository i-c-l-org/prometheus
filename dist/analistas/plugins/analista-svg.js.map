{"version":3,"file":"analista-svg.js","sourceRoot":"","sources":["../../../src/analistas/plugins/analista-svg.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\nimport { AnalystOrigens, AnalystTipos, SeverityNiveis, SvgMensagens } from '@core/messages/core/plugin-messages.js';\nimport { otimizarSvgLikeSvgo, shouldSugerirOtimizacaoSvg } from '@shared/impar/svgs.js';\n\nimport type { Ocorrencia } from '@';\nimport { criarAnalista, criarOcorrencia } from '@';\n\nconst disableEnv = process.env.PROMETHEUS_DISABLE_PLUGIN_SVG === '1';\ntype Msg = ReturnType<typeof criarOcorrencia>;\nfunction findLine(src: string, index = 0): number {\n  const safeIndex = Math.max(0, index);\n  let line = 1;\n  for (let i = 0; i < safeIndex && i < src.length; i++) {\n    if (src.charCodeAt(i) === 10) line++;\n  }\n  return line;\n}\nfunction findFirstMatchLine(src: string, re: RegExp, fallbackLine = 1): number {\n  const idx = src.search(re);\n  if (idx < 0) return fallbackLine;\n  return findLine(src, idx);\n}\nfunction msg(message: string, relPath: string, nivel: (typeof SeverityNiveis)[keyof typeof SeverityNiveis] = SeverityNiveis.warning, line = 1): Msg {\n  return criarOcorrencia({\n    relPath,\n    mensagem: message,\n    linha: line,\n    nivel,\n    origem: AnalystOrigens.svg,\n    tipo: AnalystTipos.svg\n  });\n}\nexport const analistaSvg = criarAnalista({\n  nome: 'analista-svg',\n  categoria: 'assets',\n  descricao: 'Heurísticas para SVG + sugestão de otimização (modo Prometheus).',\n  global: false,\n  test: (relPath: string): boolean => /\\.svg$/i.test(relPath),\n  aplicar: async (src, relPath): Promise<Ocorrencia[] | null> => {\n    if (disableEnv) return null;\n    const ocorrencias: Ocorrencia[] = [];\n    if (!/<svg\\b/i.test(src)) {\n      ocorrencias.push(msg(SvgMensagens.naoPareceSvg, relPath, SeverityNiveis.warning, 1));\n      return ocorrencias;\n    }\n    const idxSvg = src.search(/<svg\\b/i);\n    const linhaSvg = idxSvg >= 0 ? findLine(src, idxSvg) : 1;\n    const opt = otimizarSvgLikeSvgo({\n      svg: src\n    });\n\n    // Segurança\n    for (const w of opt.warnings) {\n      if (w === 'script-inline') {\n        const line = findFirstMatchLine(src, /<script\\b/i, linhaSvg);\n        ocorrencias.push(msg(SvgMensagens.scriptInline, relPath, SeverityNiveis.error, line));\n      } else if (w === 'evento-inline') {\n        const line = findFirstMatchLine(src, /\\son\\w+\\s*=\\s*['\"]/i, linhaSvg);\n        ocorrencias.push(msg(SvgMensagens.eventoInline, relPath, SeverityNiveis.warning, line));\n      } else if (w === 'javascript-url') {\n        const line = findFirstMatchLine(src, /javascript:\\s*/i, linhaSvg);\n        ocorrencias.push(msg(SvgMensagens.javascriptUrl, relPath, SeverityNiveis.error, line));\n      }\n    }\n\n    // Boas práticas\n    if (!/\\bviewBox\\s*=\\s*['\"][^'\"]+['\"]/i.test(src)) {\n      ocorrencias.push(msg(SvgMensagens.semViewBox, relPath, SeverityNiveis.info, linhaSvg));\n    }\n\n    // Otimização (diferença de bytes)\n    if (opt.changed && opt.originalBytes > opt.optimizedBytes && shouldSugerirOtimizacaoSvg(opt.originalBytes, opt.optimizedBytes)) {\n      ocorrencias.push(msg(SvgMensagens.podeOtimizar(opt.originalBytes, opt.optimizedBytes, opt.mudancas), relPath, SeverityNiveis.info, linhaSvg));\n    }\n    return ocorrencias.length ? ocorrencias : null;\n  }\n});\nexport default analistaSvg;"]}