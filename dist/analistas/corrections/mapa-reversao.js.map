{"version":3,"file":"mapa-reversao.js","sourceRoot":"","sources":["../../../src/analistas/corrections/mapa-reversao.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT-0\nimport { promises as fs } from 'node:fs';\nimport path from 'node:path';\n\nimport { ExcecoesMensagens } from '@core/messages/core/excecoes-messages.js';\nimport { log, logAuto } from '@core/messages/index.js';\nimport { PROMETHEUS_ARQUIVOS } from '@core/registry/paths.js';\nimport { lerEstado, salvarEstado } from '@shared/persistence/persistencia.js';\n\nimport type { MapaReversao, MoveReversao } from '@';\n\nconst CONSTANTES_MAPA = {\n  VERSAO: '1.0.0',\n  ID_LENGTH: 9,\n  ID_OFFSET: 2,\n  RADIX_36: 36\n} as const;\nexport class GerenciadorMapaReversao {\n  private readonly mapaPath: string;\n  private mapa: MapaReversao;\n  constructor(opts?: {\n    mapaPath?: string;\n  }) {\n    this.mapaPath = opts?.mapaPath ?? PROMETHEUS_ARQUIVOS.MAPA_REVERSAO;\n    this.mapa = {\n      versao: CONSTANTES_MAPA.VERSAO,\n      moves: [],\n      metadata: {\n        totalMoves: 0,\n        ultimoMove: '',\n        podeReverter: true\n      }\n    };\n  }\n\n  /**\n   * Carrega o mapa de revers√£o do disco\n   */\n  async carregar(): Promise<void> {\n    try {\n      this.mapa = (await lerEstado<MapaReversao | null>(this.mapaPath, null)) ?? {\n        versao: CONSTANTES_MAPA.VERSAO,\n        moves: [],\n        metadata: {\n          totalMoves: 0,\n          ultimoMove: '',\n          podeReverter: true\n        }\n      };\n\n      // Valida√ß√£o b√°sica\n      if (!this.mapa.moves || !Array.isArray(this.mapa.moves)) {\n        throw new Error(ExcecoesMensagens.mapaReversaoCorrompido);\n      }\n      logAuto.mapaReversaoCarregado(this.mapa.moves.length);\n    } catch (error) {\n      if ((error as NodeJS.ErrnoException).code === 'ENOENT') {\n        // N√£o persistimos automaticamente um mapa vazio ao carregar: evitar efeitos colaterais\n        // (ex.: chamada a fs.mkdir) durante opera√ß√µes que apenas consultam o mapa.\n        logAuto.mapaReversaoNenhumEncontrado();\n      } else {\n        logAuto.mapaReversaoErroCarregar((error as Error).message);\n        // Reinicia com mapa vazio em caso de erro\n        this.mapa = {\n          versao: CONSTANTES_MAPA.VERSAO,\n          moves: [],\n          metadata: {\n            totalMoves: 0,\n            ultimoMove: '',\n            podeReverter: true\n          }\n        };\n      }\n    }\n  }\n\n  /**\n   * Salva o mapa de revers√£o no disco\n   */\n  async salvar(): Promise<void> {\n    try {\n      await fs.mkdir(path.dirname(this.mapaPath), {\n        recursive: true\n      });\n      await salvarEstado(this.mapaPath, this.mapa);\n      log.info(`üíæ Mapa de revers√£o salvo: ${this.mapa.moves.length} moves`);\n    } catch (error) {\n      logAuto.mapaReversaoErroSalvar((error as Error).message);\n    }\n  }\n\n  /**\n   * Registra um novo move no mapa de revers√£o\n   */\n  async registrarMove(origem: string, destino: string, motivo: string, conteudoOriginal?: string, conteudoFinal?: string,\n  // quando true, evita persistir o mapa no disco imediatamente (√∫til para chamadas em massa/tests)\n  skipSalvar?: boolean): Promise<string> {\n    try {\n      const id = `move_${Date.now()}_${Math.random().toString(CONSTANTES_MAPA.RADIX_36).substr(CONSTANTES_MAPA.ID_OFFSET, CONSTANTES_MAPA.ID_LENGTH)}`;\n      const move: MoveReversao = {\n        id,\n        timestamp: new Date().toISOString(),\n        origem,\n        destino,\n        motivo,\n        // Considera que imports foram reescritos se houver conte√∫do original\n        // fornecido (testes esperam que passar conteudoOriginal permita restaura√ß√£o)\n        importsReescritos: !!conteudoOriginal || !!conteudoFinal && conteudoOriginal !== conteudoFinal,\n        conteudoOriginal,\n        conteudoFinal\n      };\n      this.mapa.moves.push(move);\n      this.mapa.metadata.totalMoves = this.mapa.moves.length;\n      this.mapa.metadata.ultimoMove = move.timestamp;\n\n      // Persiste no disco por padr√£o; caller pode optar por adiar a persist√™ncia\n      if (!skipSalvar) {\n        await this.salvar();\n      }\n      log.info(`üìù Move registrado: ${origem} ‚Üí ${destino} (${motivo})`);\n      return id;\n    } catch (err) {\n      logAuto.mapaReversaoErroSalvar((err as Error).message);\n      throw err;\n    }\n  }\n\n  /**\n   * Remove um move do mapa de revers√£o\n   */\n  async removerMove(id: string): Promise<boolean> {\n    try {\n      const indice = this.mapa.moves.findIndex((move: MoveReversao) => move.id === id);\n      if (indice === -1) {\n        return false;\n      }\n      this.mapa.moves.splice(indice, 1);\n      this.mapa.metadata.totalMoves = this.mapa.moves.length;\n      await this.salvar();\n      logAuto.moveRemovido(id);\n      return true;\n    } catch (err) {\n      logAuto.mapaReversaoErroSalvar((err as Error).message);\n      return false;\n    }\n  }\n\n  /**\n   * Obt√©m todos os moves registrados\n   */\n  obterMoves(): MoveReversao[] {\n    return [...this.mapa.moves];\n  }\n\n  /**\n   * Obt√©m moves por arquivo\n   */\n  obterMovesPorArquivo(arquivo: string): MoveReversao[] {\n    return this.mapa.moves.filter((move: MoveReversao) => move.origem === arquivo || move.destino === arquivo);\n  }\n\n  /**\n   * Verifica se um arquivo pode ser revertido\n   */\n  podeReverterArquivo(arquivo: string): boolean {\n    const moves = this.obterMovesPorArquivo(arquivo);\n    return moves.length > 0;\n  }\n\n  /**\n   * Reverte um move espec√≠fico\n   */\n  async reverterMove(id: string, baseDir: string = process.cwd()): Promise<boolean> {\n    const move = this.mapa.moves.find((m: MoveReversao) => m.id === id);\n    if (!move) {\n      logAuto.mapaReversaoMoveNaoEncontrado(id);\n      return false;\n    }\n    try {\n      // Verifica se o arquivo de destino ainda existe\n      const destinoCaminho = path.join(baseDir, move.destino);\n      const origemCaminho = path.join(baseDir, move.origem);\n      try {\n        await fs.access(destinoCaminho);\n      } catch (err) {\n        // ENOENT: destino n√£o existe ‚Äî reportamos e abortamos a revers√£o do move.\n        if ((err as NodeJS.ErrnoException)?.code && (err as NodeJS.ErrnoException).code !== 'ENOENT') {\n          logAuto.mapaReversaoErroReverter((err as Error).message);\n          return false;\n        }\n        logAuto.mapaReversaoArquivoDestinoNaoEncontrado(move.destino);\n        return false;\n      }\n\n      // Verifica se o diret√≥rio de origem existe\n      await fs.mkdir(path.dirname(origemCaminho), {\n        recursive: true\n      });\n\n      // Verifica se j√° existe arquivo na origem\n      try {\n        await fs.access(origemCaminho);\n        logAuto.mapaReversaoArquivoExisteOrigem(move.origem);\n        return false;\n      } catch (err) {\n        // Se a falha n√£o for ENOENT, trata como erro; caso contr√°rio a origem est√° livre e seguimos.\n        if ((err as NodeJS.ErrnoException)?.code && (err as NodeJS.ErrnoException).code !== 'ENOENT') {\n          logAuto.mapaReversaoErroReverter((err as Error).message);\n          return false;\n        }\n        // OK, origem est√° livre\n      }\n\n      // Move o arquivo de volta\n      if (move.importsReescritos && move.conteudoOriginal) {\n        // Se os imports foram reescritos, usa o conte√∫do original\n        await fs.writeFile(origemCaminho, move.conteudoOriginal, 'utf-8');\n        await fs.unlink(destinoCaminho);\n        log.sucesso(`‚Ü©Ô∏è Arquivo revertido com conte√∫do original: ${move.destino} ‚Üí ${move.origem}`);\n      } else {\n        // Move simples\n        await fs.rename(destinoCaminho, origemCaminho);\n        log.sucesso(`‚Ü©Ô∏è Arquivo revertido: ${move.destino} ‚Üí ${move.origem}`);\n      }\n\n      // Remove o move do mapa\n      await this.removerMove(id);\n      return true;\n    } catch (error) {\n      logAuto.mapaReversaoErroReverter((error as Error).message);\n      return false;\n    }\n  }\n\n  /**\n   * Reverte todos os moves de um arquivo\n   */\n  async reverterArquivo(arquivo: string, baseDir: string = process.cwd()): Promise<boolean> {\n    const moves = this.obterMovesPorArquivo(arquivo);\n    if (moves.length === 0) {\n      logAuto.mapaReversaoNenhumMove(arquivo);\n      return false;\n    }\n\n    // Reverte do mais recente para o mais antigo\n    const movesOrdenados = moves.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());\n\n    // Retorna true se pelo menos um move foi revertido com sucesso\n    let revertedContagem = 0;\n    try {\n      for (const move of movesOrdenados) {\n        const resultado = await this.reverterMove(move.id, baseDir);\n        if (resultado) revertedContagem += 1;\n      }\n    } catch (error) {\n      logAuto.mapaReversaoErroReverter((error as Error).message);\n      return false;\n    }\n    return revertedContagem > 0;\n  }\n\n  /**\n   * Lista moves em formato leg√≠vel\n   */\n  listarMoves(): string {\n    if (this.mapa.moves.length === 0) {\n      return 'üìã Nenhum move registrado no mapa de revers√£o.';\n    }\n    let resultado = `üìã Mapa de Revers√£o (${this.mapa.moves.length} moves):\\n\\n`;\n\n    // Ordena por timestamp (mais recente primeiro)\n    const movesOrdenados = [...this.mapa.moves].sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());\n    for (const move of movesOrdenados) {\n      const dataFormatada = new Date(move.timestamp).toLocaleString('pt-BR');\n      const reescritos = move.importsReescritos ? ' (imports reescritos)' : '';\n      resultado += `${move.id}:\\n`;\n      resultado += `  üìÖ ${dataFormatada}\\n`;\n      resultado += `  üìÅ ${move.origem} ‚Üí ${move.destino}\\n`;\n      resultado += `  üí¨ ${move.motivo}${reescritos}\\n\\n`;\n    }\n    return resultado;\n  }\n\n  /**\n   * Limpa o mapa de revers√£o\n   */\n  async limpar(): Promise<void> {\n    try {\n      this.mapa.moves = [];\n      this.mapa.metadata.totalMoves = 0;\n      this.mapa.metadata.ultimoMove = '';\n      await this.salvar();\n      log.info('üßπ Mapa de revers√£o limpo');\n    } catch (err) {\n      logAuto.mapaReversaoErroSalvar((err as Error).message);\n    }\n  }\n}\n\n// Inst√¢ncia global\nexport const mapaReversao = new GerenciadorMapaReversao();"]}