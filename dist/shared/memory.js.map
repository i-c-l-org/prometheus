{"version":3,"file":"memory.js","sourceRoot":"","sources":["../../src/shared/memory.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT-0\nimport { mkdir, readFile, writeFile } from 'node:fs/promises';\nimport { dirname, join } from 'node:path';\n\nimport type { MemoryMessage,PrometheusContextState, PrometheusRunRecord } from '@';\n\n// Re-exporta para compatibilidade com código existente\nexport type { MemoryMessage,PrometheusContextState, PrometheusRunRecord };\nexport class ConversationMemory {\n  private history: MemoryMessage[] = [];\n  constructor(private maxHistory = 10, private persistCaminho?: string) {}\n  async init(): Promise<void> {\n    if (!this.persistCaminho) return;\n    try {\n      const raw = await readFile(this.persistCaminho, 'utf-8');\n      this.history = JSON.parse(raw);\n    } catch {\n      this.history = [];\n    }\n  }\n  async addMessage(message: MemoryMessage): Promise<void> {\n    this.history.push(message);\n    if (this.history.length > this.maxHistory * 2) {\n      this.history = this.history.slice(-this.maxHistory * 2);\n    }\n    await this.persist();\n  }\n  getContext(lastN?: number): MemoryMessage[] {\n    if (lastN) return this.history.slice(-lastN);\n    return [...this.history];\n  }\n  getSummary(): {\n    // @prometheus-disable: tipo-literal-inline-complexo\n    totalMessages: number;\n    userMessages: number;\n    assistantMessages: number;\n    firstMessage?: string;\n    lastMessage?: string;\n  } {\n    return {\n      totalMessages: this.history.length,\n      userMessages: this.history.filter(m => m.role === 'user').length,\n      assistantMessages: this.history.filter(m => m.role === 'assistant').length,\n      firstMessage: this.history[0]?.timestamp,\n      lastMessage: this.history[this.history.length - 1]?.timestamp\n    };\n  }\n  async clear(): Promise<void> {\n    this.history = [];\n    await this.persist();\n  }\n  private async persist(): Promise<void> {\n    if (!this.persistCaminho) return;\n    try {\n      await mkdir(dirname(this.persistCaminho), {\n        recursive: true\n      });\n      await writeFile(this.persistCaminho, JSON.stringify(this.history, null, 2), 'utf-8');\n    } catch {\n      // ignore persist errors\n    }\n  }\n}\nexport class PrometheusContextMemory {\n  private state: PrometheusContextState = {\n    schemaVersion: 1,\n    lastRuns: [],\n    preferences: {}\n  };\n  constructor(private maxRuns = 20, private persistCaminho?: string) {}\n  async init(): Promise<void> {\n    if (!this.persistCaminho) return;\n    try {\n      const raw = await readFile(this.persistCaminho, 'utf-8');\n      const parsed = JSON.parse(raw) as Partial<PrometheusContextState>;\n      if (parsed && parsed.schemaVersion === 1) {\n        this.state = {\n          // @prometheus-disable: tipo-literal-inline-complexo\n          schemaVersion: 1,\n          lastRuns: Array.isArray(parsed.lastRuns) ? parsed.lastRuns as PrometheusRunRecord[] : [],\n          preferences: parsed.preferences && typeof parsed.preferences === 'object' ? parsed.preferences as Record<string, unknown> : {}\n        };\n      }\n    } catch {\n      // mantém defaults\n    }\n  }\n  getState(): PrometheusContextState {\n    return {\n      // @prometheus-disable: tipo-literal-inline-complexo\n      schemaVersion: 1,\n      lastRuns: [...this.state.lastRuns],\n      preferences: {\n        ...this.state.preferences\n      }\n    };\n  }\n  getLastRun(): PrometheusRunRecord | undefined {\n    return this.state.lastRuns[this.state.lastRuns.length - 1];\n  }\n  getPreference<T = unknown>(key: string): T | undefined {\n    return this.state.preferences[key] as T | undefined;\n  }\n  async setPreference(key: string, value: unknown): Promise<void> {\n    this.state.preferences[key] = value;\n    await this.persist();\n  }\n  async recordRunStart(\n  // @prometheus-disable: tipo-literal-inline-complexo\n  input: {\n    cwd: string;\n    argv: string[];\n    version?: string;\n    timestamp?: string;\n  }): Promise<string> {\n    const id = `${Date.now()}-${Math.random().toString(16).slice(2)}`;\n    const record: PrometheusRunRecord = {\n      id,\n      timestamp: input.timestamp ?? new Date().toISOString(),\n      cwd: input.cwd,\n      argv: [...input.argv],\n      version: input.version\n    };\n    this.state.lastRuns.push(record);\n    if (this.state.lastRuns.length > this.maxRuns) {\n      this.state.lastRuns = this.state.lastRuns.slice(-this.maxRuns);\n    }\n    await this.persist();\n    return id;\n  }\n  async recordRunEnd(id: string,\n  // @prometheus-disable: tipo-literal-inline-complexo\n  update: {\n    ok: boolean;\n    exitCode?: number;\n    durationMs?: number;\n    error?: string;\n  }): Promise<void> {\n    const idx = this.state.lastRuns.findIndex(r => r.id === id);\n    if (idx === -1) return;\n    const prev = this.state.lastRuns[idx];\n    this.state.lastRuns[idx] = {\n      ...prev,\n      ok: update.ok,\n      exitCode: update.exitCode,\n      durationMs: update.durationMs,\n      error: update.error\n    };\n    await this.persist();\n  }\n  async clear(): Promise<void> {\n    this.state.lastRuns = [];\n    this.state.preferences = {};\n    await this.persist();\n  }\n  private async persist(): Promise<void> {\n    if (!this.persistCaminho) return;\n    try {\n      await mkdir(dirname(this.persistCaminho), {\n        recursive: true\n      });\n      await writeFile(this.persistCaminho, JSON.stringify(this.state, null, 2), 'utf-8');\n    } catch {\n      // ignore persist errors\n    }\n  }\n}\nexport async function getDefaultMemory(): Promise<ConversationMemory> {\n  // Preferimos memória por projeto (cwd) para evitar misturar repositórios.\n  const persistCaminho = join(process.cwd(), '.prometheus', 'history.json');\n  const mem = new ConversationMemory(10, persistCaminho);\n  await mem.init();\n  return mem;\n}\nexport async function getDefaultContextMemory(): Promise<PrometheusContextMemory> {\n  const persistCaminho = join(process.cwd(), '.prometheus', 'context.json');\n  const mem = new PrometheusContextMemory(20, persistCaminho);\n  await mem.init();\n  return mem;\n}"]}