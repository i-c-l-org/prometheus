{"version":3,"file":"suppressao.js","sourceRoot":"","sources":["../../../src/shared/helpers/suppressao.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n/**\n * Sistema de supressão inline para o Prometheus\n * Permite desabilitar regras específicas usando comentários no código\n *\n * Formatos suportados (qualquer sintaxe de comentário inline, ex.: //, #, --, ;, <!-- -->, blocos /* ... * /):\n * - @prometheus-disable-next-line nome-da-regra\n * - @prometheus-disable nome-da-regra\n * - @prometheus-enable nome-da-regra\n */\n\nimport type { RegrasSuprimidas, SupressaoInfo } from '@';\n\nexport type { RegrasSuprimidas, SupressaoInfo };\n\n/**\n * Analisa comentários do código fonte para extrair diretivas de supressão\n */\nexport function extrairSupressoes(src: string): RegrasSuprimidas {\n  const linhas = src.split('\\n');\n  const porLinha = new Map<number, Set<string>>();\n  const blocosAtivos = new Set<string>();\n\n  const normalizarLinha = (linha: string): string => {\n    let t = linha.trim();\n\n    // Remove wrappers de comentários comuns (ordem importa para HTML -> bloco -> linha)\n    if (t.startsWith('<!--'))\n      t = t\n        .replace(/^<!--/, '')\n        .replace(/--!?>(\\s*)?$/, '')\n        .trim();\n    if (t.startsWith('/*'))\n      t = t.replace(/^\\/\\*/, '').replace(/\\*\\/$/, '').trim();\n    if (t.startsWith('*')) t = t.replace(/^\\*\\s?/, '').trim(); // linhas internas de bloco\n\n    // Comentários de linha: JS/TS, shell/Python, SQL, INI, outros\n    t = t.replace(/^\\/\\//, '').trim();\n    t = t.replace(/^#/, '').trim();\n    t = t.replace(/^--/, '').trim();\n    t = t.replace(/^;/, '').trim();\n\n    return t;\n  };\n\n  for (let i = 0; i < linhas.length; i++) {\n    const linha = linhas[i];\n    const linhaNorm = normalizarLinha(linha);\n    const numeroLinha = i + 1;\n\n    // @prometheus-disable-next-line regra1 regra2\n    const matchNextLine = linhaNorm.match(/@prometheus-disable-next-line\\s+(.+)/);\n    if (matchNextLine) {\n      const regras = matchNextLine[1].trim().split(/\\s+/);\n      const linhaAfetada = numeroLinha + 1;\n\n      if (!porLinha.has(linhaAfetada)) {\n        porLinha.set(linhaAfetada, new Set());\n      }\n\n      regras.forEach((regra) => {\n        porLinha.get(linhaAfetada)?.add(regra.trim());\n      });\n\n      continue;\n    }\n\n    // @prometheus-disable regra1 regra2\n    const matchDisable = linhaNorm.match(/@prometheus-disable\\s+(.+)/);\n    if (matchDisable) {\n      const regras = matchDisable[1].trim().split(/\\s+/);\n      regras.forEach((regra) => {\n        blocosAtivos.add(regra.trim());\n      });\n      continue;\n    }\n\n    // @prometheus-enable regra1 regra2\n    const matchEnable = linhaNorm.match(/@prometheus-enable\\s+(.+)/);\n    if (matchEnable) {\n      const regras = matchEnable[1].trim().split(/\\s+/);\n      regras.forEach((regra) => {\n        blocosAtivos.delete(regra.trim());\n      });\n      continue;\n    }\n\n    // @prometheus-disable (desabilita todas as regras)\n    if (linhaNorm.includes('@prometheus-disable-all')) {\n      blocosAtivos.add('*');\n      continue;\n    }\n\n    // @prometheus-enable (reabilita todas as regras)\n    if (linhaNorm.includes('@prometheus-enable-all')) {\n      blocosAtivos.clear();\n      continue;\n    }\n\n    // Se há blocos ativos, aplicar a esta linha\n    if (blocosAtivos.size > 0) {\n      if (!porLinha.has(numeroLinha)) {\n        porLinha.set(numeroLinha, new Set());\n      }\n\n      blocosAtivos.forEach((regra) => {\n        porLinha.get(numeroLinha)?.add(regra);\n      });\n    }\n  }\n\n  return { porLinha, blocosAtivos };\n}\n\n/**\n * Verifica se uma regra está suprimida em uma determinada linha\n */\nexport function isRegraSuprimida(\n  regra: string,\n  linha: number,\n  supressoes: RegrasSuprimidas,\n): boolean {\n  const regrasDaLinha = supressoes.porLinha.get(linha);\n\n  if (!regrasDaLinha) {\n    return false;\n  }\n\n  // Verifica supressão específica da regra\n  if (regrasDaLinha.has(regra)) {\n    return true;\n  }\n\n  // Verifica supressão global (*)\n  if (regrasDaLinha.has('*')) {\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Filtra ocorrências baseado em supressões inline\n */\nexport function filtrarOcorrenciasSuprimidas<\n  T extends { linha?: number; tipo?: string },\n>(ocorrencias: T[], nomeAnalista: string, src: string): T[] {\n  const supressoes = extrairSupressoes(src);\n\n  return ocorrencias.filter((ocorrencia) => {\n    if (!ocorrencia.linha) {\n      return true; // Mantém ocorrências sem linha (não podem ser suprimidas)\n    }\n\n    // Prioriza tipo específico da ocorrência, depois nome do analista\n    const _identificadorRegra = ocorrencia.tipo || nomeAnalista || '';\n\n    // Verifica se está suprimida pelo tipo específico OU pelo nome do analista\n    const suprimidaPorTipo =\n      ocorrencia.tipo &&\n      isRegraSuprimida(ocorrencia.tipo, ocorrencia.linha, supressoes);\n    const suprimidaPorAnalista = isRegraSuprimida(\n      nomeAnalista,\n      ocorrencia.linha,\n      supressoes,\n    );\n\n    return !suprimidaPorTipo && !suprimidaPorAnalista;\n  });\n}\n"]}