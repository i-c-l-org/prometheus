{"version":3,"file":"version.js","sourceRoot":"","sources":["../../../src/core/schema/version.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n/**\n * Sistema de Versionamento de Schema para Relatórios JSON\n *\n * Este módulo gerencia versões de schema para relatórios JSON do Prometheus,\n * garantindo compatibilidade futura e evolução controlada dos formatos.\n */\n\nimport { ExcecoesMensagens } from '@core/messages/core/excecoes-messages.js';\n\nimport type { RelatorioComVersao, SchemaMetadata } from '@';\n\n// Re-exporta os tipos para compatibilidade\nexport type { RelatorioComVersao, SchemaMetadata };\n\n/** Versão atual do schema */\nexport const VERSAO_ATUAL = '1.0.0';\n\n/** Histórico de versões do schema */\nexport const HISTORICO_VERSOES: Record<string, SchemaMetadata> = {\n  '1.0.0': {\n    versao: '1.0.0',\n    criadoEm: '2025-08-28',\n    descricao: 'Versão inicial com campos básicos de relatório',\n    compatibilidade: ['1.0.0'],\n    camposObrigatorios: ['_schema', 'dados', '_schema.versao', '_schema.criadoEm', '_schema.descricao'],\n    camposOpcionais: ['_schema.compatibilidade', '_schema.camposObrigatorios', '_schema.camposOpcionais']\n  }\n};\n\n/**\n * Cria metadados de schema para a versão atual\n */\n\nexport function criarSchemaMetadata(versao: string = VERSAO_ATUAL, descricaoPersonalizada?: string): SchemaMetadata {\n  const base = HISTORICO_VERSOES[versao];\n  if (!base) {\n    throw new Error(ExcecoesMensagens.versaoSchemaDesconhecida(versao));\n  }\n  return {\n    ...base,\n    ...(descricaoPersonalizada && {\n      descricao: descricaoPersonalizada\n    })\n  };\n}\n\n/**\n * Valida se um relatório tem schema válido\n */\n\nexport function validarSchema(relatorio: Record<string, unknown>): {\n  valido: boolean;\n  erros: string[];\n} {\n  const erros: string[] = [];\n\n  // Verificar estrutura básica\n  if (!relatorio || typeof relatorio !== 'object') {\n    erros.push('Relatório deve ser um objeto');\n    return {\n      valido: false,\n      erros\n    };\n  }\n\n  // Verificar presença do schema\n  if (!('_schema' in relatorio) || !relatorio._schema) {\n    erros.push('Campo _schema é obrigatório');\n    return {\n      valido: false,\n      erros\n    };\n  }\n  const schema = relatorio._schema as Record<string, unknown>;\n\n  // Verificar campos obrigatórios do schema\n  const camposObrigatorios = ['versao', 'criadoEm', 'descricao'];\n  for (const campo of camposObrigatorios) {\n    if (!(campo in schema)) {\n      erros.push(`Campo _schema.${campo} é obrigatório`);\n    }\n  }\n\n  // Verificar se a versão existe no histórico\n  if (schema.versao && typeof schema.versao === 'string' && !HISTORICO_VERSOES[schema.versao]) {\n    erros.push(`Versão de schema desconhecida: ${schema.versao}`);\n  }\n\n  // Verificar presença dos dados\n  if (!('dados' in relatorio)) {\n    erros.push('Campo dados é obrigatório');\n  }\n  return {\n    valido: erros.length === 0,\n    erros\n  };\n}\n\n/**\n * Migra um relatório para a versão atual se necessário\n */\nexport function migrarParaVersaoAtual<T>(relatorio: Record<string, unknown>): RelatorioComVersao<T> {\n  // Se já tem schema válido, retornar como está\n  const validacao = validarSchema(relatorio);\n  if (validacao.valido && relatorio._schema) {\n    return relatorio as unknown as RelatorioComVersao<T>;\n  }\n\n  // Se não tem schema, rejeitar: relatórios sem `_schema` são considerados formatos antigos\n  // e devem ser migrados explicitamente pelo consumidor antes de chamar esta função.\n  // Se não tem schema, considerar que é um relatório legado e migrar explicitamente\n  // Chamadas a esta função são a migração explícita, então embrulhamos o relatório\n  // antigo com os metadados de versão atuais.\n  if (!('_schema' in relatorio) || !relatorio._schema) {\n    return criarRelatorioComVersao<T>(relatorio as unknown as T);\n  }\n\n  // Para futuras migrações, implementar lógica aqui\n  // Por enquanto, apenas revalidar\n  if (!validacao.valido) {\n    throw new Error(ExcecoesMensagens.relatorioSchemaInvalido(validacao.erros.join(', ')));\n  }\n  return relatorio as unknown as RelatorioComVersao<T>;\n}\n\n/**\n * Cria um relatório com versão atual\n */\nexport function criarRelatorioComVersao<T>(dados: T, versao: string = VERSAO_ATUAL, descricao?: string): RelatorioComVersao<T> {\n  return {\n    _schema: criarSchemaMetadata(versao, descricao),\n    dados\n  };\n}\n\n/**\n * Extrai apenas os dados de um relatório versionado\n */\nexport function extrairDados<T>(relatorio: RelatorioComVersao<T>): T {\n  return relatorio.dados;\n}\n\n/**\n * Verifica se uma versão é compatível com a atual\n */\n\nexport function versaoCompativel(versao: string): boolean {\n  const metadata = HISTORICO_VERSOES[versao];\n  if (!metadata) return false;\n  return metadata.compatibilidade.includes(VERSAO_ATUAL);\n}"]}