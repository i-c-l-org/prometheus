{"version":3,"file":"comando-reverter.js","sourceRoot":"","sources":["../../../src/cli/commands/comando-reverter.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,YAAY,EAAE,MAAM,yCAAyC,CAAC;AACvE,OAAO,EAAE,QAAQ,EAAE,IAAI,EAAE,MAAM,4BAA4B,CAAC;AAC5D,OAAO,EAAE,2BAA2B,EAAE,MAAM,qDAAqD,CAAC;AAClG,OAAO,EAAE,kBAAkB,EAAE,GAAG,EAAE,OAAO,EAAE,UAAU,EAAE,MAAM,yBAAyB,CAAC;AACvF,OAAO,EAAE,OAAO,EAAE,MAAM,WAAW,CAAC;AAEpC,MAAM,UAAU,wBAAwB,CAAC,OAAgB;IACvD,OAAO,CAAC,OAAO,CAAC,UAAU,CAAC;SACxB,WAAW,CAAC,2BAA2B,CAAC,SAAS,CAAC;SAClD,IAAI,CAAC,WAAW,EAAE,KAAK,IAAI,EAAE;QAC9B,IAAI,OAAO,CAAC,GAAG,CAAC,oBAAoB,KAAK,GAAG,EAAE,CAAC;YAC7C,IAAI,CAAC;gBACH,MAAM,YAAY,CAAC,QAAQ,EAAE,CAAC;YAChC,CAAC;YAAC,OAAO,GAAG,EAAE,CAAC;gBAGb,IAAI,OAAO,CAAC,GAAG,CAAC,MAAM,KAAK,GAAG;oBAAE,OAAO;gBACvC,GAAG,CAAC,KAAK,CAAC,2BAA2B,CAAC,qBAAqB,CAAC,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;YACjH,CAAC;QACH,CAAC;IACH,CAAC,CAAC,CAAC,UAAU,CAAC,IAAI,OAAO,CAAC,QAAQ,CAAC,CAAC,WAAW,CAAC,sDAAsD,CAAC,CAAC,MAAM,CAAC,KAAK,IAAI,EAAE;QACxH,IAAI,CAAC;YACH,MAAM,YAAY,CAAC,QAAQ,EAAE,CAAC;YAC9B,MAAM,MAAM,GAAG,YAAY,CAAC,WAAW,EAAE,CAAC;QAC5C,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,GAAG,CAAC,IAAI,CAAC,2BAA2B,CAAC,WAAW,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;YAChH,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;QACzB,CAAC;IACH,CAAC,CAAC,CAAC;SACF,UAAU,CAAC,IAAI,OAAO,CAAC,SAAS,CAAC;SAC/B,WAAW,CAAC,2BAA2B,CAAC,WAAW,CAAC,OAAO,CAAC,SAAS,CAAC;SACtE,QAAQ,CAAC,WAAW,EAAE,2BAA2B,CAAC,WAAW,CAAC,OAAO,CAAC,SAAS,CAAC;SAChF,MAAM,CAAC,KAAK,EAAE,OAAe,EAAE,EAAE;QAClC,IAAI,CAAC;YACH,MAAM,YAAY,CAAC,QAAQ,EAAE,CAAC;YAC9B,IAAI,CAAC,YAAY,CAAC,mBAAmB,CAAC,OAAO,CAAC,EAAE,CAAC;gBAC/C,UAAU,CAAC,kBAAkB,CAAC,OAAO,CAAC,CAAC;gBACvC,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;gBACvB,OAAO;YACT,CAAC;YACD,UAAU,CAAC,kBAAkB,CAAC,OAAO,CAAC,CAAC;YACvC,MAAM,OAAO,GAAG,MAAM,YAAY,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;YAC5D,IAAI,OAAO,EAAE,CAAC;gBACZ,UAAU,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;YACtC,CAAC;iBAAM,CAAC;gBACN,UAAU,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;gBAClC,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;gBACvB,OAAO;YACT,CAAC;QACH,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,GAAG,CAAC,IAAI,CAAC,2BAA2B,CAAC,WAAW,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;YACjH,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;QACzB,CAAC;IACH,CAAC,CAAC,CAAC;SACF,UAAU,CAAC,IAAI,OAAO,CAAC,MAAM,CAAC;SAC5B,WAAW,CAAC,2BAA2B,CAAC,WAAW,CAAC,IAAI,CAAC,SAAS,CAAC;SACnE,QAAQ,CAAC,MAAM,EAAE,2BAA2B,CAAC,WAAW,CAAC,IAAI,CAAC,SAAS,CAAC;SACxE,MAAM,CAAC,KAAK,EAAE,EAAU,EAAE,EAAE;QAC7B,IAAI,CAAC;YACH,MAAM,YAAY,CAAC,QAAQ,EAAE,CAAC;YAC9B,OAAO,CAAC,0BAA0B,CAAC,EAAE,CAAC,CAAC;YACvC,MAAM,OAAO,GAAG,MAAM,YAAY,CAAC,YAAY,CAAC,EAAE,CAAC,CAAC;YACpD,IAAI,OAAO,EAAE,CAAC;gBACZ,OAAO,CAAC,yBAAyB,CAAC,EAAE,CAAC,CAAC;YACxC,CAAC;iBAAM,CAAC;gBACN,OAAO,CAAC,6BAA6B,CAAC,EAAE,CAAC,CAAC;gBAC1C,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;gBACvB,OAAO;YACT,CAAC;QACH,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,GAAG,CAAC,IAAI,CAAC,2BAA2B,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;YAC9G,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;QACzB,CAAC;IACH,CAAC,CAAC,CAAC;SACF,UAAU,CAAC,IAAI,OAAO,CAAC,QAAQ,CAAC;SAC9B,WAAW,CAAC,2BAA2B,CAAC,WAAW,CAAC,MAAM,CAAC,SAAS,CAAC;SACrE,MAAM,CAAC,aAAa,EAAE,2BAA2B,CAAC,MAAM,CAAC,KAAK,CAAC;SAC/D,MAAM,CAAC,KAAK,EAAE,OAEhB,EAAE,EAAE;QACH,IAAI,CAAC;YACH,MAAM,YAAY,CAAC,QAAQ,EAAE,CAAC;YAC9B,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC;gBACnB,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;gBACvB,OAAO;YACT,CAAC;YACD,MAAM,YAAY,CAAC,MAAM,EAAE,CAAC;YAC5B,GAAG,CAAC,OAAO,CAAC,2BAA2B,CAAC,mBAAmB,CAAC,kBAAkB,CAAC,OAAO,CAAC,CAAC,CAAC;QAC3F,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,GAAG,CAAC,IAAI,CAAC,2BAA2B,CAAC,WAAW,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;YAChH,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;QACzB,CAAC;IACH,CAAC,CAAC,CAAC;SACF,UAAU,CAAC,IAAI,OAAO,CAAC,QAAQ,CAAC;SAC9B,WAAW,CAAC,2BAA2B,CAAC,WAAW,CAAC,MAAM,CAAC,SAAS,CAAC;SACrE,MAAM,CAAC,KAAK,IAAI,EAAE;QACnB,IAAI,CAAC;YACH,MAAM,YAAY,CAAC,QAAQ,EAAE,CAAC;YAC9B,MAAM,KAAK,GAAG,YAAY,CAAC,UAAU,EAAE,CAAC;YACxC,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBACrB,MAAM,UAAU,GAAG,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,IAAI,IAAI,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,OAAO,EAAE,GAAG,IAAI,IAAI,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;gBAC9G,MAAM,QAAQ,GAAG,IAAI,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC,cAAc,CAAC,OAAO,CAAC,CAAC;gBACxE,GAAG,CAAC,IAAI,CAAC,2BAA2B,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC,CAAC;YAC7D,CAAC;QACH,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,GAAG,CAAC,IAAI,CAAC,2BAA2B,CAAC,WAAW,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;YAChH,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;QACzB,CAAC;IACH,CAAC,CAAC,CAAC,CAAC;AACN,CAAC","sourcesContent":["// SPDX-License-Identifier: MIT\nimport { mapaReversao } from '@analistas/corrections/mapa-reversao.js';\nimport { ExitCode, sair } from '@cli/helpers/exit-codes.js';\nimport { CliComandoReverterMensagens } from '@core/messages/cli/cli-comando-reverter-messages.js';\nimport { ICONES_DIAGNOSTICO, log, logAuto, logSistema } from '@core/messages/index.js';\nimport { Command } from 'commander';\n\nexport function registrarComandoReverter(program: Command): void {\n  program.command('reverter')\n    .description(CliComandoReverterMensagens.descricao)\n    .hook('preAction', async () => {\n    if (process.env.PROMETHEUS_TEST_FAST === '1') {\n      try {\n        await mapaReversao.carregar();\n      } catch (err) {\n        // Em modo de teste rápido, falhas ao carregar o mapa são ignoradas para evitar timeout.\n        // Porém, em outros ambientes, registramos um aviso para reduzir casos de promises 'swallowed'.\n        if (process.env.VITEST === '1') return;\n        log.aviso(CliComandoReverterMensagens.falhaCarregarMapaFast(err instanceof Error ? err.message : String(err)));\n      }\n    }\n  }).addCommand(new Command('listar').description('Lista todos os moves registrados no mapa de reversão').action(async () => {\n    try {\n      await mapaReversao.carregar();\n      const _lista = mapaReversao.listarMoves();\n    } catch (err) {\n      log.erro(CliComandoReverterMensagens.subcomandos.listar.erro(err instanceof Error ? err.message : String(err)));\n      sair(ExitCode.Failure);\n    }\n  }))\n  .addCommand(new Command('arquivo')\n    .description(CliComandoReverterMensagens.subcomandos.arquivo.descricao)\n    .argument('<arquivo>', CliComandoReverterMensagens.subcomandos.arquivo.argumento)\n    .action(async (arquivo: string) => {\n    try {\n      await mapaReversao.carregar();\n      if (!mapaReversao.podeReverterArquivo(arquivo)) {\n        logSistema.reversaoNenhumMove(arquivo);\n        sair(ExitCode.Failure);\n        return;\n      }\n      logSistema.reversaoRevertendo(arquivo);\n      const sucesso = await mapaReversao.reverterArquivo(arquivo);\n      if (sucesso) {\n        logSistema.reversaoSucesso(arquivo);\n      } else {\n        logSistema.reversaoFalha(arquivo);\n        sair(ExitCode.Failure);\n        return;\n      }\n    } catch (err) {\n      log.erro(CliComandoReverterMensagens.subcomandos.arquivo.erro(err instanceof Error ? err.message : String(err)));\n      sair(ExitCode.Failure);\n    }\n  }))\n  .addCommand(new Command('move')\n    .description(CliComandoReverterMensagens.subcomandos.move.descricao)\n    .argument('<id>', CliComandoReverterMensagens.subcomandos.move.argumento)\n    .action(async (id: string) => {\n    try {\n      await mapaReversao.carregar();\n      logAuto.mapaReversaoRevertendoMove(id);\n      const sucesso = await mapaReversao.reverterMove(id);\n      if (sucesso) {\n        logAuto.mapaReversaoMoveRevertido(id);\n      } else {\n        logAuto.mapaReversaoFalhaReverterMove(id);\n        sair(ExitCode.Failure);\n        return;\n      }\n    } catch (err) {\n      log.erro(CliComandoReverterMensagens.subcomandos.move.erro(err instanceof Error ? err.message : String(err)));\n      sair(ExitCode.Failure);\n    }\n  }))\n  .addCommand(new Command('limpar')\n    .description(CliComandoReverterMensagens.subcomandos.limpar.descricao)\n    .option('-f, --force', CliComandoReverterMensagens.opcoes.force)\n    .action(async (options: {\n    force?: boolean;\n  }) => {\n    try {\n      await mapaReversao.carregar();\n      if (!options.force) {\n        sair(ExitCode.Failure);\n        return;\n      }\n      await mapaReversao.limpar();\n      log.sucesso(CliComandoReverterMensagens.mapaLimpoComSucesso(ICONES_DIAGNOSTICO.sucesso));\n    } catch (err) {\n      log.erro(CliComandoReverterMensagens.subcomandos.limpar.erro(err instanceof Error ? err.message : String(err)));\n      sair(ExitCode.Failure);\n    }\n  }))\n  .addCommand(new Command('status')\n    .description(CliComandoReverterMensagens.subcomandos.status.descricao)\n    .action(async () => {\n    try {\n      await mapaReversao.carregar();\n      const moves = mapaReversao.obterMoves();\n      if (moves.length > 0) {\n        const ultimoMove = moves.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())[0];\n        const dataPtBr = new Date(ultimoMove.timestamp).toLocaleString('pt-BR');\n        log.info(CliComandoReverterMensagens.ultimoMove(dataPtBr));\n      }\n    } catch (err) {\n      log.erro(CliComandoReverterMensagens.subcomandos.status.erro(err instanceof Error ? err.message : String(err)));\n      sair(ExitCode.Failure);\n    }\n  }));\n}"]}