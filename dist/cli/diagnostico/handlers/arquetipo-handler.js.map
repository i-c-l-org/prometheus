{"version":3,"file":"arquetipo-handler.js","sourceRoot":"","sources":["../../../../src/cli/diagnostico/handlers/arquetipo-handler.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT-0\n/**\n * üèóÔ∏è Arquetipo Handler\n *\n * Gerencia detec√ß√£o e an√°lise de estrutura do projeto\n * - Detecta arquetipos com timeout\n * - Identifica padr√µes de projeto\n * - Salva arquetipos personalizados\n * - Formata resultados\n */\n\nimport { detectarArquetipos } from '@analistas/detectores/detector-arquetipos.js';\nimport { config } from '@core/config/config.js';\nimport { CliArquetipoHandlerMensagens } from '@core/messages/cli/cli-arquetipo-handler-messages.js';\nimport { MENSAGENS_ARQUETIPOS } from '@core/messages/core/diagnostico-messages.js';\nimport { log } from '@core/messages/index.js';\n\nimport type { ArquetipoOptions, ArquetipoResult, FileEntryWithAst } from '@';\n\n// Re-export para compatibilidade\nexport type { ArquetipoOptions, ArquetipoResult };\n\n/**\n * Timeout padr√£o para detec√ß√£o (em ms)\n */\nconst PADRAO_TEMPO_LIMITE_MS = process.env.VITEST ? 1000 : 30000;\n\n/**\n * Executa detec√ß√£o de arquetipos com timeout\n */\nexport async function executarDeteccaoArquetipos(entries: FileEntryWithAst[], baseDir: string, options: ArquetipoOptions): Promise<ArquetipoResult> {\n  // Se desabilitado, retorna resultado vazio\n  if (!options.enabled) {\n    return {\n      executado: false\n    };\n  }\n  try {\n    // Log de in√≠cio (se n√£o silencioso)\n    if (!options.silent) {\n      log.info(MENSAGENS_ARQUETIPOS.detectando);\n    }\n\n    // Preparar contexto\n    const ctx = {\n      arquivos: entries,\n      baseDir\n    };\n\n    // Executar detec√ß√£o com timeout\n    const timeoutMs = options.timeout || PADRAO_TEMPO_LIMITE_MS;\n    const resultado = await executarComTimeout(detectarArquetipos(ctx, baseDir), timeoutMs);\n\n    // Se timeout ou erro, retorna resultado parcial\n    if (!resultado) {\n      if (!options.silent) {\n        log.aviso(CliArquetipoHandlerMensagens.timeoutDeteccao);\n      }\n      return {\n        executado: true,\n        erro: 'timeout'\n      };\n    }\n\n    // Processar resultado\n    const arquetipos = resultado.candidatos || [];\n    const principal = arquetipos.length > 0 ? arquetipos[0] : undefined; // Log de resultado (se n√£o silencioso)\n    if (!options.silent && principal) {\n      log.info(MENSAGENS_ARQUETIPOS.identificado(principal.nome, principal.confidence));\n      if (arquetipos.length > 1) {\n        log.info(MENSAGENS_ARQUETIPOS.multiplos(arquetipos.length));\n      }\n    }\n\n    // Salvar se solicitado\n    let salvo = false;\n    if (options.salvar && resultado) {\n      salvo = await salvarArquetipo(resultado, baseDir, options.silent);\n    }\n    return {\n      executado: true,\n      arquetipos: arquetipos.map(a => ({\n        tipo: a.nome,\n        confianca: a.confidence,\n        caracteristicas: a.matchedRequired || []\n      })),\n      principal: principal ? {\n        tipo: principal.nome,\n        confianca: principal.confidence\n      } : undefined,\n      salvo\n    };\n  } catch (erro) {\n    const mensagem = erro instanceof Error ? erro.message : String(erro);\n    if (!options.silent) {\n      log.aviso(CliArquetipoHandlerMensagens.erroDeteccao(mensagem));\n    }\n\n    // Em DEV_MODE, log mais detalhado\n    if (config.DEV_MODE) {\n      console.error(CliArquetipoHandlerMensagens.devErroPrefixo, erro);\n    }\n    return {\n      executado: true,\n      erro: mensagem\n    };\n  }\n}\n\n/**\n * Executa fun√ß√£o com timeout\n */\nasync function executarComTimeout<T>(promise: Promise<T>, timeoutMs: number): Promise<T | undefined> {\n  try {\n    const timeoutPromise = new Promise<undefined>(resolve => setTimeout(() => resolve(undefined), timeoutMs));\n    return (await Promise.race([promise, timeoutPromise])) as T | undefined;\n  } catch {\n    return undefined;\n  }\n}\n\n/**\n * Salva arquetipo personalizado\n */\nasync function salvarArquetipo(resultado: Awaited<ReturnType<typeof detectarArquetipos>>, baseDir: string, silent?: boolean): Promise<boolean> {\n  try {\n    if (!silent) {\n      log.info(MENSAGENS_ARQUETIPOS.salvando);\n    }\n\n    // Importa√ß√£o din√¢mica para evitar depend√™ncias circulares\n    const fs = await import('node:fs/promises');\n    const path = await import('node:path');\n\n    // Preparar dados do arquetipo\n    const arquetipo = {\n      timestamp: new Date().toISOString(),\n      projeto: path.basename(baseDir),\n      arquetipos: resultado.candidatos,\n      baseline: resultado.baseline,\n      drift: resultado.drift\n    };\n\n    // Salvar em arquivo\n    const outputCaminho = path.join(baseDir, 'prometheus.repo.arquetipo.json');\n    await fs.writeFile(outputCaminho, JSON.stringify(arquetipo, null, 2), 'utf-8');\n    if (!silent) {\n      log.sucesso(MENSAGENS_ARQUETIPOS.salvo(outputCaminho));\n    }\n    return true;\n  } catch (erro) {\n    const mensagem = erro instanceof Error ? erro.message : String(erro);\n    if (!silent) {\n      log.aviso(CliArquetipoHandlerMensagens.falhaSalvar(mensagem));\n    }\n    return false;\n  }\n}\n\n/**\n * Formata resultado de arquetipos para JSON\n */\nexport function formatarArquetiposParaJson(result: ArquetipoResult): Record<string, unknown> {\n  if (!result.executado) {\n    return {\n      executado: false\n    };\n  }\n  if (result.erro) {\n    return {\n      executado: true,\n      erro: result.erro\n    };\n  }\n  return {\n    executado: true,\n    arquetipos: result.arquetipos || [],\n    principal: result.principal || null,\n    salvo: result.salvo || false\n  };\n}\n\n/**\n * Gera sugest√µes baseadas no arquetipo detectado\n */\nexport function gerarSugestoesArquetipo(result: ArquetipoResult): string[] {\n  const sugestoes: string[] = [];\n  if (!result.executado || !result.principal) {\n    return sugestoes;\n  }\n  const {\n    tipo,\n    confianca\n  } = result.principal;\n\n  // Sugest√µes baseadas no tipo de projeto\n  switch (tipo.toLowerCase()) {\n    case 'monorepo':\n      sugestoes.push('üí° Monorepo detectado: considere usar filtros por workspace');\n      sugestoes.push('üí° Use --include packages/* para analisar workspaces espec√≠ficos');\n      break;\n    case 'biblioteca':\n    case 'library':\n      sugestoes.push('üí° Biblioteca detectada: foque em exports p√∫blicos e documenta√ß√£o');\n      sugestoes.push('üí° Use --guardian para verificar API p√∫blica');\n      break;\n    case 'cli':\n    case 'cli-tool':\n      sugestoes.push('üí° CLI detectado: priorize testes de comandos e flags');\n      break;\n    case 'api':\n    case 'api-rest':\n    case 'api-server':\n      sugestoes.push('üí° API detectada: foque em endpoints e contratos');\n      sugestoes.push('üí° Considere testes de integra√ß√£o para rotas');\n      break;\n    case 'frontend':\n    case 'web-app':\n      sugestoes.push('üí° Frontend detectado: priorize componentes e state management');\n      break;\n  }\n\n  // Sugest√£o baseada em confian√ßa\n  if (confianca < 70) {\n    sugestoes.push('‚ö†Ô∏è  Confian√ßa baixa na detec√ß√£o: estrutura pode ser h√≠brida');\n    sugestoes.push('üí° Use --criar-arquetipo --salvar-arquetipo para personalizar');\n  }\n  return sugestoes;\n}"]}