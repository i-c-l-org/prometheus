{"version":3,"file":"filtros.js","sourceRoot":"","sources":["../../../src/cli/diagnostico/filtros.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n/**\n * ðŸŽ¯ Sistema de Filtros para DiagnÃ³stico\n *\n * Gerencia inclusÃ£o/exclusÃ£o de arquivos para anÃ¡lise\n * - Processa padrÃµes glob\n * - Expande diretÃ³rios automaticamente\n * - Gerencia node_modules e outros padrÃµes especiais\n * - Aplica precedÃªncia correta (CLI > config > defaults)\n */\n\nimport fs from 'node:fs';\nimport path from 'node:path';\n\nimport { config } from '@core/config/config.js';\nimport { mesclarConfigExcludes } from '@core/config/excludes-padrao.js';\n\nimport type { FiltrosProcessados, OpcoesProcessamentoFiltros, TipoLinguagemProjeto } from '@';\n\n  /* -------------------------- PROCESSAMENTO DE PADRÃ•ES -------------------------- */\n\n/**\n * Processa lista de padrÃµes achatada (vÃ­rgulas, espaÃ§os)\n *\n * @example\n * processPatternListAchatado(['src/**', 'tests, lib'])\n * // => ['src/**', 'tests', 'lib']\n */\nexport function processPatternListAchatado(raw: string[] | undefined): string[] {\n  if (!raw || raw.length === 0) return [];\n  return Array.from(new Set(raw.flatMap(r => r.split(/[\\s,]+/)).map(s => s.trim()).filter(Boolean)));\n}\n\n/**\n * Processa padrÃµes em grupos (cada elemento da lista Ã© um grupo)\n *\n * @example\n * processPatternGroups(['src/** tests/**', 'lib/**'])\n * // => [['src/**', 'tests/**'], ['lib/**']]\n */\nexport function processPatternGroups(raw: string[] | undefined): string[][] {\n  if (!raw || raw.length === 0) return [];\n  return raw.map(grupo => grupo.split(/[\\s,]+/).map(s => s.trim()).filter(Boolean)).filter(g => g.length > 0);\n}\n\n/**\n * Expande padrÃµes de inclusÃ£o (adiciona variantes recursivas)\n *\n * Para padrÃµes sem metacaracteres glob, adiciona:\n * - `pattern/**` (recursivo)\n * - `** /pattern/**` (se nÃ£o tiver barra)\n *\n * @example\n * expandIncludes(['src', 'lib/*.ts'])\n * // => ['src', 'src/**', '** /src/**', 'lib/*.ts']\n */\nexport function expandIncludes(list: string[]): string[] {\n  const META = /[\\\\*\\?\\{\\}\\[\\]]/; // metacaracteres glob\n  const out = new Set<string>();\n  for (const p of list) {\n    out.add(p);\n\n    // Se nÃ£o tem metacaracteres, Ã© um diretÃ³rio literal\n    if (!META.test(p)) {\n      // Remove barras terminais\n      const normalized = p.replace(/[\\\\\\/]+$/, '');\n\n      // Adiciona variante recursiva\n      out.add(`${normalized}/**`);\n\n      // Se Ã© nome simples (sem barra), adiciona busca em qualquer nÃ­vel\n      if (!p.includes('/') && !p.includes('\\\\')) {\n        out.add(`**/${normalized}/**`);\n      }\n    }\n  }\n  return Array.from(out);\n}\n\n  /* -------------------------- DETECÃ‡ÃƒO DE TIPO DE PROJETO -------------------------- */\n\n/**\n * Detecta tipo de projeto baseado em arquivos presentes\n */\nexport function detectarTipoProjeto(baseDir: string = process.cwd()): TipoLinguagemProjeto {\n  try {\n    // TypeScript\n    if (fs.existsSync(path.join(baseDir, 'tsconfig.json')) && fs.existsSync(path.join(baseDir, 'package.json'))) {\n      return 'typescript';\n    }\n\n    // Node.js\n    if (fs.existsSync(path.join(baseDir, 'package.json'))) {\n      return 'nodejs';\n    }\n\n    // Python\n    if (fs.existsSync(path.join(baseDir, 'requirements.txt')) || fs.existsSync(path.join(baseDir, 'pyproject.toml')) || fs.existsSync(path.join(baseDir, 'setup.py'))) {\n      return 'python';\n    }\n\n    // Java\n    if (fs.existsSync(path.join(baseDir, 'pom.xml')) || fs.existsSync(path.join(baseDir, 'build.gradle')) || fs.existsSync(path.join(baseDir, 'build.gradle.kts'))) {\n      return 'java';\n    }\n\n    // .NET\n    const files = fs.readdirSync(baseDir);\n    if (files.some(f => f.endsWith('.csproj')) || files.some(f => f.endsWith('.sln'))) {\n      return 'dotnet';\n    }\n    return 'generico';\n  } catch {\n    return 'generico';\n  }\n}\n\n  /* -------------------------- PADRÃ•ES DE EXCLUSÃƒO -------------------------- */\n\n/**\n * ObtÃ©m padrÃµes de exclusÃ£o padrÃ£o baseados em configuraÃ§Ã£o e tipo de projeto\n */\nexport function getDefaultExcludes(tipoProjeto?: TipoLinguagemProjeto): string[] {\n  // Tenta obter do prometheus.config.json\n  const configIncluirExcluir = config.INCLUDE_EXCLUDE_RULES;\n  if (configIncluirExcluir?.globalExcludeGlob) {\n    if (Array.isArray(configIncluirExcluir.globalExcludeGlob) && configIncluirExcluir.globalExcludeGlob.length > 0) {\n      return Array.from(new Set(configIncluirExcluir.globalExcludeGlob));\n    }\n  }\n\n  // Fallback: usa padrÃµes do sistema baseado no tipo de projeto\n  const tipo = tipoProjeto || detectarTipoProjeto();\n  return mesclarConfigExcludes(null, tipo);\n}\n\n  /* -------------------------- CONFIGURAÃ‡ÃƒO DE FILTROS -------------------------- */\n\n/**\n * Processa e aplica filtros CLI\n *\n * PrecedÃªncia:\n * 1. CLI --exclude (mÃ¡xima)\n * 2. prometheus.config.json\n * 3. PadrÃµes do sistema (fallback)\n */\nexport function processarFiltros(opcoes: OpcoesProcessamentoFiltros): FiltrosProcessados {\n  const tipoProjeto = detectarTipoProjeto();\n\n  // Processar includes\n  const includeGroups = processPatternGroups(opcoes.include);\n  const includeFlat = includeGroups.flat();\n  const includeExpanded = expandIncludes(includeFlat);\n\n  // Processar excludes\n  const excludeFlat = processPatternListAchatado(opcoes.exclude);\n\n  // Determinar padrÃµes de exclusÃ£o finais\n  let excludePadroes: string[];\n  if (excludeFlat.length > 0) {\n    // CLI tem precedÃªncia\n    excludePadroes = excludeFlat;\n  } else {\n    // Usar defaults do config ou sistema\n    excludePadroes = getDefaultExcludes(tipoProjeto);\n  }\n\n  // Verificar se node_modules deve ser incluÃ­do\n  let incluiNodeModules = opcoes.forceIncludeNodeModules || false;\n  if (includeFlat.some(p => /node_modules/.test(p))) {\n    incluiNodeModules = true;\n  }\n\n  // Remover node_modules dos excludes se explicitamente incluÃ­do\n  if (incluiNodeModules) {\n    excludePadroes = excludePadroes.filter(p => !/node_modules/.test(p));\n  }\n\n  // Processar flag de testes\n  if (opcoes.forceIncludeTests && !includeFlat.some(p => /tests?/.test(p))) {\n    includeExpanded.push('tests/**', 'test/**', '**/*.test.*', '**/*.spec.*');\n  }\n  return {\n    includeGroups,\n    includeFlat: includeExpanded,\n    excludePadroes,\n    incluiNodeModules,\n    tipoProjeto\n  };\n}\n\n/**\n * Aplica filtros processados ao config global\n */\nexport function aplicarFiltrosAoConfig(filtros: FiltrosProcessados): void {\n  // Configurar includes\n  if (filtros.includeFlat.length > 0) {\n    config.CLI_INCLUDE_GROUPS = filtros.includeGroups;\n    config.CLI_INCLUDE_PATTERNS = filtros.includeFlat;\n  } else {\n    config.CLI_INCLUDE_GROUPS = [];\n    config.CLI_INCLUDE_PATTERNS = [];\n  }\n\n  // Configurar excludes\n  config.CLI_EXCLUDE_PATTERNS = filtros.excludePadroes;\n}\n\n/**\n * API simplificada: processa e aplica filtros em uma Ãºnica chamada\n */\nexport function configurarFiltros(opcoes: OpcoesProcessamentoFiltros): FiltrosProcessados {\n  const filtros = processarFiltros(opcoes);\n  aplicarFiltrosAoConfig(filtros);\n  return filtros;\n}\n"]}