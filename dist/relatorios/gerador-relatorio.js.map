{"version":3,"file":"gerador-relatorio.js","sourceRoot":"","sources":["../../src/relatorios/gerador-relatorio.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n// Gerador de relatórios: Markdown e JSON\nimport { gerarHeaderRelatorio, gerarSecaoGuardian, gerarTabelaOcorrencias, gerarTabelaResumoTipos, RelatorioMensagens } from '@core/messages/index.js';\n\nimport type { GeradorMarkdownOptions, Ocorrencia, ResultadoInquisicaoCompleto } from '@';\n\nexport async function gerarRelatorioMarkdown(resultado: ResultadoInquisicaoCompleto, outputCaminho: string, modoBrief = false, options?: GeradorMarkdownOptions): Promise<void> {\n  const {\n    totalArquivos = 0,\n    ocorrencias = [],\n    guardian,\n    timestamp = Date.now(),\n    duracaoMs = 0\n  } = (resultado || {}) as ResultadoInquisicaoCompleto;\n  const dataISO = new Date(timestamp).toISOString();\n\n  // Se modo brief, usar filtro inteligente\n  if (modoBrief) {\n    const {\n      processarRelatorioResumo,\n      gerarRelatorioMarkdownResumo\n    } = await import('@relatorios/filtro-inteligente.js');\n    const relatorioResumo = processarRelatorioResumo(ocorrencias);\n    await gerarRelatorioMarkdownResumo(relatorioResumo, outputCaminho);\n    return;\n  }\n  const ocorrenciasOrdenadas: Ocorrencia[] = [...ocorrencias].sort((a, b) => {\n    const ra = String(a.relPath ?? '');\n    const rb = String(b.relPath ?? '');\n    const cmp = ra.localeCompare(rb);\n    if (cmp !== 0) return cmp;\n    const la = typeof a.linha === 'number' ? a.linha : Number.MAX_SAFE_INTEGER;\n    const lb = typeof b.linha === 'number' ? b.linha : Number.MAX_SAFE_INTEGER;\n    return la - lb;\n  });\n\n  // Extrair dados do Guardian\n  const guardianData = guardian && typeof guardian === 'object' ? {\n    status: 'status' in guardian ? String((guardian as Record<string, unknown>).status) : 'não executada',\n    timestamp: 'timestamp' in guardian ? String((guardian as Record<string, unknown>).timestamp) : '—',\n    totalArquivos: 'totalArquivos' in guardian ? String((guardian as Record<string, unknown>).totalArquivos) : '—'\n  } : {\n    status: 'não executada',\n    timestamp: '—',\n    totalArquivos: '—'\n  };\n\n  // Montar o header usando template centralizado\n  const lines: string[] = [];\n  lines.push(...gerarHeaderRelatorio({\n    dataISO,\n    duracao: duracaoMs,\n    totalArquivos,\n    totalOcorrencias: ocorrencias.length\n  }));\n\n  // Se houver manifest, adiciona link e sumário rápido\n  if (options && options.manifestFile && options.relatoriosDir) {\n    const relPath = options.manifestFile;\n    lines.push(`**${RelatorioMensagens.principal.secoes.metadados.arquivoManifest}:** \\`${relPath}\\`  `);\n    lines.push('');\n    lines.push(`> ${RelatorioMensagens.principal.secoes.metadados.notaManifest}`);\n    lines.push('');\n    lines.push('---');\n    lines.push('');\n  }\n\n  // Seção Guardian usando template\n  lines.push(...gerarSecaoGuardian(guardianData));\n\n  // Sumário das ocorrências por tipo usando template\n  const tiposContagem: Record<string, number> = {};\n  for (const ocorrencia of ocorrencias) {\n    const tipo = ocorrencia && (ocorrencia as Ocorrencia).tipo || 'desconhecido';\n    tiposContagem[String(tipo)] = (tiposContagem[String(tipo)] || 0) + 1;\n  }\n  lines.push(...gerarTabelaResumoTipos(tiposContagem, 10));\n\n  // Tabela com ocorrências usando template\n  lines.push('---');\n  lines.push('');\n  lines.push(`## ${RelatorioMensagens.principal.secoes.ocorrencias.titulo} (amostra)`);\n  lines.push('');\n  const AMOSTRA_MAX = 2000;\n  const sample = ocorrenciasOrdenadas.slice(0, AMOSTRA_MAX);\n  lines.push(...gerarTabelaOcorrencias(sample));\n  if (ocorrenciasOrdenadas.length > AMOSTRA_MAX) {\n    lines.push('');\n    lines.push(`> Mostrando apenas ${AMOSTRA_MAX} ocorrências. Para ver todas, consulte os shards listados no manifest.`);\n  }\n  const {\n    salvarEstado\n  } = await import('@shared/persistence/persistencia.js');\n  await salvarEstado(outputCaminho, lines.join('\\n'));\n}\nexport async function gerarRelatorioJson(resultado: ResultadoInquisicaoCompleto, outputCaminho: string): Promise<void> {\n  // Importar sistema de versionamento\n  const {\n    criarRelatorioComVersao\n  } = await import('@core/schema/version.js');\n\n  // Criar relatório versionado (mantemos metadados, mas salvamos os dados brutos para compatibilidade)\n  const relatorioVersionado = criarRelatorioComVersao(resultado, undefined, 'Relatório completo de diagnóstico do Prometheus');\n  const {\n    salvarEstado\n  } = await import('@shared/persistence/persistencia.js');\n  await salvarEstado(outputCaminho, relatorioVersionado.dados ?? resultado);\n}"]}